<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neko U - ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="../css/navigation.css">
    
    <style>
        :root {
            --primary-color: #87CEEB;
            --secondary-color: #FFB6C1;
            --accent-color: #E6E6FA;
            --text-dark: #4A4A4A;
            --bg-light: #F8F9FA;
            --success-color: #98FB98;
            --warning-color: #FFE4B5;
        }

        body {
            background: linear-gradient(135deg, var(--bg-light) 0%, var(--accent-color) 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .navbar {
            background: rgba(255, 255, 255, 0.95) !important;
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 1rem 0;
            position: relative;
            overflow: visible;
        }

        .navbar .container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            position: relative;
        }

        .navbar-nav {
            flex-direction: row !important;
        }

        .navbar-brand {
            font-weight: 700;
            color: var(--primary-color) !important;
            font-size: 1.5rem;
            transition: transform 0.3s ease;
        }
        
        .navbar-brand:hover {
            transform: scale(1.05);
        }

        /* User Dropdown Styles */
        .nav-item.dropdown {
            position: relative;
        }

        .navbar-nav {
            position: relative;
        }

        .nav-link.dropdown-toggle {
            display: flex;
            align-items: center;
            padding: 8px 16px;
            background: rgba(135, 206, 235, 0.1);
            border-radius: 25px;
            color: var(--text-dark) !important;
            text-decoration: none;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .nav-link.dropdown-toggle:hover {
            background: rgba(135, 206, 235, 0.2);
            border-color: var(--primary-color);
            transform: translateY(-2px);
        }

        .nav-link.dropdown-toggle i {
            font-size: 1.2rem;
            margin-right: 8px;
        }

        .dropdown-menu {
            border: none;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            border-radius: 15px;
            padding: 10px 0;
            margin-top: 10px;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            min-width: 200px;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            pointer-events: none;
            position: absolute !important;
            z-index: 1050;
        }

        .dropdown-menu.show {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }

        .dropdown-item {
            padding: 12px 20px;
            color: var(--text-dark);
            transition: all 0.3s ease;
            border-radius: 10px;
            margin: 2px 10px;
        }

        .dropdown-item:hover {
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            color: white;
            transform: translateX(5px);
        }

        .dropdown-item i {
            margin-right: 10px;
            width: 16px;
            text-align: center;
        }

        .dropdown-divider {
            margin: 8px 20px;
            border-color: var(--accent-color);
        }

        /* Animation for dropdown arrow */
        .dropdown-toggle::after {
            transition: transform 0.3s ease;
        }

        .dropdown-toggle[aria-expanded="true"]::after {
            transform: rotate(180deg);
        }

        .main-container {
            padding: 20px 0;
        }

        .welcome-card {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .feature-card {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: none;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            cursor: pointer;
        }

        .feature-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 15px 35px rgba(0,0,0,0.15);
        }

        .feature-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            display: block;
            transition: transform 0.3s ease;
        }
        
        .feature-card:hover .feature-icon {
            transform: scale(1.2) rotate(5deg);
        }

        .feature-title {
            font-weight: 600;
            font-size: 1.2rem;
            margin-bottom: 10px;
            color: var(--text-dark);
        }

        .feature-description {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 15px;
        }

        .btn-feature {
            background: var(--primary-color);
            border: none;
            color: white;
            border-radius: 10px;
            padding: 8px 20px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-feature:hover {
            background: var(--secondary-color);
            color: white;
            transform: translateY(-2px);
        }

        .stats-card {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }

        .stats-number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 5px;
        }

        .stats-label {
            color: var(--text-dark);
            font-size: 0.9rem;
        }

        .partner-info {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            border: 2px solid #e3f2fd;
        }

        .partner-status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .partner-status.online {
            background: var(--success-color);
            color: #2d5f3f;
        }

        .partner-status.offline {
            background: #f8f9fa;
            color: #666;
        }
        
        .spinning {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .partner-code-display {
            font-family: 'Courier New', monospace;
            letter-spacing: 2px;
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 12px;
            text-align: center;
        }

        .input-group .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(135, 206, 235, 0.25);
        }

        #pairingSection .alert {
            border: none;
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
            color: #1976d2;
        }

        .greeting-text {
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .loading-placeholder {
            animation: loading-pulse 1.5s ease-in-out infinite;
            color: #ccc;
        }

        @keyframes loading-pulse {
            0%, 100% { opacity: 0.4; }
            50% { opacity: 1; }
        }

        .stats-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .stats-number {
            transition: color 0.3s ease;
        }

        .stats-card:hover .stats-number {
            color: var(--secondary-color);
        }

        .activity-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-section {
            margin-bottom: 15px;
        }

        .activity-section:last-child {
            margin-bottom: 0;
        }

        .recent-activity {
            max-height: 300px;
            overflow-y: auto;
        }

        .greeting-text {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .morning-message {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            font-style: italic;
        }

        /* Partner Card Styles */
        .partner-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border: none;
            transition: all 0.3s ease;
        }

        .partner-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
        }

        .partner-code-card {
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 2px solid var(--primary-color);
            transition: all 0.3s ease;
        }

        .partner-code-card:hover {
            transform: scale(1.02);
            box-shadow: 0 5px 20px rgba(135, 206, 235, 0.3);
        }

        .partner-code-display {
            font-family: 'Courier New', monospace;
            letter-spacing: 3px;
            background: rgba(255, 255, 255, 0.8);
            border: 2px dashed var(--primary-color);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-color);
            transition: all 0.3s ease;
        }

        .partner-code-display:hover {
            background: rgba(255, 255, 255, 1);
            border-style: solid;
        }

        .copy-btn {
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            border: none;
            border-radius: 10px;
            padding: 8px 16px;
            color: white;
            transition: all 0.3s ease;
        }

        .copy-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            color: white;
        }

        .partner-info-card {
            background: linear-gradient(135deg, rgba(255, 182, 193, 0.1) 0%, rgba(135, 206, 235, 0.1) 100%);
            border-radius: 15px;
            padding: 20px;
            border: 2px solid var(--secondary-color);
            position: relative;
            overflow: hidden;
        }

        .partner-info-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transform: rotate(45deg);
            transition: all 0.6s ease;
            opacity: 0;
        }

        .partner-info-card:hover::before {
            animation: shimmer 1.5s ease-in-out;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); opacity: 0; }
        }

        .partner-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            color: white;
            margin-right: 20px;
            transition: all 0.3s ease;
            position: relative;
        }

        .partner-avatar:hover {
            transform: scale(1.1) rotate(5deg);
        }

        .partner-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .partner-status.online {
            background: linear-gradient(45deg, #4CAF50, #8BC34A);
            color: white;
            animation: pulse 2s infinite;
        }

        .partner-status.online .bi-circle-fill {
            color: #90EE90;
            animation: blink 1.5s infinite;
        }

        .partner-status.offline {
            background: #f5f5f5;
            color: #666;
        }

        .partner-status.offline .bi-circle-fill {
            color: #ccc;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(76, 175, 80, 0); }
            100% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0); }
        }

        .unpair-btn {
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
            border: none;
            border-radius: 25px;
            padding: 8px 16px;
            color: white;
            transition: all 0.3s ease;
        }

        .unpair-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
            color: white;
        }

        .pairing-card {
            background: linear-gradient(135deg, #fff3e0 0%, #e8f5e8 100%);
            border-radius: 15px;
            padding: 20px;
            border: 2px solid #ffb74d;
        }

        .pairing-input {
            border: 2px solid var(--accent-color);
            border-radius: 10px;
            padding: 12px 16px;
            font-size: 1.1rem;
            text-align: center;
            letter-spacing: 2px;
            text-transform: uppercase;
            transition: all 0.3s ease;
        }

        .pairing-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(135, 206, 235, 0.25);
            transform: scale(1.02);
        }

        .pair-btn {
            background: linear-gradient(45deg, #4CAF50, #8BC34A);
            border: none;
            border-radius: 10px;
            padding: 12px 24px;
            color: white;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .pair-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
            color: white;
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ff4757;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-light">
        <div class="container">
            <a class="navbar-brand" href="dashboard.html">
                <i class="bi bi-heart-fill text-danger"></i> Neko U
            </a>
            
            <div class="navbar-nav ms-auto">
                <div class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" 
                       data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-person-circle"></i>
                        <span id="userName">Loading...</span>
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                        <li><a class="dropdown-item" href="settings.html">
                            <i class="bi bi-person-gear"></i> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item text-danger" href="#" onclick="logout()">
                            <i class="bi bi-box-arrow-right"></i> ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
                        </a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container main-container">
        <!-- Welcome Section -->
        <div class="welcome-card">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <div class="greeting-text">
                        <span id="greetingEmoji">üëã</span>
                        <span id="greetingTime">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ</span>, 
                        <span id="userName">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span>
                    </div>
                    <p class="mb-0 opacity-90">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà <span id="currentDate"></span></p>
                </div>
                <div class="text-end">
                    <div class="partner-info mb-2">
                        <span class="text-light opacity-75">‡∏Ñ‡∏π‡πà‡∏£‡∏±‡∏Å: </span>
                        <span id="partnerNameHeader">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ</span>
                    </div>
                    <span class="partner-status" id="partnerStatusHeader">
                        <i class="bi bi-circle-fill me-1"></i>
                        ‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå
                    </span>
                    <div class="mt-2">
                        <button class="btn btn-sm btn-outline-light" onclick="dashboardFunctions.refreshStats()" title="‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥">
                            <i class="bi bi-arrow-clockwise"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-light ms-1" onclick="dashboardFunctions.refreshDashboard()" title="‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î">
                            <i class="bi bi-arrow-repeat"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="morning-message" id="morningMessage" style="display: none;">
                <i class="bi bi-sunrise"></i>
                <span id="dailyGreeting"></span>
            </div>
        </div>

        <!-- Partner Section -->
        <div class="row mb-4">
            <div class="col-12">
                <!-- My Partner Code Card -->
                <div class="partner-card">
                    <div class="partner-code-card">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="flex-grow-1">
                                <h6 class="mb-2 text-muted">
                                    <i class="bi bi-qr-code me-2"></i>‡∏£‡∏´‡∏±‡∏™‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
                                </h6>
                                <div class="partner-code-display" id="myPartnerCode">------</div>

                                
                                <small class="text-muted">
                                    <i class="bi bi-info-circle me-1"></i>
                                    ‡πÅ‡∏ä‡∏£‡πå‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏µ‡πâ‡∏Å‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏Å‡∏±‡∏ô
                                </small>
                            </div>
                            <div class="ms-3">
                                <button class="copy-btn" onclick="copyPartnerCode()" title="‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™">
                                    <i class="bi bi-clipboard me-2"></i>‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Partner Info Card (‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß) -->
                <div class="partner-card" id="partnerInfoCard" style="display: none;">
                    <div class="partner-info-card">
                        <div class="d-flex align-items-center justify-content-between">
                            <div class="d-flex align-items-center flex-grow-1">
                                <div class="partner-avatar">
                                    <i class="bi bi-person-heart"></i>
                                </div>
                                <div class="flex-grow-1">
                                    <div class="d-flex align-items-center mb-2">
                                        <h5 class="mb-0 me-3" id="partnerName">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏π‡πà‡∏£‡∏±‡∏Å</h5>
                                        <span class="partner-status offline" id="partnerStatus">
                                            <i class="bi bi-circle-fill me-1" style="font-size: 0.6rem;"></i>
                                            ‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå
                                        </span>
                                    </div>
                                    <div class="mb-2" id="partnerNickname">
                                        <i class="bi bi-heart text-danger me-1"></i>
                                        <span class="text-muted">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô: </span>
                                        <span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span>
                                    </div>
                                    <div class="text-muted small">
                                        <i class="bi bi-calendar-heart me-1"></i>
                                        ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏°‡∏∑‡πà‡∏≠ <span id="partnerSince">-</span>
                                    </div>
                                    <div class="mt-2">
                                        <small class="text-success">
                                            <i class="bi bi-check-circle me-1"></i>
                                            ‡∏Ñ‡∏π‡πà‡∏£‡∏±‡∏Å‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏´‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡πà‡∏ô‡∏Å‡∏±‡∏ô
                                        </small>
                                    </div>
                                </div>
                            </div>
                            <div class="text-end">
                                <button class="unpair-btn" onclick="confirmUnpairPartner()" title="‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà">
                                    <i class="bi bi-heart-break me-2"></i>‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Pairing Card (‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà) -->
                <div class="partner-card" id="pairingCard">
                    <div class="pairing-card">
                        <div class="text-center mb-3">
                            <i class="bi bi-heart text-warning" style="font-size: 3rem;"></i>
                            <h5 class="mt-2 mb-3">‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏Å‡∏±‡∏ö‡∏Ñ‡∏ô‡∏£‡∏±‡∏Å</h5>
                            <p class="text-muted mb-4">
                                ‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏π‡πà‡∏£‡∏±‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ô
                            </p>
                        </div>
                        
                        <div id="pairingAlert"></div>
                        
                        <form id="pairingForm" class="text-center">
                            <div class="mb-3">
                                <input type="text" 
                                       class="form-control pairing-input" 
                                       id="partnerCodeInput" 
                                       placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏π‡πà‡∏£‡∏±‡∏Å"
                                       maxlength="8"
                                       required>
                            </div>
                            <button type="submit" class="pair-btn">
                                <i class="bi bi-heart-arrow me-2"></i>‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡πÄ‡∏•‡∏¢
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stats -->
        <div class="row mb-4">
            <div class="col-md-2 col-6 mb-3">
                <div class="stats-card">
                    <div class="stats-number" id="diaryCount">
                        <span class="loading-placeholder">...</span>
                    </div>
                    <div class="stats-label">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡∏≠‡∏≤‡∏£‡∏µ‡πà</div>
                </div>
            </div>
            <div class="col-md-2 col-6 mb-3">
                <div class="stats-card">
                    <div class="stats-number" id="todoCount">
                        <span class="loading-placeholder">...</span>
                    </div>
                    <div class="stats-label">‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠</div>
                </div>
            </div>
            <div class="col-md-2 col-6 mb-3">
                <div class="stats-card">
                    <div class="stats-number" id="chatCount">
                        <span class="loading-placeholder">...</span>
                    </div>
                    <div class="stats-label">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á</div>
                </div>
            </div>
            <div class="col-md-2 col-6 mb-3">
                <div class="stats-card">
                    <div class="stats-number" id="mathAccuracy">
                        <span class="loading-placeholder">...</span>
                    </div>
                    <div class="stats-label">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡∏Ñ‡∏ì‡∏¥‡∏ï</div>
                </div>
            </div>
            <div class="col-md-2 col-6 mb-3">
                <div class="stats-card">
                    <div class="stats-number" id="pomodoroSessions">
                        <span class="loading-placeholder">...</span>
                    </div>
                    <div class="stats-label">‡πÄ‡∏ã‡∏™‡∏ä‡∏±‡∏ô Pomodoro</div>
                </div>
            </div>
            <div class="col-md-2 col-6 mb-3">
                <div class="stats-card">
                    <div class="stats-number" id="daysTogether">
                        <span class="loading-placeholder">...</span>
                    </div>
                    <div class="stats-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</div>
                </div>
            </div>
        </div>

        <!-- Additional Stats Row -->
        <div class="row mb-4">
            <div class="col-md-3 col-6 mb-3">
                <div class="stats-card">
                    <div class="stats-number" id="totalMathProblems">
                        <span class="loading-placeholder">...</span>
                    </div>
                    <div class="stats-label">‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏ó‡∏µ‡πà‡∏ó‡∏≥</div>
                </div>
            </div>
            <div class="col-md-3 col-6 mb-3">
                <div class="stats-card">
                    <div class="stats-number" id="pomodoroHours">
                        <span class="loading-placeholder">...</span>
                    </div>
                    <div class="stats-label">‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</div>
                </div>
            </div>
            <div class="col-md-3 col-6 mb-3">
                <div class="stats-card">
                    <div class="stats-number" id="completedTodos">
                        <span class="loading-placeholder">...</span>
                    </div>
                    <div class="stats-label">‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</div>
                </div>
            </div>
            <div class="col-md-3 col-6 mb-3">
                <div class="stats-card">
                    <div class="stats-number" id="partnerChatCount">
                        <span class="loading-placeholder">...</span>
                    </div>
                    <div class="stats-label">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏Å‡∏Ñ‡∏π‡πà‡∏£‡∏±‡∏Å</div>
                </div>
            </div>
        </div>

        <!-- Recent Activity Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card" style="background: rgba(255, 255, 255, 0.9); border-radius: 15px; border: none; box-shadow: 0 5px 15px rgba(0,0,0,0.08);">
                    <div class="card-body">
                        <div id="recentActivityContainer">
                            <div class="text-center text-muted">
                                <div class="loading-placeholder">
                                    <i class="bi bi-hourglass-split spinning"></i>
                                    ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Features Grid -->
        <div class="row">
            <!-- Diary -->
            <div class="col-lg-4 col-md-6 mb-4">
                <div class="feature-card text-center">
                    <div class="feature-icon">üìñ</div>
                    <div class="feature-title">‡πÑ‡∏î‡∏≠‡∏≤‡∏£‡∏µ‡πà‡∏Ñ‡∏π‡πà‡∏£‡∏±‡∏Å</div>
                    <div class="feature-description">
                        ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡πÅ‡∏ö‡πà‡∏á‡∏õ‡∏±‡∏ô‡∏Å‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏£‡∏±‡∏Å
                    </div>
                    <button class="btn btn-feature" onclick="goToDiary()">
                        ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÑ‡∏î‡∏≠‡∏≤‡∏£‡∏µ‡πà
                    </button>
                </div>
            </div>

            <!-- Chat -->
            <div class="col-lg-4 col-md-6 mb-4">
                <div class="feature-card text-center position-relative">
                    <div class="feature-icon">üí¨</div>
                    <div class="feature-title">‡πÅ‡∏ä‡∏ï‡∏Ñ‡∏π‡πà‡∏£‡∏±‡∏Å</div>
                    <div class="feature-description">
                        ‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ô‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å
                    </div>
                    <button class="btn btn-feature" onclick="goToChat()">
                        ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏ä‡∏ï
                    </button>
                    <span class="notification-badge" id="chatNotification" style="display: none;">0</span>
                </div>
            </div>

            <!-- Todo -->
            <div class="col-lg-4 col-md-6 mb-4">
                <div class="feature-card text-center">
                    <div class="feature-icon">‚úÖ</div>
                    <div class="feature-title">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥</div>
                    <div class="feature-description">
                        ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ô
                    </div>
                    <button class="btn btn-feature" onclick="goToTodo()">
                        ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô
                    </button>
                </div>
            </div>

            <!-- Neko Chat -->
            <div class="col-lg-4 col-md-6 mb-4">
                <div class="feature-card text-center">
                    <div class="feature-icon">üê±</div>
                    <div class="feature-title">‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ö‡πÄ‡∏ô‡πÇ‡∏Å‡∏∞</div>
                    <div class="feature-description">
                        AI Assistant ‡∏ô‡πà‡∏≤‡∏£‡∏±‡∏Å‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤
                    </div>
                    <button class="btn btn-feature" onclick="goToNekoChat()">
                        ‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ö‡πÄ‡∏ô‡πÇ‡∏Å‡∏∞
                    </button>
                </div>
            </div>

            <!-- Math Problems -->
            <div class="col-lg-4 col-md-6 mb-4">
                <div class="feature-card text-center">
                    <div class="feature-icon">üßÆ</div>
                    <div class="feature-title">‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå</div>
                    <div class="feature-description">
                        ‡∏ù‡∏∂‡∏Å‡∏™‡∏°‡∏≠‡∏á‡∏î‡πâ‡∏ß‡∏¢‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏´‡∏•‡∏≤‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏∞‡∏î‡∏±‡∏ö
                    </div>
                    <button class="btn btn-feature" onclick="goToMath()">
                        ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ù‡∏∂‡∏Å‡∏™‡∏°‡∏≠‡∏á
                    </button>
                </div>
            </div>

            <!-- Pomodoro -->
            <div class="col-lg-4 col-md-6 mb-4">
                <div class="feature-card text-center">
                    <div class="feature-icon">‚è∞</div>
                    <div class="feature-title">Pomodoro Timer</div>
                    <div class="feature-description">
                        ‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û
                    </div>
                    <button class="btn btn-feature" onclick="goToPomodoro()">
                        ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Simple API Helper - Inline Version (localStorage)
        const SIMPLE_API = {
            baseURL: 'https://little-secret-api.vercel.app',

            // Get authentication token from localStorage
            getToken() {
                try {
                    const token = localStorage.getItem('nekouToken');
                    
                    if (!token || token === 'undefined' || token === 'null' || token === '') {
                        console.log('üîë No valid token found in localStorage');
                        return null;
                    }
                    
                    console.log('üîë Valid token found:', token.substring(0, 20) + '...');
                    return token;
                } catch (error) {
                    console.error('‚ùå Error reading token from localStorage:', error);
                    return null;
                }
            },

            // Set authentication token in localStorage
            setToken(token) {
                try {
                    if (token) {
                        localStorage.setItem('nekouToken', token);
                        console.log('üîë Token saved to localStorage');
                    } else {
                        localStorage.removeItem('nekouToken');
                        console.log('üîë Token removed from localStorage');
                    }
                } catch (error) {
                    console.error('‚ùå Error saving token to localStorage:', error);
                }
            },

            // Get current user from localStorage
            getCurrentUser() {
                try {
                    const userStr = localStorage.getItem('nekouUser');
                    
                    if (!userStr || userStr === 'undefined' || userStr === 'null' || userStr === '') {
                        console.log('‚ùå No valid user data in localStorage');
                        return null;
                    }
                    
                    const userData = JSON.parse(userStr);
                    console.log('‚úÖ User data loaded from localStorage:', userData);
                    return userData;
                } catch (error) {
                    console.error('‚ùå Failed to parse user data from localStorage:', error);
                    console.log('Raw userStr:', localStorage.getItem('nekouUser'));
                    return null;
                }
            },

            // Set current user data in localStorage
            setCurrentUser(userData) {
                try {
                    if (userData) {
                        localStorage.setItem('nekouUser', JSON.stringify(userData));
                        console.log('‚úÖ User data saved to localStorage:', userData);
                    } else {
                        localStorage.removeItem('nekouUser');
                        console.log('üóëÔ∏è User data removed from localStorage');
                    }
                } catch (error) {
                    console.error('‚ùå Error saving user data to localStorage:', error);
                }
            },

            // Clear corrupted localStorage data
            clearCorruptedData() {
                console.log('üßπ Clearing corrupted localStorage data...');
                try {
                    localStorage.removeItem('nekouToken');
                    localStorage.removeItem('nekouUser');
                    console.log('üßπ LocalStorage data cleared successfully');
                } catch (error) {
                    console.error('‚ùå Error clearing localStorage:', error);
                }
            },

            // Helper function to get data (backward compatibility)
            getCookie(name) {
                console.log(`‚ö†Ô∏è getCookie() is deprecated, use localStorage instead for: ${name}`);
                
                // Try localStorage first
                if (name === 'nekouToken') {
                    return this.getToken();
                } else if (name === 'nekouUser') {
                    const user = this.getCurrentUser();
                    return user ? JSON.stringify(user) : null;
                }
                
                // Fallback to actual cookie for backward compatibility
                const nameEQ = name + "=";
                const ca = document.cookie.split(';');
                for (let i = 0; i < ca.length; i++) {
                    let c = ca[i];
                    while (c.charAt(0) === ' ') c = c.substring(1, c.length);
                    if (c.indexOf(nameEQ) === 0) {
                        const value = c.substring(nameEQ.length, c.length);
                        console.log(`üç™ Found in cookie: ${name} = ${value}`);
                        return decodeURIComponent(value);
                    }
                }
                console.log(`üç™ Not found in cookie: ${name}`);
                return null;
            },

            // Helper function to set data (backward compatibility)
            setCookie(name, value, hours = 24) {
                console.log(`‚ö†Ô∏è setCookie() is deprecated, use localStorage instead for: ${name}`);
                
                // Use localStorage instead
                if (name === 'nekouToken') {
                    this.setToken(value);
                } else if (name === 'nekouUser') {
                    try {
                        const userData = typeof value === 'string' ? JSON.parse(value) : value;
                        this.setCurrentUser(userData);
                    } catch (error) {
                        console.error('‚ùå Error parsing user data for localStorage:', error);
                    }
                } else {
                    // Fallback to actual cookie for other values
                    const expires = new Date();
                    expires.setTime(expires.getTime() + (hours * 60 * 60 * 1000));
                    const cookieString = `${name}=${encodeURIComponent(value)};expires=${expires.toUTCString()};path=/;SameSite=Lax`;
                    document.cookie = cookieString;
                    console.log(`üç™ Set cookie: ${name} = ${value}`);
                }
            },

            // Update current user data in localStorage
            updateCurrentUser(userData) {
                this.setCurrentUser(userData);
            },

            // Base request function
            async request(endpoint, options = {}) {
                const token = this.getToken();
                const headers = {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json',
                    ...(token && { 'Authorization': `Bearer ${token}` })
                };

                const config = {
                    headers,
                    mode: 'cors',
                    credentials: 'omit',
                    ...options
                };

                try {
                    console.log(`üåê API Request: ${options.method || 'GET'} ${endpoint}`);
                    const response = await fetch(`${this.baseURL}${endpoint}`, config);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    console.log(`‚úÖ API Response:`, data);
                    return data;
                } catch (error) {
                    console.error(`‚ùå API Error:`, error);
                    throw error;
                }
            },

            // Authentication methods
            async login(email, password) {
                return this.request('/api/auth/login', {
                    method: 'POST',
                    body: JSON.stringify({ email, password })
                });
            },

            async register(userData) {
                return this.request('/api/auth/register', {
                    method: 'POST',
                    body: JSON.stringify(userData)
                });
            },

            logout() {
                console.log('üö™ Logging out user...');
                this.clearCorruptedData();
                
                // Also clear any remaining cookies for good measure
                const cookiesToClear = ['nekouToken', 'nekouUser'];
                cookiesToClear.forEach(cookieName => {
                    document.cookie = `${cookieName}=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/;`;
                    document.cookie = `${cookieName}=;max-age=0;path=/;`;
                    console.log(`üóëÔ∏è Cleared cookie: ${cookieName}`);
                });
                
                // Verify data is cleared
                setTimeout(() => {
                    const remainingToken = this.getToken();
                    const remainingUser = this.getCurrentUser();
                    
                    if (remainingToken || remainingUser) {
                        console.warn('‚ö†Ô∏è Some data may not have been cleared properly');
                    } else {
                        console.log('‚úÖ All authentication data cleared');
                    }
                    
                    window.location.href = 'index.html';
                }, 100);
            },

            // User methods
            async getUser(userId) {
                return this.request(`/api/users/${userId}`);
            },

            async updateUser(userId, userData) {
                return this.request(`/api/users/${userId}`, {
                    method: 'PUT',
                    body: JSON.stringify(userData)
                });
            },

            // Dashboard method
            async getDashboard(userId) {
                return this.request(`/api/dashboard/${userId}`);
            },

            // Diary methods
            async getDiaries(userId, page = 1, limit = 10) {
                return this.request(`/api/diaries?userId=${userId}&page=${page}&limit=${limit}`);
            },

            async createDiary(diaryData) {
                return this.request('/api/diaries', {
                    method: 'POST',
                    body: JSON.stringify(diaryData)
                });
            },

            // Todo methods
            async getTodos(userId) {
                return this.request(`/api/todos?userId=${userId}`);
            },

            async createTodo(todoData) {
                return this.request('/api/todos', {
                    method: 'POST',
                    body: JSON.stringify(todoData)
                });
            },

            // Chat methods
            async getChats(userId, partnerId) {
                return this.request(`/api/chats?userId=${userId}&partnerId=${partnerId}`);
            },

            async sendMessage(messageData) {
                return this.request('/api/chats', {
                    method: 'POST',
                    body: JSON.stringify(messageData)
                });
            },

            // Partner methods
            async connectPartner(userId, partnerCode) {
                return this.request(`/api/users/${userId}/connect-partner`, {
                    method: 'POST',
                    body: JSON.stringify({ partnerCode })
                });
            },

            async disconnectPartner(userId) {
                return this.request(`/api/users/${userId}/disconnect-partner`, {
                    method: 'POST'
                });
            },

            // UI helpers
            showError(message) {
                // Create toast-like notification
                const toast = document.createElement('div');
                toast.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #dc3545;
                    color: white;
                    padding: 15px 20px;
                    border-radius: 10px;
                    z-index: 9999;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                    animation: slideIn 0.3s ease;
                `;
                toast.innerHTML = `<i class="bi bi-exclamation-circle me-2"></i>${message}`;
                
                // Add animation
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes slideIn {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                `;
                document.head.appendChild(style);
                
                document.body.appendChild(toast);
                setTimeout(() => {
                    toast.remove();
                    style.remove();
                }, 5000);
            },

            showSuccess(message) {
                const toast = document.createElement('div');
                toast.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #28a745;
                    color: white;
                    padding: 15px 20px;
                    border-radius: 10px;
                    z-index: 9999;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                `;
                toast.innerHTML = `<i class="bi bi-check-circle me-2"></i>${message}`;
                
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 3000);
            }
        };

        // Function to fetch fresh user data from API and update cookies
        async function fetchAndUpdateUserData() {
            try {
                console.log('üîÑ Fetching fresh user data from API...');
                const token = SIMPLE_API.getToken();
                if (!token) {
                    console.log('‚ùå No token found, redirecting to login');
                    window.location.href = 'index.html';
                    return null;
                }

                // Get current user from cookie first
                let user = SIMPLE_API.getCurrentUser();
                if (!user || !user.id) {
                    console.log('‚ùå No user ID found in cookie');
                    window.location.href = 'index.html';
                    return null;
                }

                console.log('üìã Attempting to fetch user data for ID:', user.id);
                
                // Test API connectivity first
                try {
                    const testResponse = await fetch(`${SIMPLE_API.baseURL}/api/health`, {
                        method: 'GET',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    console.log('üè• API Health check:', testResponse.status);
                } catch (healthError) {
                    console.log('‚ö†Ô∏è API health check failed:', healthError.message);
                }

                // Fetch fresh data from API
                const response = await SIMPLE_API.getUser(user.id);
                console.log('üìä API Response for user data:', response);
                
                if (response && response.success && response.user) {
                    console.log('‚úÖ Fresh user data received:', response.user);
                    
                    // Update cookie with fresh data
                    SIMPLE_API.updateCurrentUser(response.user);
                    console.log('‚úÖ Cookie updated with fresh data');
                    
                    return response.user;
                } else if (response && response.user) {
                    // Some APIs might not use 'success' flag
                    console.log('‚úÖ User data received (alternative format):', response.user);
                    SIMPLE_API.updateCurrentUser(response.user);
                    return response.user;
                } else {
                    console.log('‚ùå Failed to fetch user data:', response);
                    console.log('üìã Using cached user data as fallback');
                    return user; // Return cached data as fallback
                }
            } catch (error) {
                console.error('‚ùå Error fetching user data:', error);
                console.log('üìã Using cached user data as fallback');
                return SIMPLE_API.getCurrentUser(); // Return cached data as fallback
            }
        }

        // Dashboard functionality
        let currentUser = null;
        
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                console.log('üöÄ Starting dashboard initialization...');
                
                // Inspect localStorage authentication state first
                console.log('üîç Initial localStorage auth state:');
                inspectAuthState();
                
                // First, run comprehensive authentication check
                console.log('üîç Running authentication verification...');
                if (typeof checkAuthenticationStatus === 'function') {
                    const authResult = checkAuthenticationStatus();
                    if (!authResult) {
                        console.log('‚ùå Authentication check failed');
                        
                        // Check if we have any data to work with
                        const token = SIMPLE_API.getToken();
                        const user = SIMPLE_API.getCurrentUser();
                        
                        if (!token && !user) {
                            console.log('üí° No authentication data found - redirecting to login');
                            setTimeout(() => {
                                window.location.href = 'index.html';
                            }, 2000);
                        }
                        return;
                    }
                }
                
                // Fetch fresh user data from API
                currentUser = await fetchAndUpdateUserData();
                console.log('üìã Current user after fetch:', currentUser);
                
                if (!currentUser) {
                    console.log('‚ùå No user found, redirecting to login');
                    window.location.href = 'index.html';
                    return;
                }
                
                console.log('üîÑ Updating dashboard with fresh user data...');
                // Update user info
                updateUserInfo();
                
                // Load dashboard data
                await loadDashboardData();
                
                // Set up periodic authentication check
                setInterval(() => {
                    const token = SIMPLE_API.getToken();
                    const user = SIMPLE_API.getCurrentUser();
                    if (!token || !user) {
                        console.log('‚ùå Authentication lost during session, redirecting...');
                        SIMPLE_API.showError('‡πÄ‡∏ã‡∏™‡∏ä‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà');
                        setTimeout(() => {
                            window.location.href = 'index.html';
                        }, 2000);
                    }
                }, 30000); // Check every 30 seconds
                
            } catch (error) {
                console.error('‚ùå Dashboard initialization error:', error);
                SIMPLE_API.showError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
            }
        });
        
        function updateUserInfo() {
            console.log('üîÑ Updating user info with:', currentUser);
            
            if (!currentUser) {
                console.log('‚ùå No currentUser data available');
                return;
            }
            
            // Update navigation bar username
            const userNameSpans = document.querySelectorAll('#userName');
            userNameSpans.forEach(span => {
                if (span) {
                    const displayName = currentUser.displayName || currentUser.firstName || currentUser.username || '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';
                    span.textContent = displayName;
                    console.log(`‚úÖ Updated userName to: ${displayName}`);
                }
            });
            
            // Update welcome section
            const greetingTimeEl = document.getElementById('greetingTime');
            if (greetingTimeEl) {
                const hour = new Date().getHours();
                let greeting = '‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ';
                if (hour < 12) greeting = '‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏ï‡∏≠‡∏ô‡πÄ‡∏ä‡πâ‡∏≤';
                else if (hour < 17) greeting = '‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏ï‡∏≠‡∏ô‡∏ö‡πà‡∏≤‡∏¢';
                else greeting = '‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏ï‡∏≠‡∏ô‡πÄ‡∏¢‡πá‡∏ô';
                
                greetingTimeEl.textContent = greeting;
                console.log(`‚úÖ Set greeting to: ${greeting}`);
            }
            
            // Update current date
            const currentDateEl = document.getElementById('currentDate');
            if (currentDateEl) {
                const today = new Date().toLocaleDateString('th-TH', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                currentDateEl.textContent = today;
                console.log(`‚úÖ Set current date to: ${today}`);
            }
            
            // Update partner code
            const myPartnerCodeEl = document.getElementById('myPartnerCode');
            if (myPartnerCodeEl && currentUser.partnerCode) {
                myPartnerCodeEl.textContent = currentUser.partnerCode;
                console.log(`‚úÖ Set partner code to: ${currentUser.partnerCode}`);
            }
            
            console.log('‚úÖ User info update completed');
        }
        
        async function loadDashboardData() {
            try {
                console.log('üîÑ Loading dashboard data...');
                
                // Show loading state
                showLoadingState();
                
                const dashboardData = await SIMPLE_API.getDashboard(currentUser.id);
                console.log('üìä Dashboard data received:', dashboardData);
                
                // Update dashboard stats
                if (dashboardData && dashboardData.success) {
                    updateDashboardStats(dashboardData.data);
                } else {
                    console.log('‚ö†Ô∏è No dashboard data, showing basic stats');
                    updateBasicStats();
                }
                
            } catch (error) {
                console.error('‚ùå Dashboard data loading error:', error);
                // Show basic info even if API fails
                updateBasicStats();
                SIMPLE_API.showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÑ‡∏î‡πâ ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô');
            }
        }
        
        function showLoadingState() {
            const loadingElements = document.querySelectorAll('.loading-placeholder');
            loadingElements.forEach(el => {
                el.innerHTML = '<i class="bi bi-hourglass-split spinning"></i>';
            });
        }
        
        function updateDashboardStats(data) {
            console.log('üìä Updating dashboard stats with:', data);
            
            // Update main stats
            updateStatElement('diaryCount', data?.diaries?.total || 0);
            updateStatElement('todoCount', data?.todos?.pending || 0);
            updateStatElement('chatCount', data?.chats?.sent || 0);
            updateStatElement('mathAccuracy', data?.math?.accuracy ? `${data.math.accuracy}%` : '0%');
            updateStatElement('pomodoroSessions', data?.pomodoro?.sessions || 0);
            
            // Calculate days since registration
            let daysSinceJoin = 0;
            if (currentUser.created_at || currentUser.createdAt) {
                const joinDate = new Date(currentUser.created_at || currentUser.createdAt);
                const today = new Date();
                daysSinceJoin = Math.floor((today - joinDate) / (1000 * 60 * 60 * 24));
            }
            updateStatElement('daysTogether', daysSinceJoin);
            
            // Update additional stats
            updateStatElement('totalMathProblems', data?.math?.total || 0);
            updateStatElement('pomodoroHours', data?.pomodoro?.hours ? `${data.pomodoro.hours}‡∏ä‡∏°` : '0‡∏ä‡∏°');
            updateStatElement('completedTodos', data?.todos?.completed || 0);
            updateStatElement('partnerChatCount', data?.chats?.received || 0);
            
            // Update partner info
            updatePartnerInfo(data?.partner);
            
            console.log('‚úÖ Dashboard stats updated');
        }
        
        function updateStatElement(elementId, value) {
            const element = document.getElementById(elementId);
            if (element) {
                const loadingPlaceholder = element.querySelector('.loading-placeholder');
                if (loadingPlaceholder) {
                    loadingPlaceholder.textContent = value;
                    loadingPlaceholder.classList.remove('loading-placeholder');
                } else {
                    element.textContent = value;
                }
                console.log(`‚úÖ Updated ${elementId} to: ${value}`);
            }
        }
        
        function updatePartnerInfo(partnerData) {
            const partnerNameHeaderEl = document.getElementById('partnerNameHeader');
            const partnerStatusHeaderEl = document.getElementById('partnerStatusHeader');
            const partnerInfoCard = document.getElementById('partnerInfoCard');
            const pairingCard = document.getElementById('pairingCard');
            
            if (currentUser.partner || partnerData) {
                // User has a partner
                const partnerName = currentUser.partner?.displayName || partnerData?.displayName || '‡∏Ñ‡∏π‡πà‡∏£‡∏±‡∏Å';
                
                if (partnerNameHeaderEl) {
                    partnerNameHeaderEl.textContent = partnerName;
                }
                
                if (partnerStatusHeaderEl) {
                    partnerStatusHeaderEl.innerHTML = `
                        <i class="bi bi-circle-fill me-1"></i>
                        ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå
                    `;
                    partnerStatusHeaderEl.className = 'partner-status online';
                }
                
                if (partnerInfoCard) partnerInfoCard.style.display = 'block';
                if (pairingCard) pairingCard.style.display = 'none';
                
                console.log(`‚úÖ Updated partner info for: ${partnerName}`);
            } else {
                // No partner
                if (partnerNameHeaderEl) {
                    partnerNameHeaderEl.textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ';
                }
                
                if (partnerStatusHeaderEl) {
                    partnerStatusHeaderEl.innerHTML = `
                        <i class="bi bi-circle-fill me-1"></i>
                        ‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå
                    `;
                    partnerStatusHeaderEl.className = 'partner-status offline';
                }
                
                if (partnerInfoCard) partnerInfoCard.style.display = 'none';
                if (pairingCard) pairingCard.style.display = 'block';
                
                console.log('‚úÖ Updated partner info: No partner');
            }
        }
        
        function updateBasicStats() {
            console.log('üìä Updating basic stats (fallback)');
            
            // Show basic stats when API fails
            updateStatElement('diaryCount', '-');
            updateStatElement('todoCount', '-');
            updateStatElement('chatCount', '-');
            updateStatElement('mathAccuracy', '-');
            updateStatElement('pomodoroSessions', '-');
            updateStatElement('daysTogether', '-');
            updateStatElement('totalMathProblems', '-');
            updateStatElement('pomodoroHours', '-');
            updateStatElement('completedTodos', '-');
            updateStatElement('partnerChatCount', '-');
            
            // Update partner info with no data
            updatePartnerInfo(null);
        }
        
        // Copy partner code function
        function copyPartnerCode() {
            const partnerCodeEl = document.getElementById('myPartnerCode');
            if (partnerCodeEl && partnerCodeEl.textContent !== '------') {
                navigator.clipboard.writeText(partnerCodeEl.textContent).then(() => {
                    SIMPLE_API.showSuccess('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!');
                }).catch(() => {
                    SIMPLE_API.showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏î‡πâ');
                });
            }
        }
        
        // Partner pairing functionality
        async function handlePartnerPairing(event) {
            event.preventDefault();
            
            const partnerCodeInput = document.getElementById('partnerCodeInput');
            const partnerCode = partnerCodeInput.value.trim().toUpperCase();
            
            if (!partnerCode) {
                SIMPLE_API.showError('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏π‡πà‡∏£‡∏±‡∏Å');
                return;
            }
            
            try {
                console.log('üîó Attempting to connect partner with code:', partnerCode);
                const response = await SIMPLE_API.connectPartner(currentUser.id, partnerCode);
                
                if (response.success) {
                    SIMPLE_API.showSuccess('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏£‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!');
                    
                    // Update user data and reload dashboard
                    currentUser = await fetchAndUpdateUserData();
                    await loadDashboardData();
                    updateUserInfo();
                } else {
                    SIMPLE_API.showError(response.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏£‡∏±‡∏Å‡πÑ‡∏î‡πâ');
                }
            } catch (error) {
                console.error('‚ùå Partner connection error:', error);
                SIMPLE_API.showError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠');
            }
        }
        
        // Confirm unpairing partner
        function confirmUnpairPartner() {
            if (confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏Å‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏£‡∏±‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? ‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ')) {
                unpairPartner();
            }
        }
        
        // Unpair partner
        async function unpairPartner() {
            try {
                console.log('üíî Disconnecting partner...');
                const response = await SIMPLE_API.disconnectPartner(currentUser.id);
                
                if (response.success) {
                    SIMPLE_API.showSuccess('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
                    
                    // Update user data and reload dashboard
                    currentUser = await fetchAndUpdateUserData();
                    await loadDashboardData();
                    updateUserInfo();
                } else {
                    SIMPLE_API.showError(response.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡πÑ‡∏î‡πâ');
                }
            } catch (error) {
                console.error('‚ùå Partner disconnection error:', error);
                SIMPLE_API.showError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà');
            }
        }
        
        // Dashboard refresh functions
        const dashboardFunctions = {
            async refreshStats() {
                console.log('üîÑ Refreshing stats...');
                await loadDashboardData();
                SIMPLE_API.showSuccess('‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
            },
            
            async refreshDashboard() {
                console.log('üîÑ Refreshing entire dashboard...');
                currentUser = await fetchAndUpdateUserData();
                updateUserInfo();
                await loadDashboardData();
                SIMPLE_API.showSuccess('‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
            }
        };
        
        // Setup event listeners when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            // Partner pairing form
            const pairingForm = document.getElementById('pairingForm');
            if (pairingForm) {
                pairingForm.addEventListener('submit', handlePartnerPairing);
            }
            
            // Partner code input formatting
            const partnerCodeInput = document.getElementById('partnerCodeInput');
            if (partnerCodeInput) {
                partnerCodeInput.addEventListener('input', function(e) {
                    // Convert to uppercase and limit to 8 characters
                    e.target.value = e.target.value.toUpperCase().slice(0, 8);
                });
            }
        });
        
        // Development helper functions (same as settings page)
        function simulateLogin() {
            console.log('üß™ Simulating login for development testing...');
            
            const mockUser = {
                id: 'test-user-123',
                username: 'testuser',
                email: 'test@example.com',
                displayName: 'Test User',
                createdAt: new Date().toISOString(),
                partner: null
            };
            
            const mockToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0LXVzZXItMTIzIiwibmFtZSI6IlRlc3QgVXNlciIsImlhdCI6MTYxNjIzOTAyMn0.test-signature';
            
            SIMPLE_API.setToken(mockToken);
            SIMPLE_API.setCurrentUser(mockUser);
            
            console.log('‚úÖ Mock login data saved to localStorage');
            console.log('üîÑ Reloading page to test authentication...');
            
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        }

        function inspectAuthState() {
            console.log('üîç === CURRENT AUTH STATE INSPECTION ===');
            
            console.log('üíæ localStorage:');
            console.log('  - nekouToken:', localStorage.getItem('nekouToken') || 'not found');
            console.log('  - nekouUser:', localStorage.getItem('nekouUser') || 'not found');
            
            console.log('üîß SIMPLE_API methods:');
            console.log('  - getToken():', SIMPLE_API.getToken());
            console.log('  - getCurrentUser():', SIMPLE_API.getCurrentUser());
            
            if (typeof checkAuthenticationStatus === 'function') {
                console.log('üîç Auth check result:', checkAuthenticationStatus());
            }
        }

        // Make dev functions globally available
        window.simulateLogin = simulateLogin;
        window.inspectAuthState = inspectAuthState;

        // Make functions globally available
        window.copyPartnerCode = copyPartnerCode;
        window.confirmUnpairPartner = confirmUnpairPartner;
        window.dashboardFunctions = dashboardFunctions;
        
        // Navigation functions with auth check
        function navigateWithAuthCheck(url) {
            const token = SIMPLE_API.getToken();
            const user = SIMPLE_API.getCurrentUser();
            
            if (!token || !user) {
                console.log('‚ùå Authentication lost, redirecting to login');
                SIMPLE_API.showError('‡πÄ‡∏ã‡∏™‡∏ä‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà');
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 1500);
                return;
            }
            
            window.location.href = url;
        }
        
        function goToDiary() {
            navigateWithAuthCheck('diary.html');
        }
        
        function goToTodo() {
            navigateWithAuthCheck('todo.html');
        }
        
        function goToChat() {
            navigateWithAuthCheck('chat.html');
        }
        
        function goToPomodoro() {
            navigateWithAuthCheck('pomodoro.html');
        }
        
        function goToMath() {
            navigateWithAuthCheck('math.html');
        }
        
        function goToNekoChat() {
            navigateWithAuthCheck('neko-chat.html');
        }
        
        function goToProfile() {
            navigateWithAuthCheck('user-info.html');
        }
        
        function goToSettings() {
            navigateWithAuthCheck('settings.html');
        }
        
        function logout() {
            if (confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                SIMPLE_API.logout();
            }
        }
        
        // Refresh dashboard data
        async function refreshData() {
            await loadDashboardData();
            SIMPLE_API.showSuccess('‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
        }
    </script>

    <!-- Authentication Check Script -->
    <script src="auth-check.js"></script>
</body>
</html>
