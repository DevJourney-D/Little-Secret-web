<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neko U - ‡πÑ‡∏î‡∏≠‡∏≤‡∏£‡∏µ‡πà‡∏Ñ‡∏π‡πà‡∏£‡∏±‡∏Å</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="../css/navigation.css">
    <link rel="stylesheet" href="../css/style.css">
    
    <!-- Vercel Analytics -->
    <script>
        window.va = window.va || function () { (window.vaq = window.vaq || []).push(arguments); };
    </script>
    <script defer src="/_vercel/insights/script.js"></script>
    
    <style>
        /* Dropdown Navigation Styles */
        .dropdown-menu {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: none;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            padding: 20px 0;
            margin-top: 10px;
            min-width: 250px;
        }

        .dropdown-item {
            padding: 12px 24px;
            color: #333;
            font-weight: 500;
            transition: all 0.3s ease;
            border: none;
            background: none;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .dropdown-item:hover {
            background: linear-gradient(135deg, #87CEEB 0%, #98D8E8 100%);
            color: white;
            transform: translateX(5px);
        }

        .dropdown-item.active {
            background: linear-gradient(135deg, #87CEEB 0%, #98D8E8 100%);
            color: white;
            font-weight: 600;
        }

        .dropdown-item i {
            width: 20px;
            font-size: 1.1rem;
        }

        .dropdown-divider {
            border-color: rgba(0,0,0,0.1);
            margin: 15px 0;
        }

        .dropdown-toggle::after {
            display: none;
        }

        .diary-page {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }

        .diary-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .diary-header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 15px;
        }

        .diary-header p {
            font-size: 1.1rem;
            opacity: 0.9;
            margin: 0;
        }

        .diary-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            border: none;
            margin-bottom: 25px;
            overflow: hidden;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .diary-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 50px rgba(0,0,0,0.15);
        }

        .diary-form {
            padding: 35px;
        }

        .diary-form h4 {
            color: var(--text-dark);
            font-weight: 600;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-floating {
            margin-bottom: 20px;
        }

        .form-control, .form-select {
            border: 2px solid #e9ecef;
            border-radius: 15px;
            padding: 15px 20px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: rgba(255,255,255,0.9);
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.25rem rgba(135, 206, 235, 0.15);
            background: white;
        }

        .mood-selector {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .mood-option {
            width: 60px;
            height: 60px;
            border: 3px solid #e9ecef;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
        }

        .mood-option:hover {
            transform: scale(1.1);
            border-color: var(--primary-color);
            box-shadow: 0 5px 15px rgba(135, 206, 235, 0.3);
        }

        .mood-option.selected {
            border-color: var(--primary-color);
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            transform: scale(1.15);
        }

        .btn-diary {
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            border: none;
            border-radius: 15px;
            padding: 15px 35px;
            font-weight: 600;
            color: white;
            transition: all 0.3s ease;
        }

        .btn-diary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(135, 206, 235, 0.4);
            color: white;
        }

        .btn-diary:disabled {
            opacity: 0.7;
            transform: none;
        }

        .filter-section {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 25px;
            backdrop-filter: blur(10px);
        }

        .nav-pills {
            --bs-nav-pills-border-radius: 15px;
        }

        .nav-pills .nav-link {
            border-radius: 15px;
            margin-right: 10px;
            padding: 12px 25px;
            font-weight: 500;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .nav-pills .nav-link:hover {
            background: rgba(135, 206, 235, 0.1);
            border-color: var(--primary-color);
        }

        .nav-pills .nav-link.active {
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            border-color: var(--primary-color);
        }

        .diary-entry {
            padding: 25px;
            border-bottom: 1px solid #f0f0f0;
            transition: all 0.3s ease;
        }

        .diary-entry:hover {
            background: rgba(135, 206, 235, 0.05);
        }

        .diary-entry:last-child {
            border-bottom: none;
        }

        .diary-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .diary-author {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            color: var(--primary-color);
        }

        .author-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .diary-date {
            font-size: 0.9rem;
            color: #666;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .diary-mood {
            font-size: 2rem;
            margin-right: 15px;
        }

        .diary-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--text-dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .diary-content {
            line-height: 1.7;
            color: #555;
            margin-bottom: 15px;
        }

        .diary-tags {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .diary-tag {
            background: rgba(135, 206, 235, 0.1);
            color: var(--primary-color);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .diary-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 15px;
        }

        .btn-action {
            padding: 8px 15px;
            border-radius: 10px;
            font-size: 0.85rem;
            font-weight: 500;
            border: none;
            transition: all 0.3s ease;
        }

        .btn-edit {
            background: #28a745;
            color: white;
        }

        .btn-edit:hover {
            background: #218838;
            transform: translateY(-1px);
        }

        .btn-delete {
            background: #dc3545;
            color: white;
        }

        .btn-delete:hover {
            background: #c82333;
            transform: translateY(-1px);
        }

        .empty-state {
            text-align: center;
            padding: 80px 20px;
            color: #666;
        }

        .empty-state i {
            font-size: 5rem;
            color: var(--accent-color);
            margin-bottom: 25px;
        }

        .empty-state h4 {
            margin-bottom: 15px;
            color: var(--text-dark);
        }

        .loading-spinner {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 60px;
            gap: 20px;
        }

        .spinner-container {
            position: relative;
            width: 80px;
            height: 80px;
        }

        .spinner-ring {
            position: absolute;
            width: 100%;
            height: 100%;
            border: 4px solid transparent;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .spinner-ring:nth-child(2) {
            width: 60px;
            height: 60px;
            top: 10px;
            left: 10px;
            border-top-color: var(--secondary-color);
            animation-duration: 1.5s;
            animation-direction: reverse;
        }

        .spinner-ring:nth-child(3) {
            width: 40px;
            height: 40px;
            top: 20px;
            left: 20px;
            border-top-color: var(--accent-color);
            animation-duration: 2s;
        }

        .loading-heart {
            font-size: 2rem;
            color: var(--secondary-color);
            animation: heartBeat 1.5s ease-in-out infinite;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .loading-text {
            color: var(--text-dark);
            font-size: 1.1rem;
            font-weight: 500;
            animation: fadeInOut 2s ease-in-out infinite;
        }

        @keyframes heartBeat {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.3); }
        }

        @keyframes fadeInOut {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }

        .character-count {
            font-size: 0.85rem;
            color: #666;
            margin-top: 8px;
            text-align: right;
        }

        .visibility-badge {
            font-size: 0.75rem;
            padding: 4px 8px;
            border-radius: 10px;
            font-weight: 500;
        }

        .visibility-shared {
            background: rgba(255, 182, 193, 0.2);
            color: var(--secondary-color);
        }

        .visibility-private {
            background: rgba(108, 117, 125, 0.1);
            color: #6c757d;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .diary-entry {
            animation: fadeInUp 0.5s ease-out;
            animation-fill-mode: both;
        }

        .diary-entry:nth-child(1) { animation-delay: 0.1s; }
        .diary-entry:nth-child(2) { animation-delay: 0.2s; }
        .diary-entry:nth-child(3) { animation-delay: 0.3s; }
        .diary-entry:nth-child(4) { animation-delay: 0.4s; }
        .diary-entry:nth-child(5) { animation-delay: 0.5s; }

        /* Improved button hover effects */
        .btn-action {
            position: relative;
            overflow: hidden;
        }

        .btn-action::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }

        .btn-action:hover::before {
            left: 100%;
        }

        .spinning {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Alert positioning */
        .alert.position-fixed {
            max-width: 400px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            border-radius: 15px;
            border: none;
        }

        .alert-success {
            background: linear-gradient(135deg, #d4edda, #c3f5c3);
            color: #155724;
        }

        .alert-danger {
            background: linear-gradient(135deg, #f8d7da, #f5c6cb);
            color: #721c24;
        }

        /* Improved empty state */
        .empty-state {
            text-align: center;
            padding: 80px 20px;
            color: #666;
            background: rgba(255,255,255,0.5);
            border-radius: 20px;
            margin: 20px;
        }

        .empty-state i {
            font-size: 5rem;
            color: var(--accent-color);
            margin-bottom: 25px;
            opacity: 0.7;
        }

        .empty-state h4 {
            margin-bottom: 15px;
            color: var(--text-dark);
            font-weight: 600;
        }

        .empty-state p {
            font-size: 1.1rem;
            opacity: 0.8;
        }

        /* Search and sort controls */
        .diary-controls {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .search-box {
            flex: 1;
            min-width: 250px;
        }

        .sort-select {
            min-width: 150px;
        }

        /* Modal styles */
        .modal-content {
            border-radius: 20px;
            border: none;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
        }

        .modal-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: 20px 20px 0 0;
            padding: 20px 30px;
        }

        .modal-body {
            padding: 30px;
        }

        .modal-footer {
            padding: 20px 30px;
            border-top: 1px solid #e9ecef;
        }

        .navbar-brand {
            font-weight: bold;
            color: #333 !important;
        }

        .nav-link {
            color: #666 !important;
            font-weight: 500;
        }

        .nav-link:hover {
            color: #333 !important;
        }

        .nav-link.active {
            color: #FF6B6B !important;
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .diary-header {
                padding: 25px;
                margin-bottom: 20px;
            }

            .diary-header h1 {
                font-size: 2rem;
            }

            .diary-form {
                padding: 25px;
            }

            .mood-option {
                width: 50px;
                height: 50px;
                font-size: 1.5rem;
            }

            .diary-controls {
                flex-direction: column;
                align-items: stretch;
            }

            .search-box {
                min-width: 100%;
            }

            .diary-meta {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .diary-actions {
                justify-content: center;
                margin-top: 20px;
            }

            .author-avatar {
                width: 35px;
                height: 35px;
                font-size: 0.9rem;
            }

            .diary-title {
                font-size: 1.1rem;
            }

            .spinner-container {
                width: 60px;
                height: 60px;
            }

            .loading-heart {
                font-size: 1.5rem;
            }

            .empty-state {
                padding: 60px 20px;
            }

            .empty-state i {
                font-size: 4rem;
            }

            .modal-body {
                padding: 20px;
            }

            .nav-pills .nav-link {
                padding: 10px 15px;
                font-size: 0.9rem;
                margin-right: 5px;
                margin-bottom: 5px;
            }
        }

        @media (max-width: 576px) {
            .diary-header h1 {
                font-size: 1.8rem;
            }

            .diary-form {
                padding: 20px;
            }

            .mood-selector {
                justify-content: center;
            }

            .mood-option {
                width: 45px;
                height: 45px;
                font-size: 1.3rem;
            }

            .btn-diary {
                width: 100%;
                margin-top: 15px;
            }

            .diary-controls {
                padding: 15px;
            }

            .diary-entry {
                padding: 20px;
            }

            .diary-actions {
                flex-direction: column;
                gap: 8px;
            }

            .btn-action {
                width: 100%;
            }
        }
    </style>
</head>
<body class="diary-page">
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
        <div class="container">
            <a class="navbar-brand" href="dashboard.html">
                <i class="bi bi-heart-fill text-danger"></i> Neko U
            </a>
            
            <!-- User Menu Dropdown -->
            <div class="dropdown">
                <button class="btn btn-light dropdown-toggle d-flex align-items-center gap-2" type="button" data-bs-toggle="dropdown">
                    <i class="bi bi-person-circle"></i>
                    <span id="userName">Loading...</span>
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                    <li><a class="dropdown-item" href="dashboard.html">
                        <i class="bi bi-house"></i> ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å
                    </a></li>
                    <li><a class="dropdown-item active" href="diary.html">
                        <i class="bi bi-journal-heart"></i> ‡πÑ‡∏î‡∏≠‡∏≤‡∏£‡∏µ‡πà
                    </a></li>
                    <li><a class="dropdown-item" href="chat.html">
                        <i class="bi bi-chat-heart"></i> ‡πÅ‡∏ä‡∏ï
                    </a></li>
                    <li><a class="dropdown-item" href="todo.html">
                        <i class="bi bi-check2-square"></i> ‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥
                    </a></li>
                    <li><a class="dropdown-item" href="neko-chat.html">
                        <i class="bi bi-robot"></i> ‡πÅ‡∏ä‡∏ï Neko
                    </a></li>
                    <li><a class="dropdown-item" href="pomodoro.html">
                        <i class="bi bi-clock"></i> ‡πÇ‡∏õ‡πÇ‡∏°‡πÇ‡∏î‡πÇ‡∏£
                    </a></li>
                    <li><a class="dropdown-item" href="math.html">
                        <i class="bi bi-calculator"></i> ‡πÄ‡∏Å‡∏°‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå
                    </a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="#" onclick="showProfile()">
                        <i class="bi bi-gear"></i> ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
                    </a></li>
                    <li><a class="dropdown-item text-danger" href="#" onclick="logout()">
                        <i class="bi bi-box-arrow-right"></i> ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
                    </a></li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container main-container">
        <!-- Header -->
        <div class="diary-header">
            <h1>üìñ ‡πÑ‡∏î‡∏≠‡∏≤‡∏£‡∏µ‡πà‡∏Ñ‡∏π‡πà‡∏£‡∏±‡∏Å</h1>
            <p>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏£‡∏á‡∏à‡∏≥‡∏î‡∏µ‡πÜ ‡πÅ‡∏•‡∏∞‡πÅ‡∏ö‡πà‡∏á‡∏õ‡∏±‡∏ô‡∏Å‡∏±‡∏ö‡∏Ñ‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©</p>
        </div>

        <!-- Write New Entry -->
        <div class="diary-card">
            <div class="diary-form">
                <h4>
                    <i class="bi bi-pencil-square"></i>
                    ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏´‡∏°‡πà
                </h4>
                
                <form id="diaryForm">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="form-floating">
                                <input type="text" class="form-control" id="diaryTitle" 
                                       placeholder="‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á" required>
                                <label for="diaryTitle">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á</label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</label>
                            <input type="hidden" id="diaryMood" required>
                            <div class="mood-selector">
                                <div class="mood-option" data-mood="üòä" title="‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç">üòä</div>
                                <div class="mood-option" data-mood="üòç" title="‡∏£‡∏±‡∏Å">üòç</div>
                                <div class="mood-option" data-mood="ü•∞" title="‡∏´‡∏ß‡∏≤‡∏ô">ü•∞</div>
                                <div class="mood-option" data-mood="üò¢" title="‡πÄ‡∏®‡∏£‡πâ‡∏≤">üò¢</div>
                                <div class="mood-option" data-mood="üò§" title="‡πÇ‡∏Å‡∏£‡∏ò">üò§</div>
                                <div class="mood-option" data-mood="üò¥" title="‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢">üò¥</div>
                                <div class="mood-option" data-mood="ü§î" title="‡∏Ñ‡∏¥‡∏î‡∏°‡∏≤‡∏Å">ü§î</div>
                                <div class="mood-option" data-mood="üòé" title="‡πÄ‡∏ó‡πà">üòé</div>
                            </div>
                        </div>
                    </div>

                    <div class="form-floating">
                        <textarea class="form-control" id="diaryContent" rows="6" 
                                  placeholder="‡πÄ‡∏•‡πà‡∏≤‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏£‡∏≤‡∏ß‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ..." required style="height: 120px;"></textarea>
                        <label for="diaryContent">‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤</label>
                        <div class="character-count">
                            <span id="charCount">0</span> / 1000 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-floating">
                                <select class="form-select" id="diaryVisibility">
                                    <option value="shared">‡πÅ‡∏ö‡πà‡∏á‡∏õ‡∏±‡∏ô‡∏Å‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏£‡∏±‡∏Å üíï</option>
                                    <option value="private">‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß üîí</option>
                                </select>
                                <label for="diaryVisibility">‡∏Å‡∏≤‡∏£‡∏°‡∏≠‡∏á‡πÄ‡∏´‡πá‡∏ô</label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-floating">
                                <select class="form-select" id="diaryCategory">
                                    <option value="daily">‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô</option>
                                    <option value="love">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏Å</option>
                                    <option value="travel">‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß</option>
                                    <option value="food">‡∏≠‡∏≤‡∏´‡∏≤‡∏£</option>
                                    <option value="work">‡∏á‡∏≤‡∏ô</option>
                                    <option value="other">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
                                </select>
                                <label for="diaryCategory">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
                            </div>
                        </div>
                    </div>

                    <div class="text-end">
                        <button type="submit" class="btn btn-diary" id="saveDiaryBtn">
                            <i class="bi bi-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡∏≠‡∏≤‡∏£‡∏µ‡πà
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Search and Sort Controls -->
        <div class="diary-controls">
            <div class="search-box">
                <div class="form-floating">
                    <input type="text" class="form-control" id="searchInput" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÑ‡∏î‡∏≠‡∏≤‡∏£‡∏µ‡πà...">
                    <label for="searchInput">
                        <i class="bi bi-search"></i> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÑ‡∏î‡∏≠‡∏≤‡∏£‡∏µ‡πà...
                    </label>
                </div>
            </div>
            <div class="sort-select">
                <div class="form-floating">
                    <select class="form-select" id="sortBy">
                        <option value="newest">‡πÉ‡∏´‡∏°‡πà‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</option>
                        <option value="oldest">‡πÄ‡∏Å‡πà‡∏≤‡∏™‡∏∏‡∏î</option>
                        <option value="title">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á</option>
                    </select>
                    <label for="sortBy">‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö</label>
                </div>
            </div>
        </div>

        <!-- Filter Tabs -->
        <div class="filter-section">
            <ul class="nav nav-pills" id="diaryTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="all-tab" data-bs-toggle="pill" 
                            data-bs-target="#all" type="button" role="tab">
                        <i class="bi bi-journal-text"></i> ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="mine-tab" data-bs-toggle="pill" 
                            data-bs-target="#mine" type="button" role="tab">
                        <i class="bi bi-person"></i> ‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="partner-tab" data-bs-toggle="pill" 
                            data-bs-target="#partner" type="button" role="tab">
                        <i class="bi bi-heart"></i> ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏π‡πà‡∏£‡∏±‡∏Å
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="shared-tab" data-bs-toggle="pill" 
                            data-bs-target="#shared" type="button" role="tab">
                        <i class="bi bi-share"></i> ‡πÅ‡∏ö‡πà‡∏á‡∏õ‡∏±‡∏ô‡∏Å‡∏±‡∏ô
                    </button>
                </li>
            </ul>
        </div>

        <!-- Diary Entries -->
        <div class="tab-content" id="diaryTabsContent">
            <div class="tab-pane fade show active" id="all" role="tabpanel">
                <div class="diary-card">
                    <div id="allDiaryEntries">
                        <div class="loading-spinner">
                            <div class="spinner-container">
                                <div class="spinner-ring"></div>
                                <div class="spinner-ring"></div>
                                <div class="spinner-ring"></div>
                                <div class="loading-heart">üíï</div>
                            </div>
                            <p class="loading-text">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏î‡∏≠‡∏≤‡∏£‡∏µ‡πà...</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="tab-pane fade" id="mine" role="tabpanel">
                <div class="diary-card">
                    <div id="myDiaryEntries">
                        <div class="loading-spinner">
                            <div class="spinner-container">
                                <div class="spinner-ring"></div>
                                <div class="spinner-ring"></div>
                                <div class="spinner-ring"></div>
                                <div class="loading-heart">üíï</div>
                            </div>
                            <p class="loading-text">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏î‡∏≠‡∏≤‡∏£‡∏µ‡πà‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì...</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="tab-pane fade" id="partner" role="tabpanel">
                <div class="diary-card">
                    <div id="partnerDiaryEntries">
                        <div class="loading-spinner">
                            <div class="spinner-container">
                                <div class="spinner-ring"></div>
                                <div class="spinner-ring"></div>
                                <div class="spinner-ring"></div>
                                <div class="loading-heart">üíï</div>
                            </div>
                            <p class="loading-text">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏î‡∏≠‡∏≤‡∏£‡∏µ‡πà‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏π‡πà‡∏£‡∏±‡∏Å...</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="tab-pane fade" id="shared" role="tabpanel">
                <div class="diary-card">
                    <div id="sharedDiaryEntries">
                        <div class="loading-spinner">
                            <div class="spinner-container">
                                <div class="spinner-ring"></div>
                                <div class="spinner-ring"></div>
                                <div class="spinner-ring"></div>
                                <div class="loading-heart">üíï</div>
                            </div>
                            <p class="loading-text">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏î‡∏≠‡∏≤‡∏£‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÅ‡∏ö‡πà‡∏á‡∏õ‡∏±‡∏ô...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Diary Modal -->
    <div class="modal fade" id="editDiaryModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-pencil-square"></i> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡∏≠‡∏≤‡∏£‡∏µ‡πà
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editDiaryForm">
                        <input type="hidden" id="editDiaryId">
                        
                        <div class="row">
                            <div class="col-md-8">
                                <div class="form-floating mb-3">
                                    <input type="text" class="form-control" id="editDiaryTitle" 
                                           placeholder="‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á" required>
                                    <label for="editDiaryTitle">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á</label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå</label>
                                <input type="hidden" id="editDiaryMood" required>
                                <div class="mood-selector" id="editMoodSelector">
                                    <div class="mood-option" data-mood="üòä">üòä</div>
                                    <div class="mood-option" data-mood="üòç">üòç</div>
                                    <div class="mood-option" data-mood="ü•∞">ü•∞</div>
                                    <div class="mood-option" data-mood="üò¢">üò¢</div>
                                    <div class="mood-option" data-mood="üò§">üò§</div>
                                    <div class="mood-option" data-mood="üò¥">üò¥</div>
                                    <div class="mood-option" data-mood="ü§î">ü§î</div>
                                    <div class="mood-option" data-mood="üòé">üòé</div>
                                </div>
                            </div>
                        </div>

                        <div class="form-floating mb-3">
                            <textarea class="form-control" id="editDiaryContent" 
                                      placeholder="‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤" required style="height: 120px;"></textarea>
                            <label for="editDiaryContent">‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤</label>
                            <div class="character-count">
                                <span id="editCharCount">0</span> / 1000 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-floating mb-3">
                                    <select class="form-select" id="editDiaryVisibility">
                                        <option value="shared">‡πÅ‡∏ö‡πà‡∏á‡∏õ‡∏±‡∏ô‡∏Å‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏£‡∏±‡∏Å üíï</option>
                                        <option value="private">‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß üîí</option>
                                    </select>
                                    <label for="editDiaryVisibility">‡∏Å‡∏≤‡∏£‡∏°‡∏≠‡∏á‡πÄ‡∏´‡πá‡∏ô</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating mb-3">
                                    <select class="form-select" id="editDiaryCategory">
                                        <option value="daily">‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô</option>
                                        <option value="love">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏Å</option>
                                        <option value="travel">‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß</option>
                                        <option value="food">‡∏≠‡∏≤‡∏´‡∏≤‡∏£</option>
                                        <option value="work">‡∏á‡∏≤‡∏ô</option>
                                        <option value="other">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
                                    </select>
                                    <label for="editDiaryCategory">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button type="button" class="btn btn-diary" id="updateDiaryBtn">
                        <i class="bi bi-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteDiaryModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-exclamation-triangle"></i> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö‡πÑ‡∏î‡∏≠‡∏≤‡∏£‡∏µ‡πà‡∏ô‡∏µ‡πâ?</p>
                    <p class="text-muted">‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ</p>
                    <input type="hidden" id="deleteDiaryId">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                        <i class="bi bi-trash"></i> ‡∏•‡∏ö‡πÑ‡∏î‡∏≠‡∏≤‡∏£‡∏µ‡πà
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../js/simple-api.js"></script>
    <script src="../js/analytics.js"></script>
    
    <script>
        // Diary management system for Neko U
        let supabase;
        let currentUser = null;
        let partnerProfile = null;
        let diaryEntries = [];
        let currentEditId = null;

        // DOM elements
        const elements = {
            diaryForm: document.getElementById('diaryForm'),
            diaryTitle: document.getElementById('diaryTitle'),
            diaryContent: document.getElementById('diaryContent'),
            diaryMood: document.getElementById('diaryMood'),
            diaryVisibility: document.getElementById('diaryVisibility'),
            diaryCategory: document.getElementById('diaryCategory'),
            saveDiaryBtn: document.getElementById('saveDiaryBtn'),
            charCount: document.getElementById('charCount'),
            
            // Edit modal elements
            editDiaryModal: document.getElementById('editDiaryModal'),
            editDiaryForm: document.getElementById('editDiaryForm'),
            editDiaryId: document.getElementById('editDiaryId'),
            editDiaryTitle: document.getElementById('editDiaryTitle'),
            editDiaryContent: document.getElementById('editDiaryContent'),
            editDiaryMood: document.getElementById('editDiaryMood'),
            editDiaryVisibility: document.getElementById('editDiaryVisibility'),
            editDiaryCategory: document.getElementById('editDiaryCategory'),
            editCharCount: document.getElementById('editCharCount'),
            updateDiaryBtn: document.getElementById('updateDiaryBtn'),
            
            // Delete modal elements
            deleteDiaryModal: document.getElementById('deleteDiaryModal'),
            deleteDiaryId: document.getElementById('deleteDiaryId'),
            confirmDeleteBtn: document.getElementById('confirmDeleteBtn'),
            
            // Search and filter elements
            searchInput: document.getElementById('searchInput'),
            sortBy: document.getElementById('sortBy'),
            
            // Tab content containers
            allDiaryEntries: document.getElementById('allDiaryEntries'),
            myDiaryEntries: document.getElementById('myDiaryEntries'),
            partnerDiaryEntries: document.getElementById('partnerDiaryEntries'),
            sharedDiaryEntries: document.getElementById('sharedDiaryEntries'),
            
            userDisplayName: document.getElementById('userDisplayName')
        };

        // Initialize the diary page
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                console.log('üìñ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÑ‡∏î‡∏≠‡∏≤‡∏£‡∏µ‡πà...');
                
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
                if (window.nekouAuth && await nekouAuth.isAuthenticated()) {
                    currentUser = nekouAuth.getCurrentUser();
                } else {
                    console.log('‚ùå ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö');
                    if (window.utils) {
                        utils.redirect('index.html');
                    } else {
                        window.location.href = 'index.html';
                    }
                    return;
                }

                if (!currentUser) {
                    if (window.utils) {
                        utils.redirect('index.html');
                    } else {
                        window.location.href = 'index.html';
                    }
                    return;
                }
                
                await initializeDiary();
                
                console.log('‚úÖ ‡πÑ‡∏î‡∏≠‡∏≤‡∏£‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                
            } catch (error) {
                console.error('‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÑ‡∏î‡∏≠‡∏≤‡∏£‡∏µ‡πà:', error);
            }
        });

        function updateUserDisplay() {
            if (elements.userDisplayName && currentUser) {
                const displayName = currentUser.displayName || currentUser.username || '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ';
                elements.userDisplayName.textContent = displayName;
                console.log('üë§ ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ:', displayName);
            }
            
            const userName = document.getElementById('userName');
            if (userName && currentUser) {
                userName.textContent = `${currentUser.firstName || ''} ${currentUser.lastName || ''}`.trim() || currentUser.username || '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ';
            }
        }

        // Initialize diary functionality
        async function initializeDiary() {
            try {
                console.log('üîÑ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡∏≠‡∏≤‡∏£‡∏µ‡πà...');
                
                // ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
                updateUserDisplay();
                
                // Setup event listeners
                setupEventListeners();
                
                // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡∏≠‡∏≤‡∏£‡∏µ‡πà
                await loadDiaryEntries();
                
                console.log('‚úÖ ‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡∏≠‡∏≤‡∏£‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                
            } catch (error) {
                console.error('‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡∏≠‡∏≤‡∏£‡∏µ‡πà:', error);
                if (window.utils) {
                    utils.showAlert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡∏≠‡∏≤‡∏£‡∏µ‡πà‡πÑ‡∏î‡πâ', 'error');
                }
            }
        }

        // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡∏≠‡∏≤‡∏£‡∏µ‡πà‡∏à‡∏≤‡∏Å API
        async function loadDiaryEntries() {
            try {
                console.log('üìñ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏î‡∏≠‡∏≤‡∏£‡∏µ‡πà...');
                
                if (!currentUser || !currentUser.id) {
                    throw new Error('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ');
                }
                
                // Try using API if available
                if (window.api && window.api.diary) {
                    const response = await api.diary.getAll(currentUser.id);
                    
                    if (response.success && response.data) {
                        diaryEntries = response.data.diaries || [];
                        console.log(`‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏î‡∏≠‡∏≤‡∏£‡∏µ‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${diaryEntries.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
                        
                        // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÑ‡∏î‡∏≠‡∏≤‡∏£‡∏µ‡πà
                        await displayDiaryEntries();
                    } else {
                        throw new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡∏≠‡∏≤‡∏£‡∏µ‡πà‡πÑ‡∏î‡πâ');
                    }
                } else {
                    // Fallback to simple API
                    const response = await SIMPLE_API.getDiaries(currentUser.id);
                    diaryEntries = response.data || [];
                    await displayDiaryEntries();
                }
                
            } catch (error) {
                console.error('‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏î‡∏≠‡∏≤‡∏£‡∏µ‡πà:', error);
                if (window.utils) {
                    utils.showAlert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡∏≠‡∏≤‡∏£‡∏µ‡πà‡πÑ‡∏î‡πâ', 'error');
                } else {
                    alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡∏≠‡∏≤‡∏£‡∏µ‡πà‡πÑ‡∏î‡πâ');
                }
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Initialize mood selectors
            initializeMoodSelectors();
            
            // Initialize character counters
            initializeCharacterCounters();
            
            // Initialize form handlers
            initializeFormHandlers();
            
            // Initialize search and filters
            initializeSearchAndFilters();
        }

        // Initialize mood selectors
        function initializeMoodSelectors() {
            // Main mood selector
            const moodOptions = document.querySelectorAll('.mood-option:not(#editMoodSelector .mood-option)');
            moodOptions.forEach(option => {
                option.addEventListener('click', function() {
                    moodOptions.forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                    if (elements.diaryMood) {
                        elements.diaryMood.value = this.dataset.mood;
                    }
                });
            });
            
            // Edit modal mood selector
            const editMoodOptions = document.querySelectorAll('#editMoodSelector .mood-option');
            editMoodOptions.forEach(option => {
                option.addEventListener('click', function() {
                    editMoodOptions.forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                    if (elements.editDiaryMood) {
                        elements.editDiaryMood.value = this.dataset.mood;
                    }
                });
            });
        }

        // Initialize character counters
        function initializeCharacterCounters() {
            // Main form character counter
            if (elements.diaryContent && elements.charCount) {
                elements.diaryContent.addEventListener('input', function() {
                    const count = this.value.length;
                    elements.charCount.textContent = count;
                    
                    if (count > 1000) {
                        elements.charCount.style.color = '#dc3545';
                    } else if (count > 800) {
                        elements.charCount.style.color = '#ffc107';
                    } else {
                        elements.charCount.style.color = '#666';
                    }
                });
            }
            
            // Edit modal character counter
            if (elements.editDiaryContent && elements.editCharCount) {
                elements.editDiaryContent.addEventListener('input', function() {
                    const count = this.value.length;
                    elements.editCharCount.textContent = count;
                    
                    if (count > 1000) {
                        elements.editCharCount.style.color = '#dc3545';
                    } else if (count > 800) {
                        elements.editCharCount.style.color = '#ffc107';
                    } else {
                        elements.editCharCount.style.color = '#666';
                    }
                });
            }
        }

        // Initialize form handlers
        function initializeFormHandlers() {
            // Main diary form
            if (elements.diaryForm) {
                elements.diaryForm.addEventListener('submit', handleDiarySubmit);
            }
            
            // Edit diary form
            if (elements.updateDiaryBtn) {
                elements.updateDiaryBtn.addEventListener('click', handleDiaryUpdate);
            }
            
            // Delete diary confirmation
            if (elements.confirmDeleteBtn) {
                elements.confirmDeleteBtn.addEventListener('click', handleDiaryDelete);
            }

            // Fallback form handlers for simple structure
            const createForm = document.getElementById('createDiaryForm');
            if (createForm) {
                createForm.addEventListener('submit', handleCreateDiary);
            }
            
            const editForm = document.getElementById('editDiaryForm');
            if (editForm) {
                editForm.addEventListener('submit', handleUpdateDiary);
            }
        }

        // Initialize search and filters
        function initializeSearchAndFilters() {
            // Search input
            if (elements.searchInput) {
                elements.searchInput.addEventListener('input', debounce(filterAndDisplayEntries, 300));
            } else {
                // Fallback search
                const searchInput = document.getElementById('searchInput');
                if (searchInput) {
                    searchInput.addEventListener('input', handleSearch);
                }
            }
            
            // Sort selector
            if (elements.sortBy) {
                elements.sortBy.addEventListener('change', filterAndDisplayEntries);
            }
            
            // Tab change handlers
            document.querySelectorAll('[data-bs-toggle="pill"]').forEach(tab => {
                tab.addEventListener('shown.bs.tab', function(event) {
                    const targetTab = event.target.id;
                    console.log(`Switching to tab: ${targetTab}`);
                    
                    // Show appropriate loading and then filter
                    setTimeout(() => {
                        filterAndDisplayEntries();
                    }, 100);
                });
            });
            
            // Handle initial tab loading
            setTimeout(() => {
                filterAndDisplayEntries();
            }, 100);
        }

        // Handle diary form submission
        async function handleDiarySubmit(e) {
            e.preventDefault();
            
            try {
                if (elements.saveDiaryBtn) {
                    elements.saveDiaryBtn.disabled = true;
                    elements.saveDiaryBtn.innerHTML = '<i class="bi bi-arrow-clockwise spinning"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
                }
                
                const formData = {
                    title: elements.diaryTitle?.value.trim() || '',
                    content: elements.diaryContent?.value.trim() || '',
                    mood: elements.diaryMood?.value || '',
                    category: elements.diaryCategory?.value || 'daily',
                    isSharedWithPartner: elements.diaryVisibility?.value === 'shared' || false
                };
                
                // Validate form data
                if (!formData.title || !formData.content || !formData.mood) {
                    throw new Error('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
                }
                
                if (formData.content.length > 1000) {
                    throw new Error('‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 1000 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£');
                }
                
                // Save to API
                let response;
                if (window.api && window.api.diary) {
                    response = await api.diary.create(currentUser.id, formData);
                } else {
                    response = await SIMPLE_API.createDiary({
                        ...formData,
                        userId: currentUser.id
                    });
                }
                
                if (response.success) {
                    // Show success message
                    if (window.utils) {
                        utils.showAlert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡∏≠‡∏≤‡∏£‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß! üíï', 'success');
                    } else {
                        alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡∏≠‡∏≤‡∏£‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß! üíï');
                    }
                    
                    // Reset form
                    resetDiaryForm();
                    
                    // Reload entries
                    await loadDiaryEntries();
                } else {
                    throw new Error(response.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡∏≠‡∏≤‡∏£‡∏µ‡πà‡πÑ‡∏î‡πâ');
                }
                
            } catch (error) {
                console.error('Error saving diary:', error);
                if (window.utils) {
                    utils.showAlert(error.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', 'error');
                } else {
                    alert(error.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å');
                }
            } finally {
                if (elements.saveDiaryBtn) {
                    elements.saveDiaryBtn.disabled = false;
                    elements.saveDiaryBtn.innerHTML = '<i class="bi bi-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡∏≠‡∏≤‡∏£‡∏µ‡πà';
                }
            }
        }

        // Handle diary update
        async function handleDiaryUpdate() {
            try {
                if (elements.updateDiaryBtn) {
                    elements.updateDiaryBtn.disabled = true;
                    elements.updateDiaryBtn.innerHTML = '<i class="bi bi-arrow-clockwise spinning"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
                }
                
                const entryId = elements.editDiaryId?.value;
                const formData = {
                    title: elements.editDiaryTitle?.value.trim() || '',
                    content: elements.editDiaryContent?.value.trim() || '',
                    mood: elements.editDiaryMood?.value || '',
                    visibility: elements.editDiaryVisibility?.value || 'private',
                    category: elements.editDiaryCategory?.value || 'daily',
                    updated_at: new Date().toISOString()
                };
                
                // Validate form data
                if (!formData.title || !formData.content || !formData.mood) {
                    throw new Error('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
                }
                
                if (formData.content.length > 1000) {
                    throw new Error('‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 1000 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£');
                }
                
                // Update in database
                if (window.supabase) {
                    const { error } = await window.supabase
                        .from('diary_entries')
                        .update(formData)
                        .eq('id', entryId)
                        .eq('user_id', currentUser.id);
                        
                    if (error) throw error;
                } else {
                    // Fallback to simple API
                    await SIMPLE_API.updateDiary(entryId, formData);
                }
                
                // Close modal
                if (elements.editDiaryModal) {
                    const modal = bootstrap.Modal.getInstance(elements.editDiaryModal);
                    if (modal) modal.hide();
                }
                
                // Show success message
                if (window.utils) {
                    utils.showAlert('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡∏≠‡∏≤‡∏£‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß! ‚ú®', 'success');
                } else {
                    alert('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡∏≠‡∏≤‡∏£‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß! ‚ú®');
                }
                
                // Reload entries
                await loadDiaryEntries();
                
            } catch (error) {
                console.error('Error updating diary:', error);
                if (window.utils) {
                    utils.showAlert(error.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç', 'error');
                } else {
                    alert(error.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç');
                }
            } finally {
                if (elements.updateDiaryBtn) {
                    elements.updateDiaryBtn.disabled = false;
                    elements.updateDiaryBtn.innerHTML = '<i class="bi bi-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç';
                }
            }
        }

        // Handle diary deletion
        async function handleDiaryDelete() {
            try {
                if (elements.confirmDeleteBtn) {
                    elements.confirmDeleteBtn.disabled = true;
                    elements.confirmDeleteBtn.innerHTML = '<i class="bi bi-arrow-clockwise spinning"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö...';
                }
                
                const entryId = elements.deleteDiaryId?.value;
                
                // Delete from database
                if (window.supabase) {
                    const { error } = await window.supabase
                        .from('diary_entries')
                        .delete()
                        .eq('id', entryId)
                        .eq('user_id', currentUser.id);
                        
                    if (error) throw error;
                } else {
                    // Fallback to simple API
                    await SIMPLE_API.deleteDiary(entryId);
                }
                
                // Close modal
                if (elements.deleteDiaryModal) {
                    const modal = bootstrap.Modal.getInstance(elements.deleteDiaryModal);
                    if (modal) modal.hide();
                }
                
                // Show success message
                if (window.utils) {
                    utils.showAlert('‡∏•‡∏ö‡πÑ‡∏î‡∏≠‡∏≤‡∏£‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
                } else {
                    alert('‡∏•‡∏ö‡πÑ‡∏î‡∏≠‡∏≤‡∏£‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
                }
                
                // Reload entries
                await loadDiaryEntries();
                
            } catch (error) {
                console.error('Error deleting diary:', error);
                if (window.utils) {
                    utils.showAlert(error.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö', 'error');
                } else {
                    alert(error.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö');
                }
            } finally {
                if (elements.confirmDeleteBtn) {
                    elements.confirmDeleteBtn.disabled = false;
                    elements.confirmDeleteBtn.innerHTML = '<i class="bi bi-trash"></i> ‡∏•‡∏ö‡πÑ‡∏î‡∏≠‡∏≤‡∏£‡∏µ‡πà';
                }
            }
        }

        // Display diary entries
        async function displayDiaryEntries() {
            if (typeof filterAndDisplayEntries === 'function') {
                filterAndDisplayEntries();
            } else {
                renderDiaries();
            }
        }

        // Filter and display entries based on current tab and search
        function filterAndDisplayEntries() {
            const activeTabElement = document.querySelector('.nav-link.active');
            if (!activeTabElement) {
                renderDiaries();
                return;
            }

            const activeTab = activeTabElement.id;
            const searchTerm = elements.searchInput?.value.toLowerCase() || '';
            const sortBy = elements.sortBy?.value || 'newest';
            
            let filteredEntries = [...diaryEntries];
            
            // Filter by tab
            switch (activeTab) {
                case 'mine-tab':
                    filteredEntries = filteredEntries.filter(entry => entry.user_id === currentUser.id);
                    break;
                case 'partner-tab':
                    if (partnerProfile) {
                        filteredEntries = filteredEntries.filter(entry => entry.user_id === partnerProfile.id);
                    } else {
                        filteredEntries = [];
                    }
                    break;
                case 'shared-tab':
                    filteredEntries = filteredEntries.filter(entry => entry.visibility === 'shared');
                    break;
                // 'all-tab' shows all entries, no additional filtering needed
            }
            
            // Filter by search term
            if (searchTerm) {
                filteredEntries = filteredEntries.filter(entry => 
                    (entry.title || '').toLowerCase().includes(searchTerm) ||
                    (entry.content || '').toLowerCase().includes(searchTerm) ||
                    (entry.category || '').toLowerCase().includes(searchTerm)
                );
            }
            
            // Sort entries
            filteredEntries.sort((a, b) => {
                switch (sortBy) {
                    case 'oldest':
                        return new Date(a.created_at) - new Date(b.created_at);
                    case 'title':
                        return (a.title || '').localeCompare(b.title || '', 'th');
                    case 'newest':
                    default:
                        return new Date(b.created_at) - new Date(a.created_at);
                }
            });
            
            // Display entries in the active tab
            const activeContainer = getActiveContainer();
            if (activeContainer) {
                displayEntries(filteredEntries, activeContainer);
            } else {
                renderDiaries(filteredEntries);
            }
        }

        // Get the active tab container
        function getActiveContainer() {
            const activeTabElement = document.querySelector('.nav-link.active');
            if (!activeTabElement) return null;

            const activeTab = activeTabElement.id;
            
            switch (activeTab) {
                case 'mine-tab':
                    return elements.myDiaryEntries;
                case 'partner-tab':
                    return elements.partnerDiaryEntries;
                case 'shared-tab':
                    return elements.sharedDiaryEntries;
                case 'all-tab':
                default:
                    return elements.allDiaryEntries;
            }
        }

        // Display diary entries in container
        function displayEntries(entries, container) {
            if (!container) {
                renderDiaries(entries);
                return;
            }

            if (entries.length === 0) {
                const activeTabElement = document.querySelector('.nav-link.active');
                const activeTab = activeTabElement ? activeTabElement.id : 'all-tab';
                let emptyMessage = {
                    title: '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏î‡∏≠‡∏≤‡∏£‡∏µ‡πà',
                    description: '‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÑ‡∏î‡∏≠‡∏≤‡∏£‡∏µ‡πà‡πÅ‡∏£‡∏Å‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏±‡∏ô‡πÄ‡∏ñ‡∏≠‡∏∞!'
                };
                
                // Customize empty message based on active tab
                switch (activeTab) {
                    case 'mine-tab':
                        emptyMessage = {
                            title: '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏î‡∏≠‡∏≤‡∏£‡∏µ‡πà‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì',
                            description: '‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÑ‡∏î‡∏≠‡∏≤‡∏£‡∏µ‡πà‡πÅ‡∏£‡∏Å‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏±‡∏ô‡πÄ‡∏ñ‡∏≠‡∏∞!'
                        };
                        break;
                    case 'partner-tab':
                        emptyMessage = {
                            title: '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏î‡∏≠‡∏≤‡∏£‡∏µ‡πà‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏π‡πà‡∏£‡∏±‡∏Å',
                            description: '‡∏£‡∏≠‡∏Ñ‡∏π‡πà‡∏£‡∏±‡∏Å‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÑ‡∏î‡∏≠‡∏≤‡∏£‡∏µ‡πà‡∏™‡∏±‡∏Å‡∏´‡∏ô‡πà‡∏≠‡∏¢‡∏ô‡∏∞ üíï'
                        };
                        break;
                    case 'shared-tab':
                        emptyMessage = {
                            title: '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏î‡∏≠‡∏≤‡∏£‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÅ‡∏ö‡πà‡∏á‡∏õ‡∏±‡∏ô',
                            description: '‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÑ‡∏î‡∏≠‡∏≤‡∏£‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡πÅ‡∏ö‡πà‡∏á‡∏õ‡∏±‡∏ô‡∏Å‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏£‡∏±‡∏Å" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏π‡πà‡∏£‡∏±‡∏Å‡πÑ‡∏î‡πâ‡∏≠‡πà‡∏≤‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏±‡∏ô üíï'
                        };
                        break;
                    default:
                        emptyMessage = {
                            title: '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡∏≠‡∏≤‡∏£‡∏µ‡πà',
                            description: '‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÑ‡∏î‡∏≠‡∏≤‡∏£‡∏µ‡πà‡πÅ‡∏£‡∏Å‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏±‡∏ô‡πÄ‡∏ñ‡∏≠‡∏∞!'
                        };
                }
                
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-journal-x"></i>
                        <h4>${emptyMessage.title}</h4>
                        <p>${emptyMessage.description}</p>
                    </div>
                `;
                return;
            }
            
            const entriesHtml = entries.map(entry => createEntryHtml(entry)).join('');
            container.innerHTML = entriesHtml;
        }

        // Create HTML for a single diary entry
        function createEntryHtml(entry) {
            const isOwner = entry.user_id === currentUser.id;
            const authorName = isOwner ? '‡∏Ñ‡∏∏‡∏ì' : (entry.author?.display_name || '‡∏Ñ‡∏π‡πà‡∏£‡∏±‡∏Å');
            const authorInitial = authorName.charAt(0);
            const entryDate = formatDate(entry.created_at);
            const categoryName = getCategoryName(entry.category);
            const visibilityBadge = entry.visibility === 'shared' ? 
                '<span class="visibility-badge visibility-shared">‡πÅ‡∏ö‡πà‡∏á‡∏õ‡∏±‡∏ô üíï</span>' : 
                '<span class="visibility-badge visibility-private">‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß üîí</span>';
            
            const actionButtons = isOwner ? `
                <div class="diary-actions">
                    <button class="btn btn-action btn-edit" onclick="editDiary('${entry.id}')">
                        <i class="bi bi-pencil"></i> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                    </button>
                    <button class="btn btn-action btn-delete" onclick="confirmDeleteDiary('${entry.id}')">
                        <i class="bi bi-trash"></i> ‡∏•‡∏ö
                    </button>
                </div>
            ` : '';
            
            return `
                <div class="diary-entry" data-entry-id="${entry.id}">
                    <div class="diary-meta">
                        <div class="diary-author">
                            <div class="author-avatar">${authorInitial}</div>
                            <span>${authorName}</span>
                            ${visibilityBadge}
                        </div>
                        <div class="diary-date">
                            <i class="bi bi-calendar3"></i>
                            ${entryDate}
                        </div>
                    </div>
                    
                    <div class="diary-title">
                        <span class="diary-mood">${entry.mood || 'üìù'}</span>
                        ${entry.title}
                    </div>
                    
                    <div class="diary-content">
                        ${(entry.content || '').replace(/\n/g, '<br>')}
                    </div>
                    
                    <div class="diary-tags">
                        <span class="diary-tag">${categoryName}</span>
                    </div>
                    
                    ${actionButtons}
                </div>
            `;
        }

        // Fallback render function for simpler structure
        function renderDiaries(entries = diaryEntries) {
            const container = document.getElementById('diariesContainer');
            if (!container) return;
            
            if (entries.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5">
                        <i class="bi bi-journal-x display-1 text-muted"></i>
                        <h3 class="text-muted mt-3">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏î‡∏≠‡∏≤‡∏£‡∏µ‡πà</h3>
                        <p class="text-muted">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÑ‡∏î‡∏≠‡∏≤‡∏£‡∏µ‡πà‡πÅ‡∏£‡∏Å‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏±‡∏ô‡πÄ‡∏•‡∏¢!</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = entries.map(diary => `
                <div class="diary-entry" data-diary-id="${diary.id}">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <h5 class="diary-title">${diary.title}</h5>
                        <div class="diary-actions">
                            <button class="btn btn-sm btn-outline-primary me-2" onclick="editDiary('${diary.id}')">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteDiary('${diary.id}')">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="diary-content">${diary.content}</div>
                    <div class="diary-meta mt-3">
                        <small class="text-muted">
                            <i class="bi bi-calendar me-1"></i>
                            ${formatDate(diary.created_at)}
                            ${diary.mood ? `<i class="bi bi-emoji-smile ms-3 me-1"></i>${diary.mood}` : ''}
                        </small>
                    </div>
                </div>
            `).join('');
        }

        // Fallback handlers for simple forms
        async function handleCreateDiary(event) {
            event.preventDefault();
            
            const form = event.target;
            const formData = new FormData(form);
            
            try {
                const diaryData = {
                    title: formData.get('title'),
                    content: formData.get('content'),
                    mood: formData.get('mood'),
                    userId: currentUser.id
                };
                
                await SIMPLE_API.createDiary(diaryData);
                
                // Reset form and close modal
                form.reset();
                const modal = bootstrap.Modal.getInstance(document.getElementById('createDiaryModal'));
                if (modal) modal.hide();
                
                // Reload diaries
                await loadDiaryEntries();
                
                if (window.utils) {
                    utils.showAlert('‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏î‡∏≠‡∏≤‡∏£‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
                } else {
                    alert('‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏î‡∏≠‡∏≤‡∏£‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
                }
                
            } catch (error) {
                console.error('Create diary error:', error);
                if (window.utils) {
                    utils.showAlert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏î‡∏≠‡∏≤‡∏£‡∏µ‡πà‡πÑ‡∏î‡πâ', 'error');
                } else {
                    alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏î‡∏≠‡∏≤‡∏£‡∏µ‡πà‡πÑ‡∏î‡πâ');
                }
            }
        }

        async function handleUpdateDiary(event) {
            event.preventDefault();
            
            const form = event.target;
            const formData = new FormData(form);
            
            try {
                const diaryId = formData.get('diaryId');
                const updateData = {
                    title: formData.get('title'),
                    content: formData.get('content'),
                    mood: formData.get('mood')
                };
                
                await SIMPLE_API.updateDiary(diaryId, updateData);
                
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('editDiaryModal'));
                if (modal) modal.hide();
                
                // Reload diaries
                await loadDiaryEntries();
                
                if (window.utils) {
                    utils.showAlert('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÑ‡∏î‡∏≠‡∏≤‡∏£‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
                } else {
                    alert('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÑ‡∏î‡∏≠‡∏≤‡∏£‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
                }
                
            } catch (error) {
                console.error('Update diary error:', error);
                if (window.utils) {
                    utils.showAlert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÑ‡∏î‡∏≠‡∏≤‡∏£‡∏µ‡πà‡πÑ‡∏î‡πâ', 'error');
                } else {
                    alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÑ‡∏î‡∏≠‡∏≤‡∏£‡∏µ‡πà‡πÑ‡∏î‡πâ');
                }
            }
        }

        function handleSearch(event) {
            const searchTerm = event.target.value.toLowerCase();
            
            if (!searchTerm) {
                renderDiaries();
                return;
            }
            
            // Filter diaries
            const filteredDiaries = diaryEntries.filter(diary => 
                (diary.title || '').toLowerCase().includes(searchTerm) ||
                (diary.content || '').toLowerCase().includes(searchTerm)
            );
            
            renderDiaries(filteredDiaries);
        }

        // Edit diary entry
        function editDiary(entryId) {
            const entry = diaryEntries.find(e => e.id === entryId);
            if (!entry || entry.user_id !== currentUser.id) {
                if (window.utils) {
                    utils.showAlert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡∏≠‡∏≤‡∏£‡∏µ‡πà‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ', 'error');
                } else {
                    alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡∏≠‡∏≤‡∏£‡∏µ‡πà‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ');
                }
                return;
            }
            
            if (elements.editDiaryId) {
                // Populate edit form
                elements.editDiaryId.value = entry.id;
                elements.editDiaryTitle.value = entry.title;
                elements.editDiaryContent.value = entry.content;
                elements.editDiaryMood.value = entry.mood;
                elements.editDiaryVisibility.value = entry.visibility;
                elements.editDiaryCategory.value = entry.category;
                
                // Update character count
                elements.editCharCount.textContent = (entry.content || '').length;
                
                // Select mood
                document.querySelectorAll('#editMoodSelector .mood-option').forEach(opt => {
                    opt.classList.remove('selected');
                    if (opt.dataset.mood === entry.mood) {
                        opt.classList.add('selected');
                    }
                });
                
                // Show modal
                const modal = new bootstrap.Modal(elements.editDiaryModal);
                modal.show();
            } else {
                // Fallback edit
                const editId = document.getElementById('editDiaryId');
                const editTitle = document.getElementById('editTitle');
                const editContent = document.getElementById('editContent');
                const editMood = document.getElementById('editMood');
                
                if (editId) editId.value = entry.id;
                if (editTitle) editTitle.value = entry.title;
                if (editContent) editContent.value = entry.content;
                if (editMood) editMood.value = entry.mood || '';
                
                const modal = new bootstrap.Modal(document.getElementById('editDiaryModal'));
                modal.show();
            }
        }

        // Confirm diary deletion
        function confirmDeleteDiary(entryId) {
            const entry = diaryEntries.find(e => e.id === entryId);
            if (!entry || entry.user_id !== currentUser.id) {
                if (window.utils) {
                    utils.showAlert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡πÑ‡∏î‡∏≠‡∏≤‡∏£‡∏µ‡πà‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ', 'error');
                } else {
                    alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡πÑ‡∏î‡∏≠‡∏≤‡∏£‡∏µ‡πà‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ');
                }
                return;
            }
            
            if (elements.deleteDiaryId) {
                elements.deleteDiaryId.value = entryId;
                
                // Show modal
                const modal = new bootstrap.Modal(elements.deleteDiaryModal);
                modal.show();
            } else {
                // Fallback delete
                deleteDiary(entryId);
            }
        }

        async function deleteDiary(diaryId) {
            if (!confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÑ‡∏î‡∏≠‡∏≤‡∏£‡∏µ‡πà‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
            
            try {
                await SIMPLE_API.deleteDiary(diaryId);
                await loadDiaryEntries();
                
                if (window.utils) {
                    utils.showAlert('‡∏•‡∏ö‡πÑ‡∏î‡∏≠‡∏≤‡∏£‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
                } else {
                    alert('‡∏•‡∏ö‡πÑ‡∏î‡∏≠‡∏≤‡∏£‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
                }
                
            } catch (error) {
                console.error('Delete diary error:', error);
                if (window.utils) {
                    utils.showAlert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡πÑ‡∏î‡∏≠‡∏≤‡∏£‡∏µ‡πà‡πÑ‡∏î‡πâ', 'error');
                } else {
                    alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡πÑ‡∏î‡∏≠‡∏≤‡∏£‡∏µ‡πà‡πÑ‡∏î‡πâ');
                }
            }
        }

        // Utility functions
        function resetDiaryForm() {
            if (elements.diaryForm) {
                elements.diaryForm.reset();
            }
            if (elements.diaryMood) {
                elements.diaryMood.value = '';
            }
            if (elements.charCount) {
                elements.charCount.textContent = '0';
            }
            document.querySelectorAll('.mood-option:not(#editMoodSelector .mood-option)').forEach(opt => {
                opt.classList.remove('selected');
            });
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffTime = now - date;
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) {
                return '‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ ' + date.toLocaleTimeString('th-TH', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
            } else if (diffDays === 1) {
                return '‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏ô ' + date.toLocaleTimeString('th-TH', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
            } else {
                return date.toLocaleDateString('th-TH', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            }
        }

        function getCategoryName(category) {
            const categories = {
                'daily': '‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô',
                'love': '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏Å',
                'travel': '‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß',
                'food': '‡∏≠‡∏≤‡∏´‡∏≤‡∏£',
                'work': '‡∏á‡∏≤‡∏ô',
                'other': '‡∏≠‡∏∑‡πà‡∏ô‡πÜ'
            };
            return categories[category] || '‡∏≠‡∏∑‡πà‡∏ô‡πÜ';
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Navigation functions
        function showProfile() {
            if (window.utils) {
                utils.redirect('settings.html');
            } else {
                window.location.href = 'settings.html';
            }
        }

        // Logout function
        async function logout() {
            let confirmed = false;
            
            if (window.utils && typeof utils.showConfirm === 'function') {
                confirmed = await utils.showConfirm(
                    'üëã ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö', 
                    '‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö?',
                    '‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö',
                    '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                    'warning'
                );
            } else {
                confirmed = confirm('‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö?');
            }
            
            if (!confirmed) {
                return;
            }
            
            try {
                // Clean up PresenceManager before logout
                if (window.presenceManager) {
                    window.presenceManager.cleanup();
                }
                
                // Sign out from Supabase
                if (window.supabase) {
                    await window.supabase.auth.signOut();
                }
                
                // Clear local storage
                if (window.utils) {
                    utils.clearUserSession();
                    utils.redirect('index.html');
                } else {
                    localStorage.clear();
                    sessionStorage.clear();
                    window.location.href = 'index.html';
                }
                
            } catch (error) {
                console.error('‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö:', error);
                if (window.utils) {
                    utils.showAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö', 'error');
                } else {
                    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö');
                }
            }
        }

        // Make functions globally available
        window.editDiary = editDiary;
        window.confirmDeleteDiary = confirmDeleteDiary;
        window.deleteDiary = deleteDiary;
        window.logout = logout;
        window.showProfile = showProfile;

        console.log('‚úÖ ‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏î‡∏≠‡∏≤‡∏£‡∏µ‡πà‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß');
    </script>
</body>
</html>
