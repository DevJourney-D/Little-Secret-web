<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå - Neko U</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <!-- Vercel Analytics -->
    <script>
        window.va = window.va || function () { (window.vaq = window.vaq || []).push(arguments); };
    </script>
    <script defer src="/_vercel/insights/script.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #87CEEB 0%, #E6E6FA 50%, #FFB6C1 100%);
            min-height: 100vh;
            font-family: 'Inter', sans-serif;
        }

        .main-container {
            min-height: 100vh;
            padding: 20px 0;
        }

        .math-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border: none;
            padding: 30px;
            margin-bottom: 30px;
            transition: transform 0.3s ease;
        }
        
        .math-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
        }

        .problem-display {
            font-size: 2.5rem;
            font-weight: bold;
            text-align: center;
            color: #333;
            margin: 30px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 15px;
            border: 2px dashed #dee2e6;
        }

        .answer-input {
            font-size: 1.5rem;
            text-align: center;
            padding: 15px;
            border-radius: 15px;
            border: 2px solid #dee2e6;
            max-width: 200px;
            margin: 20px auto;
        }

        .answer-input:focus {
            border-color: #4ECDC4;
            box-shadow: 0 0 10px rgba(78, 205, 196, 0.3);
        }

        .btn-math {
            border-radius: 15px;
            padding: 12px 30px;
            font-weight: 600;
            margin: 5px;
            border: none;
            transition: all 0.3s ease;
        }

        .btn-check {
            background: linear-gradient(45deg, #4ECDC4, #44A08D);
            color: white;
        }

        .btn-next {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .btn-hint {
            background: linear-gradient(45deg, #FFB347, #FFCC70);
            color: white;
        }

        .btn-math:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .difficulty-selector {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
        }

        .difficulty-btn {
            border-radius: 10px;
            padding: 10px 20px;
            margin: 5px;
            border: 2px solid #dee2e6;
            background: white;
            transition: all 0.3s ease;
        }

        .difficulty-btn.active {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border-color: #667eea;
        }

        .feedback-message {
            text-align: center;
            font-size: 1.2rem;
            font-weight: 600;
            margin: 20px 0;
            padding: 15px;
            border-radius: 15px;
            display: none;
        }

        .feedback-correct {
            background: linear-gradient(45deg, #4ECDC4, #44A08D);
            color: white;
        }

        .feedback-incorrect {
            background: linear-gradient(45deg, #FF6B6B, #FF8E8E);
            color: white;
        }

        .stats-row {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .stat-item {
            text-align: center;
            padding: 15px;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            color: #666;
            font-size: 0.9rem;
        }

        .timer-display {
            font-size: 1.5rem;
            font-weight: bold;
            color: #FF6B6B;
            text-align: center;
        }

        .operation-btn {
            border-radius: 10px;
            padding: 8px 15px;
            margin: 2px;
            border: 2px solid #dee2e6;
            background: white;
            transition: all 0.3s ease;
        }

        .operation-btn.active {
            background: linear-gradient(45deg, #4ECDC4, #44A08D);
            color: white;
            border-color: #4ECDC4;
        }

        /* Dropdown Navigation Styles */
        .dropdown-menu {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: none;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            padding: 20px 0;
            margin-top: 10px;
            min-width: 250px;
        }

        .dropdown-item {
            padding: 12px 24px;
            color: #333;
            font-weight: 500;
            transition: all 0.3s ease;
            border: none;
            background: none;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .dropdown-item:hover {
            background: linear-gradient(135deg, #87CEEB 0%, #98D8E8 100%);
            color: white;
            transform: translateX(5px);
        }

        .dropdown-item.active {
            background: linear-gradient(135deg, #87CEEB 0%, #98D8E8 100%);
            color: white;
            font-weight: 600;
        }

        .dropdown-item i {
            width: 20px;
            font-size: 1.1rem;
        }

        .dropdown-divider {
            border-color: rgba(0,0,0,0.1);
            margin: 15px 0;
        }

        .dropdown-toggle::after {
            display: none;
        }

        .navbar-brand {
            font-weight: bold;
            color: #333 !important;
        }

        .navbar-nav .nav-link {
            color: #666 !important;
            font-weight: 500;
        }

        .nav-link:hover {
            color: #333 !important;
        }

        @media (max-width: 768px) {
            .problem-display {
                font-size: 1.8rem;
            }
            
            .answer-input {
                font-size: 1.2rem;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
        <div class="container">
            <a class="navbar-brand" href="dashboard.html">
                <i class="bi bi-heart-fill text-danger"></i> Neko U
            </a>
            
            <!-- User Menu Dropdown -->
            <div class="dropdown">
                <button class="btn btn-light dropdown-toggle d-flex align-items-center gap-2" type="button" data-bs-toggle="dropdown">
                    <i class="bi bi-person-circle"></i>
                    <span id="userName">Loading...</span>
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                    <li><a class="dropdown-item" href="dashboard.html">
                        <i class="bi bi-house"></i> ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å
                    </a></li>
                    <li><a class="dropdown-item" href="diary.html">
                        <i class="bi bi-journal-heart"></i> ‡πÑ‡∏î‡∏≠‡∏≤‡∏£‡∏µ‡πà
                    </a></li>
                    <li><a class="dropdown-item" href="chat.html">
                        <i class="bi bi-chat-heart"></i> ‡πÅ‡∏ä‡∏ï
                    </a></li>
                    <li><a class="dropdown-item" href="todo.html">
                        <i class="bi bi-check2-square"></i> ‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥
                    </a></li>
                    <li><a class="dropdown-item" href="neko-chat.html">
                        <i class="bi bi-robot"></i> ‡πÅ‡∏ä‡∏ï Neko
                    </a></li>
                    <li><a class="dropdown-item" href="pomodoro.html">
                        <i class="bi bi-clock"></i> ‡πÇ‡∏õ‡πÇ‡∏°‡πÇ‡∏î‡πÇ‡∏£
                    </a></li>
                    <li><a class="dropdown-item active" href="math.html">
                        <i class="bi bi-calculator"></i> ‡πÄ‡∏Å‡∏°‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå
                    </a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="#" onclick="showProfile()">
                        <i class="bi bi-gear"></i> ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
                    </a></li>
                    <li><a class="dropdown-item text-danger" href="#" onclick="logout()">
                        <i class="bi bi-box-arrow-right"></i> ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
                    </a></li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Math Game Container -->
    <div class="container main-container">
        <!-- Math Problem Section -->
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="math-card">
                    <div class="text-center mb-4">
                        <h2><i class="bi bi-calculator text-primary"></i> ‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå</h2>
                        <p class="text-muted">‡∏ù‡∏∂‡∏Å‡∏™‡∏°‡∏≠‡∏á‡∏î‡πâ‡∏ß‡∏¢‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå üßÆ</p>
                    </div>

                    <!-- Timer -->
                    <div class="timer-display mb-3" id="problemTimer">‚è∞ 00:00</div>

                    <!-- Problem Display -->
                    <div class="problem-display" id="problemDisplay">
                        <div class="text-muted">
                            <i class="bi bi-hourglass-split"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...
                        </div>
                    </div>

                    <!-- Answer Input -->
                    <div class="text-center">
                        <input type="number" class="form-control answer-input" id="answerInput" 
                               placeholder="‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö" disabled>
                    </div>

                    <!-- Feedback Message -->
                    <div class="feedback-message" id="feedbackMessage"></div>

                    <!-- Action Buttons -->
                    <div class="text-center mt-4">
                        <button class="btn btn-check btn-math" id="checkBtn" onclick="checkAnswer()" disabled>
                            <i class="bi bi-check-circle"></i> ‡∏ï‡∏£‡∏ß‡∏à‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö
                        </button>
                        <button class="btn btn-next btn-math" onclick="generateProblem()" id="newProblemBtn">
                            <i class="bi bi-arrow-right-circle"></i> ‡πÇ‡∏à‡∏ó‡∏¢‡πå‡πÉ‡∏´‡∏°‡πà
                        </button>
                        <button class="btn btn-hint btn-math" id="hintBtn" onclick="showHint()" disabled>
                            <i class="bi bi-lightbulb"></i> ‡∏Ñ‡∏≥‡πÉ‡∏ö‡πâ
                        </button>
                    </div>

                    <!-- Settings -->
                    <div class="difficulty-selector">
                        <h5><i class="bi bi-gear"></i> ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏Å</h5>
                        <div class="text-center mb-3">
                            <button class="btn difficulty-btn active" data-level="easy" onclick="setDifficulty('easy')">
                                ‡∏á‡πà‡∏≤‡∏¢ (1-10)
                            </button>
                            <button class="btn difficulty-btn" data-level="medium" onclick="setDifficulty('medium')">
                                ‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á (1-50)
                            </button>
                            <button class="btn difficulty-btn" data-level="hard" onclick="setDifficulty('hard')">
                                ‡∏¢‡∏≤‡∏Å (1-100)
                            </button>
                        </div>

                        <h6><i class="bi bi-calculator"></i> ‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</h6>
                        <div class="text-center">
                            <button class="btn operation-btn active" data-op="+" onclick="toggleOperation('+')">
                                ‡∏ö‡∏ß‡∏Å (+)
                            </button>
                            <button class="btn operation-btn active" data-op="-" onclick="toggleOperation('-')">
                                ‡∏•‡∏ö (-)
                            </button>
                            <button class="btn operation-btn" data-op="*" onclick="toggleOperation('*')">
                                ‡∏Ñ‡∏π‡∏ì (√ó)
                            </button>
                            <button class="btn operation-btn" data-op="/" onclick="toggleOperation('/')">
                                ‡∏´‡∏≤‡∏£ (√∑)
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Statistics -->
            <div class="col-lg-4">
                <div class="stats-row">
                    <h5 class="text-center mb-3"><i class="bi bi-graph-up"></i> ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</h5>
                    
                    <div class="row">
                        <div class="col-6">
                            <div class="stat-item">
                                <div class="stat-number text-success" id="correctCount">0</div>
                                <div class="stat-label">‡∏ñ‡∏π‡∏Å</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="stat-item">
                                <div class="stat-number text-danger" id="incorrectCount">0</div>
                                <div class="stat-label">‡∏ú‡∏¥‡∏î</div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-6">
                            <div class="stat-item">
                                <div class="stat-number text-primary" id="totalProblems">0</div>
                                <div class="stat-label">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="stat-item">
                                <div class="stat-number text-warning" id="accuracy">0%</div>
                                <div class="stat-label">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥</div>
                            </div>
                        </div>
                    </div>

                    <div class="text-center mt-3">
                        <div class="stat-item">
                            <div class="stat-number text-info" id="bestTime">-</div>
                            <div class="stat-label">‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</div>
                        </div>
                    </div>

                    <div class="text-center mt-3">
                        <button class="btn btn-outline-secondary btn-sm" onclick="resetStats()">
                            <i class="bi bi-arrow-clockwise"></i> ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥
                        </button>
                        <button class="btn btn-outline-info btn-sm ms-2" onclick="showProblemsInfo()">
                            <i class="bi bi-info-circle"></i> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏à‡∏ó‡∏¢‡πå
                        </button>
                    </div>
                </div>

                <!-- Recent Problems -->
                <div class="stats-row">
                    <h6><i class="bi bi-clock-history"></i> ‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h6>
                    <div id="recentProblems" class="text-muted">
                        ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏à‡∏ó‡∏¢‡πå
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Hint Modal -->
    <div class="modal fade" id="hintModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-lightbulb text-warning"></i> ‡∏Ñ‡∏≥‡πÉ‡∏ö‡πâ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="hintContent">
                    <!-- Hint content will be inserted here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡πÅ‡∏•‡πâ‡∏ß</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Neko API Helper -->
    <script src="../assets/js/neko-api.js"></script>
    <script src="../assets/js/auth-guard.js"></script>
    
    <script>
        // Math Problems functionality
        // Initialize auth guard to protect this page
        authGuard.protectPage();
        
        let currentUser = null;
        let currentProblem = null;
        let problemStartTime = null;
        let correctCount = 0;
        let incorrectCount = 0;
        let totalProblems = 0;
        let bestTime = null;
        let recentProblems = [];
        let score = 0;
        let streak = 0;
        let problemCount = 0;
        let difficulty = 'easy';
        let gameMode = 'practice';

        // Settings
        let activeOperations = ['+', '-'];
        let difficultyRanges = {
            easy: { min: 1, max: 10 },
            medium: { min: 1, max: 50 },
            hard: { min: 1, max: 100 }
        };

        // Initialize math page
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                currentUser = nekoAPI.getCurrentUser();
                if (!currentUser) {
                    window.location.href = 'index.html';
                    return;
                }
                
                initializeMath();
                await loadMathStats();
                generateNewProblem();
                
            } catch (error) {
                console.error('Math page initialization error:', error);
                nekoAPI.showError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏Å‡∏°‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå');
            }
        });

        function initializeMath() {
            // Setup answer form
            const answerForm = document.getElementById('answerForm');
            if (answerForm) {
                answerForm.addEventListener('submit', handleAnswer);
            }

            // Setup settings
            const difficultySelect = document.getElementById('difficulty');
            if (difficultySelect) {
                difficultySelect.addEventListener('change', function() {
                    difficulty = this.value;
                    generateNewProblem();
                });
            }

            // Setup operation toggles
            const operationButtons = document.querySelectorAll('.operation-btn');
            operationButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    this.classList.toggle('active');
                    updateActiveOperations();
                });
            });

            // Setup new problem button
            const newProblemBtn = document.getElementById('newProblem');
            if (newProblemBtn) {
                newProblemBtn.addEventListener('click', generateNewProblem);
            }

            updateUserDisplay();
        }

        function updateUserDisplay() {
            const userName = document.getElementById('userName');
            if (userName && currentUser) {
                userName.textContent = `${currentUser.firstName || ''} ${currentUser.lastName || ''}`.trim() || currentUser.username || '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ';
            }
        }

        function updateActiveOperations() {
            activeOperations = [];
            document.querySelectorAll('.operation-btn.active').forEach(btn => {
                activeOperations.push(btn.dataset.operation);
            });
            
            if (activeOperations.length === 0) {
                activeOperations = ['+'];
                document.querySelector('[data-operation="+"]').classList.add('active');
            }
        }

        function generateNewProblem() {
            if (activeOperations.length === 0) {
                activeOperations = ['+'];
            }

            const operation = activeOperations[Math.floor(Math.random() * activeOperations.length)];
            const range = difficultyRanges[difficulty];
            
            let num1 = Math.floor(Math.random() * (range.max - range.min + 1)) + range.min;
            let num2 = Math.floor(Math.random() * (range.max - range.min + 1)) + range.min;
            let answer;

            switch (operation) {
                case '+':
                    answer = num1 + num2;
                    break;
                case '-':
                    // Make sure result is positive
                    if (num1 < num2) [num1, num2] = [num2, num1];
                    answer = num1 - num2;
                    break;
                case '*':
                    // Keep numbers smaller for multiplication
                    num1 = Math.floor(Math.random() * Math.min(range.max/2, 12)) + 1;
                    num2 = Math.floor(Math.random() * Math.min(range.max/2, 12)) + 1;
                    answer = num1 * num2;
                    break;
                case '/':
                    // Generate division that results in whole numbers
                    answer = Math.floor(Math.random() * Math.min(range.max/2, 12)) + 1;
                    num2 = Math.floor(Math.random() * Math.min(range.max/2, 12)) + 1;
                    num1 = answer * num2;
                    break;
            }

            currentProblem = {
                num1: num1,
                num2: num2,
                operation: operation,
                answer: answer,
                id: Date.now()
            };

            problemStartTime = Date.now();

            // Update UI
            document.getElementById('problemDisplay').innerHTML = 
                `${num1} ${operation} ${num2} = ?`;
            document.getElementById('answerInput').value = '';
            document.getElementById('answerInput').focus();
            
            // Clear previous feedback
            const feedback = document.getElementById('feedback');
            if (feedback) {
                feedback.innerHTML = '';
                feedback.className = 'mt-3';
            }
        }

        function handleAnswer(e) {
            e.preventDefault();
            
            const userAnswer = parseInt(document.getElementById('answerInput').value);
            const timeTaken = Date.now() - problemStartTime;
            
            if (isNaN(userAnswer)) {
                showFeedback('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç', 'warning');
                return;
            }

            const isCorrect = userAnswer === currentProblem.answer;
            totalProblems++;

            if (isCorrect) {
                correctCount++;
                streak++;
                score += Math.max(100 - Math.floor(timeTaken / 1000) * 10, 10);
                
                if (!bestTime || timeTaken < bestTime) {
                    bestTime = timeTaken;
                }

                showFeedback(`‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á! üéâ (${(timeTaken / 1000).toFixed(1)} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)`, 'success');
            } else {
                incorrectCount++;
                streak = 0;
                showFeedback(`‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á üòî ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏Ñ‡∏∑‡∏≠ ${currentProblem.answer}`, 'danger');
            }

            // Store problem in recent history
            recentProblems.unshift({
                ...currentProblem,
                userAnswer: userAnswer,
                correct: isCorrect,
                timeTaken: timeTaken
            });

            if (recentProblems.length > 10) {
                recentProblems = recentProblems.slice(0, 10);
            }

            updateStats();
            
            // Auto-generate new problem after 2 seconds
            setTimeout(() => {
                generateNewProblem();
            }, 2000);
        }

        function showFeedback(message, type) {
            const feedback = document.getElementById('feedback');
            if (feedback) {
                feedback.innerHTML = `
                    <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                        ${message}
                    </div>
                `;
            }
        }

        function updateStats() {
            const accuracy = totalProblems > 0 ? Math.round((correctCount / totalProblems) * 100) : 0;
            
            document.getElementById('correctCount').textContent = correctCount;
            document.getElementById('incorrectCount').textContent = incorrectCount;
            document.getElementById('accuracy').textContent = accuracy;
            document.getElementById('streak').textContent = streak;
            document.getElementById('score').textContent = score;
            
            if (bestTime) {
                document.getElementById('bestTime').textContent = (bestTime / 1000).toFixed(1);
            }
        }

        async function loadMathStats() {
            try {
                // Load user stats from API or localStorage
                const stats = JSON.parse(localStorage.getItem(`mathStats_${currentUser.id}`)) || {};
                
                correctCount = stats.correctCount || 0;
                incorrectCount = stats.incorrectCount || 0;
                totalProblems = stats.totalProblems || 0;
                bestTime = stats.bestTime || null;
                score = stats.score || 0;
                
                updateStats();
            } catch (error) {
                console.error('Error loading math stats:', error);
            }
        }

        function saveMathStats() {
            try {
                const stats = {
                    correctCount,
                    incorrectCount,
                    totalProblems,
                    bestTime,
                    score,
                    lastPlayed: Date.now()
                };
                
                localStorage.setItem(`mathStats_${currentUser.id}`, JSON.stringify(stats));
            } catch (error) {
                console.error('Error saving math stats:', error);
            }
        }

        function resetStats() {
            if (confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                correctCount = 0;
                incorrectCount = 0;
                totalProblems = 0;
                bestTime = null;
                score = 0;
                streak = 0;
                recentProblems = [];
                
                updateStats();
                saveMathStats();
                
                nekoAPI.showSuccess('‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
            }
        }

        // Navigation functions
        function showProfile() {
            window.location.href = 'user-info.html';
        }

        async function logout() {
            if (confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                saveMathStats();
                localStorage.clear();
                sessionStorage.clear();
                window.location.href = 'index.html';
            }
        }

        // Save stats periodically
        setInterval(saveMathStats, 30000); // Save every 30 seconds

        // Save stats before page unload
        window.addEventListener('beforeunload', saveMathStats);

        // Make functions globally available
        window.generateNewProblem = generateNewProblem;
        window.resetStats = resetStats;
        window.logout = logout;
        window.showProfile = showProfile;

        console.log('‚úÖ ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏Å‡∏°‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß');
    </script>
                nekoAPI.showError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå');
            }
        });
        
        function setupMathUI() {
            // Setup answer form
            const answerForm = document.getElementById('answerForm');
            if (answerForm) {
                answerForm.addEventListener('submit', handleAnswer);
            }
            
            // Setup answer input
            const answerInput = document.getElementById('answerInput');
            if (answerInput) {
                answerInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        handleAnswer(e);
                    }
                });
            }
            
            // Setup difficulty buttons
            const difficultyButtons = document.querySelectorAll('[data-difficulty]');
            difficultyButtons.forEach(button => {
                button.addEventListener('click', (e) => {
                    difficulty = e.target.dataset.difficulty;
                    updateDifficultyButtons();
                    generateNewProblem();
                });
            });
            
            // Setup game mode buttons
            const gameModeButtons = document.querySelectorAll('[data-mode]');
            gameModeButtons.forEach(button => {
                button.addEventListener('click', (e) => {
                    gameMode = e.target.dataset.mode;
                    updateGameModeButtons();
                    resetGame();
                });
            });
            
            // Setup control buttons
            const newProblemBtn = document.getElementById('newProblemBtn');
            const resetGameBtn = document.getElementById('resetGameBtn');
            
            if (newProblemBtn) newProblemBtn.addEventListener('click', generateNewProblem);
            if (resetGameBtn) resetGameBtn.addEventListener('click', resetGame);
            
            // Initial UI update
            updateDifficultyButtons();
            updateGameModeButtons();
            updateStats();
        }
        
        async function loadMathStats() {
            try {
                const response = await nekoAPI.getMathStats(currentUser.id);
                const stats = response.data || {};
                
                // Update UI with saved stats
                const totalProblemsEl = document.getElementById('totalProblems');
                const correctAnswersEl = document.getElementById('correctAnswers');
                const accuracyEl = document.getElementById('accuracy');
                
                if (totalProblemsEl) totalProblemsEl.textContent = stats.totalProblems || 0;
                if (correctAnswersEl) correctAnswersEl.textContent = stats.correctAnswers || 0;
                if (accuracyEl) {
                    const accuracy = stats.totalProblems > 0 
                        ? Math.round((stats.correctAnswers / stats.totalProblems) * 100)
                        : 0;
                    accuracyEl.textContent = `${accuracy}%`;
                }
                
            } catch (error) {
                console.error('Load math stats error:', error);
                // Continue without stats if API fails
            }
        }
        
        function generateNewProblem() {
            const operations = ['+', '-', '*', '/'];
            const operation = operations[Math.floor(Math.random() * operations.length)];
            
            let num1, num2, answer;
            
            switch (difficulty) {
                case 'easy':
                    num1 = Math.floor(Math.random() * 10) + 1;
                    num2 = Math.floor(Math.random() * 10) + 1;
                    break;
                case 'medium':
                    num1 = Math.floor(Math.random() * 50) + 1;
                    num2 = Math.floor(Math.random() * 20) + 1;
                    break;
                case 'hard':
                    num1 = Math.floor(Math.random() * 100) + 1;
                    num2 = Math.floor(Math.random() * 50) + 1;
                    break;
            }
            
            // Calculate answer based on operation
            switch (operation) {
                case '+':
                    answer = num1 + num2;
                    break;
                case '-':
                    // Ensure positive result
                    if (num1 < num2) [num1, num2] = [num2, num1];
                    answer = num1 - num2;
                    break;
                case '*':
                    answer = num1 * num2;
                    break;
                case '/':
                    // Ensure whole number result
                    answer = num1;
                    num1 = answer * num2;
                    break;
            }
            
            currentProblem = {
                num1,
                num2,
                operation,
                answer
            };
            
            // Update UI
            displayProblem();
            
            // Clear previous answer
            const answerInput = document.getElementById('answerInput');
            if (answerInput) {
                answerInput.value = '';
                answerInput.focus();
            }
        }
        
        function displayProblem() {
            const problemEl = document.getElementById('problemDisplay');
            if (problemEl && currentProblem) {
                problemEl.textContent = `${currentProblem.num1} ${currentProblem.operation} ${currentProblem.num2} = ?`;
            }
        }
        
        async function handleAnswer(event) {
            event.preventDefault();
            
            const answerInput = document.getElementById('answerInput');
            if (!answerInput || !currentProblem) return;
            
            const userAnswer = parseInt(answerInput.value);
            const isCorrect = userAnswer === currentProblem.answer;
            
            try {
                // Save problem result
                const problemData = {
                    userId: currentUser.id,
                    problem: `${currentProblem.num1} ${currentProblem.operation} ${currentProblem.num2}`,
                    correctAnswer: currentProblem.answer,
                    userAnswer: userAnswer,
                    isCorrect: isCorrect,
                    difficulty: difficulty,
                    solvedAt: new Date().toISOString()
                };
                
                await nekoAPI.saveMathProblem(problemData);
                
                // Update game state
                problemCount++;
                
                if (isCorrect) {
                    score++;
                    streak++;
                    showFeedback('‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á! üéâ', 'success');
                } else {
                    streak = 0;
                    showFeedback(`‡∏ú‡∏¥‡∏î! ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏Ñ‡∏∑‡∏≠ ${currentProblem.answer}`, 'error');
                }
                
                // Update stats
                updateStats();
                
                // Generate new problem after delay
                setTimeout(() => {
                    generateNewProblem();
                }, 1500);
                
            } catch (error) {
                console.error('Handle answer error:', error);
                nekoAPI.showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÑ‡∏î‡πâ');
            }
        }
        
        function showFeedback(message, type) {
            const feedbackEl = document.getElementById('feedback');
            if (!feedbackEl) return;
            
            feedbackEl.textContent = message;
            feedbackEl.className = `feedback ${type}`;
            feedbackEl.style.display = 'block';
            
            setTimeout(() => {
                feedbackEl.style.display = 'none';
            }, 1500);
        }
        
        function updateStats() {
            const scoreEl = document.getElementById('currentScore');
            const streakEl = document.getElementById('currentStreak');
            const problemCountEl = document.getElementById('currentProblems');
            const accuracyEl = document.getElementById('currentAccuracy');
            
            if (scoreEl) scoreEl.textContent = score;
            if (streakEl) streakEl.textContent = streak;
            if (problemCountEl) problemCountEl.textContent = problemCount;
            if (accuracyEl) {
                const accuracy = problemCount > 0 ? Math.round((score / problemCount) * 100) : 0;
                accuracyEl.textContent = `${accuracy}%`;
            }
        }
        
        function updateDifficultyButtons() {
            const buttons = document.querySelectorAll('[data-difficulty]');
            buttons.forEach(button => {
                if (button.dataset.difficulty === difficulty) {
                    button.classList.add('active');
                } else {
                    button.classList.remove('active');
                }
            });
        }
        
        function updateGameModeButtons() {
            const buttons = document.querySelectorAll('[data-mode]');
            buttons.forEach(button => {
                if (button.dataset.mode === gameMode) {
                    button.classList.add('active');
                } else {
                    button.classList.remove('active');
                }
            });
        }
        
        function resetGame() {
            score = 0;
            streak = 0;
            problemCount = 0;
            updateStats();
            generateNewProblem();
            nekoAPI.showSuccess('‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡πÉ‡∏´‡∏°‡πà!');
        }
        
        // Navigation functions
        function goBack() {
            window.location.href = 'dashboard.html';
        }
    </script>
</body>
</html>
