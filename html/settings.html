<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neko U - ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="../css/navigation.css">
    <link rel="stylesheet" href="../css/style.css">
    
    <style>
        :root {
            --primary-color: #FF69B4;
            --secondary-color: #87CEEB;
            --accent-color: #FFB6C1;
            --bg-gradient: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }

        body {
            background: var(--bg-gradient);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            scroll-behavior: smooth;
        }
        
        .settings-container {
            padding: 2rem 0;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .settings-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.08);
            margin-bottom: 2rem;
            border: none;
            backdrop-filter: blur(10px);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .settings-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.12);
        }
        
        .card-header {
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: 20px 20px 0 0 !important;
            padding: 1.5rem 2rem;
            border: none;
        }

        .card-header h5 {
            font-weight: 600;
            margin: 0;
        }
        
        .overview-card {
            background: linear-gradient(135deg, var(--secondary-color), var(--accent-color));
            color: white;
            border-radius: 20px;
            margin-bottom: 2rem;
        }
        
        .overview-card .card-body {
            padding: 2rem;
        }

        .user-avatar {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        .user-info h3 {
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .user-info p {
            margin-bottom: 0.3rem;
            opacity: 0.9;
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.8rem 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .info-row:last-child {
            border-bottom: none;
        }

        .info-row i {
            color: var(--primary-color);
        }
        
        .btn-group .btn {
            border-radius: 10px !important;
            font-weight: 500;
            padding: 0.5rem 1rem;
        }
        
        .btn-group .btn:not(:last-child) {
            margin-right: 0.5rem;
        }
        
        .edit-mode-controls {
            animation: fadeIn 0.3s ease-in-out;
            display: none !important;
        }

        .edit-mode .edit-mode-controls {
            display: inline-block !important;
        }

        .edit-mode .view-mode-controls {
            display: none !important;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .form-control, .form-select {
            border-radius: 10px;
            border: 2px solid #e9ecef;
            padding: 0.8rem 1rem;
            transition: all 0.3s ease;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(255, 105, 180, 0.25);
        }

        .form-control:disabled {
            background-color: #f8f9fa;
            border-color: #e9ecef;
            opacity: 0.8;
            cursor: not-allowed;
        }

        .form-control:not(:disabled) {
            background-color: white;
            border-color: #e9ecef;
        }

        .form-control:not(:disabled):focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(255, 105, 180, 0.25);
        }

        .form-check-input:disabled {
            cursor: not-allowed;
        }
        
        .edit-mode .form-control:not(.form-control-plaintext) {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.1rem rgba(255, 105, 180, 0.15);
        }

        .btn:disabled {
            cursor: not-allowed;
        }

        .spinner-border-sm {
            width: 0.875rem;
            height: 0.875rem;
        }
        
        .form-floating {
            margin-bottom: 1.5rem;
        }
        
        .form-placeholder {
            padding: 3rem 2rem;
            color: #6c757d;
            text-align: center;
            border-radius: 15px;
            background: #f8f9fa;
        }
        
        .password-strength .progress {
            height: 8px;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .alert {
            border: none;
            border-left: 4px solid;
            border-radius: 15px;
            padding: 1rem 1.5rem;
        }
        
        .alert-info {
            border-left-color: #0dcaf0;
            background-color: rgba(13, 202, 240, 0.1);
        }
        
        .alert-warning {
            border-left-color: #ffc107;
            background-color: rgba(255, 193, 7, 0.1);
        }

        .alert-danger {
            border-left-color: #dc3545;
            background-color: rgba(220, 53, 69, 0.1);
        }

        .form-check-input:checked {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .navbar {
            background: rgba(255, 255, 255, 0.95) !important;
            backdrop-filter: blur(15px);
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
        }

        .section-title {
            font-weight: 600;
            color: #495057;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e9ecef;
        }

        .quick-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-3px);
        }

        .stat-icon {
            font-size: 2rem;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        .danger-zone {
            background: rgba(220, 53, 69, 0.05);
            border: 2px solid rgba(220, 53, 69, 0.2);
            border-radius: 15px;
            padding: 1.5rem;
        }

        .partnership-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.5rem 1rem;
            border-radius: 25px;
            font-weight: 500;
            gap: 0.5rem;
        }

        .partnership-badge.connected {
            background: rgba(40, 167, 69, 0.1);
            color: #28a745;
            border: 2px solid rgba(40, 167, 69, 0.3);
        }

        .partnership-badge.pending {
            background: rgba(255, 193, 7, 0.1);
            color: #ffc107;
            border: 2px solid rgba(255, 193, 7, 0.3);
        }

        .partnership-badge.none {
            background: rgba(108, 117, 125, 0.1);
            color: #6c757d;
            border: 2px solid rgba(108, 117, 125, 0.3);
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .settings-container {
                padding: 1rem;
            }
            
            .overview-card .card-body {
                padding: 1.5rem;
            }
            
            .user-avatar {
                font-size: 3rem;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg">
        <div class="container">
            <a class="navbar-brand" href="dashboard.html">
                üê± Neko U
            </a>
            
            <div class="navbar-nav ms-auto">
                <div class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" 
                       data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-person-circle"></i>
                        <span id="userName">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</span>
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                        <li><a class="dropdown-item" href="dashboard.html">
                            <i class="bi bi-house"></i> ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item text-danger" href="#" onclick="handleLogout()">
                            <i class="bi bi-box-arrow-right"></i> ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
                        </a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container settings-container">
        <!-- User Overview Card -->
        <div class="card overview-card">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-3 text-center">
                        <div class="user-avatar">
                            <i class="bi bi-person-circle"></i>
                        </div>
                    </div>
                    <div class="col-md-6 user-info">
                        <h3 id="userDisplayName">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</h3>
                        <p><i class="bi bi-envelope me-2"></i><span id="userEmail">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span></p>
                        <p><i class="bi bi-person me-2"></i><span id="userUsername">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span></p>
                        <p><i class="bi bi-calendar me-2"></i>‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡πÄ‡∏°‡∏∑‡πà‡∏≠ <span id="userJoinDate">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span></p>
                        <div id="loadingStatus" class="alert alert-info mt-2" style="display: none;">
                            <div class="d-flex align-items-center">
                                <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                                <span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå...</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 text-center">
                        <div id="partnershipStatus" class="mb-3">
                            <span class="partnership-badge none">
                                <i class="bi bi-heart"></i>
                                ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏π‡πà‡∏£‡∏±‡∏Å
                            </span>
                        </div>
                        <div>
                            <button class="btn btn-light btn-sm" id="editOverviewBtn">
                                <i class="bi bi-pencil me-1"></i>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="quick-stats">
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="bi bi-journal-text"></i>
                </div>
                <h6>‡πÑ‡∏î‡∏≠‡∏≤‡∏£‡∏µ‡πà</h6>
                <p class="text-muted mb-0">0 ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</p>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="bi bi-chat-heart"></i>
                </div>
                <h6>‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</h6>
                <p class="text-muted mb-0">0 ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</p>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="bi bi-calendar-heart"></i>
                </div>
                <h6>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏±‡∏ô</h6>
                <p class="text-muted mb-0">- ‡∏ß‡∏±‡∏ô</p>
            </div>
        </div>

        <div class="row">
            <!-- Main Settings -->
            <div class="col-lg-8">
                <!-- Basic Profile -->
                <div class="card settings-card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-person-lines-fill me-2"></i>
                            ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß
                        </h5>
                        <div class="btn-group" role="group">
                            <button class="btn btn-outline-light btn-sm view-mode-controls" id="editBasicProfileBtn">
                                <i class="bi bi-pencil me-1"></i>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                            </button>
                            <button class="btn btn-success btn-sm edit-mode-controls" id="saveBasicProfileBtn" style="display: none;">
                                <i class="bi bi-check me-1"></i>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                            </button>
                            <button class="btn btn-outline-light btn-sm edit-mode-controls" id="cancelBasicProfileBtn" style="display: none;">
                                <i class="bi bi-x me-1"></i>‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <form id="updateProfileForm">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="firstName" class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" id="firstName" name="firstName" disabled required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="lastName" class="form-label">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" id="lastName" name="lastName" disabled required>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="displayName" class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á</label>
                                        <input type="text" class="form-control" id="displayName" name="displayName" disabled>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="nickname" class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô</label>
                                        <input type="text" class="form-control" id="nickname" name="nickname" disabled>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">‡πÄ‡∏û‡∏®</label>
                                        <div class="mt-2">
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input" type="radio" name="gender" id="genderMale" value="male" disabled>
                                                <label class="form-check-label" for="genderMale">‡∏ä‡∏≤‡∏¢</label>
                                            </div>
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input" type="radio" name="gender" id="genderFemale" value="female" disabled>
                                                <label class="form-check-label" for="genderFemale">‡∏´‡∏ç‡∏¥‡∏á</label>
                                            </div>
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input" type="radio" name="gender" id="genderOther" value="other" disabled>
                                                <label class="form-check-label" for="genderOther">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="birthDate" class="form-label">‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î</label>
                                        <input type="date" class="form-control" id="birthDate" name="birthDate" disabled>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="phone" class="form-label">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
                                <input type="tel" class="form-control" id="phone" name="phone" disabled>
                            </div>
                            <div class="mb-3">
                                <label for="bio" class="form-label">‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏â‡∏±‡∏ô</label>
                                <textarea class="form-control" id="bio" name="bio" rows="3" disabled placeholder="‡πÄ‡∏•‡πà‡∏≤‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏£‡∏≤‡∏ß‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡∏Ñ‡∏∏‡∏ì..."></textarea>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Preferences -->
                <div class="card settings-card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-gear me-2"></i>
                            ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
                        </h5>
                        <div class="btn-group" role="group">
                            <button class="btn btn-outline-light btn-sm view-mode-controls" id="editPreferencesBtn">
                                <i class="bi bi-pencil me-1"></i>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                            </button>
                            <button class="btn btn-success btn-sm edit-mode-controls" id="savePreferencesBtn" style="display: none;">
                                <i class="bi bi-check me-1"></i>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                            </button>
                            <button class="btn btn-outline-light btn-sm edit-mode-controls" id="cancelPreferencesBtn" style="display: none;">
                                <i class="bi bi-x me-1"></i>‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <form id="preferencesForm">
                            <h6 class="section-title">‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</h6>
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <div class="form-check form-switch mb-3">
                                        <input class="form-check-input" type="checkbox" id="notificationChat" name="notificationChat" disabled>
                                        <label class="form-check-label" for="notificationChat">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ä‡∏ó</label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check form-switch mb-3">
                                        <input class="form-check-input" type="checkbox" id="notificationDiary" name="notificationDiary" disabled>
                                        <label class="form-check-label" for="notificationDiary">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÑ‡∏î‡∏≠‡∏≤‡∏£‡∏µ‡πà</label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check form-switch mb-3">
                                        <input class="form-check-input" type="checkbox" id="notificationPush" name="notificationPush" disabled>
                                        <label class="form-check-label" for="notificationPush">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå</label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check form-switch mb-3">
                                        <input class="form-check-input" type="checkbox" id="notificationEmail" name="notificationEmail" disabled>
                                        <label class="form-check-label" for="notificationEmail">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ú‡πà‡∏≤‡∏ô‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
                                    </div>
                                </div>
                            </div>

                            <h6 class="section-title">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</h6>
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="diaryDefault" class="form-label">‡πÑ‡∏î‡∏≠‡∏≤‡∏£‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</label>
                                        <select class="form-select" id="diaryDefault" name="diaryDefault" disabled>
                                            <option value="private">‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</option>
                                            <option value="shared">‡πÅ‡∏ä‡∏£‡πå‡∏Å‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏£‡∏±‡∏Å</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="profileVisibility" class="form-label">‡∏Å‡∏≤‡∏£‡∏°‡∏≠‡∏á‡πÄ‡∏´‡πá‡∏ô‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</label>
                                        <select class="form-select" id="profileVisibility" name="profileVisibility" disabled>
                                            <option value="private">‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</option>
                                            <option value="partner">‡∏Ñ‡∏π‡πà‡∏£‡∏±‡∏Å‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="lastSeenVisible" name="lastSeenVisible" disabled>
                                        <label class="form-check-label" for="lastSeenVisible">‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</label>
                                    </div>
                                </div>
                            </div>

                            <h6 class="section-title">‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="language" class="form-label">‡∏†‡∏≤‡∏©‡∏≤</label>
                                        <select class="form-select" id="language" name="language" disabled>
                                            <option value="th">‡πÑ‡∏ó‡∏¢</option>
                                            <option value="en">English</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="timezone" class="form-label">‡πÄ‡∏Ç‡∏ï‡πÄ‡∏ß‡∏•‡∏≤</label>
                                        <select class="form-select" id="timezone" name="timezone" disabled>
                                            <option value="Asia/Bangkok">‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏ó‡∏¢ (GMT+7)</option>
                                            <option value="UTC">UTC (GMT+0)</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Security Settings -->
                <div class="card settings-card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-shield-lock me-2"></i>
                            ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <h6><i class="bi bi-envelope-at me-2"></i>‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏≠‡∏µ‡πÄ‡∏°‡∏•</h6>
                                    <p class="text-muted small">‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: <span id="currentEmailDisplay">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span></p>
                                    <button class="btn btn-outline-primary btn-sm" id="editEmailBtn">
                                        <i class="bi bi-pencil me-1"></i>‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏≠‡∏µ‡πÄ‡∏°‡∏•
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <h6><i class="bi bi-key me-2"></i>‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</h6>
                                    <p class="text-muted small">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô</p>
                                    <button class="btn btn-outline-primary btn-sm" id="editPasswordBtn">
                                        <i class="bi bi-pencil me-1"></i>‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Change Email Form -->
                        <div id="changeEmailForm" style="display: none;">
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle me-2"></i>
                                ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏à‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                            </div>
                            <form>
                                <div class="mb-3">
                                    <label for="newEmail" class="form-label">‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÉ‡∏´‡∏°‡πà <span class="text-danger">*</span></label>
                                    <input type="email" class="form-control" id="newEmail" name="newEmail" required>
                                </div>
                                <div class="mb-3">
                                    <label for="currentPasswordEmail" class="form-label">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô <span class="text-danger">*</span></label>
                                    <input type="password" class="form-control" id="currentPasswordEmail" name="currentPasswordEmail" required>
                                </div>
                                <div class="d-flex justify-content-end gap-2">
                                    <button type="button" class="btn btn-outline-secondary" onclick="toggleEmailFormVisibility()">
                                        <i class="bi bi-x me-1"></i>‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                                    </button>
                                    <button type="submit" class="btn btn-primary" id="changeEmailBtn">
                                        <i class="bi bi-check-circle me-1"></i>‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏≠‡∏µ‡πÄ‡∏°‡∏•
                                    </button>
                                </div>
                            </form>
                        </div>

                        <!-- Change Password Form -->
                        <div id="changePasswordForm" style="display: none;">
                            <div class="alert alert-warning">
                                <i class="bi bi-shield-exclamation me-2"></i>
                                ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏à‡∏∞‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏≠‡∏∑‡πà‡∏ô
                            </div>
                            <form>
                                <div class="mb-3">
                                    <label for="currentPassword" class="form-label">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô <span class="text-danger">*</span></label>
                                    <input type="password" class="form-control" id="currentPassword" name="currentPassword" required>
                                </div>
                                <div class="mb-3">
                                    <label for="newPassword" class="form-label">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà <span class="text-danger">*</span></label>
                                    <input type="password" class="form-control" id="newPassword" name="newPassword" required>
                                    <div class="password-strength mt-2">
                                        <div class="progress" style="height: 5px;">
                                            <div class="progress-bar" id="passwordStrengthBar" style="width: 0%"></div>
                                        </div>
                                        <small class="text-muted" id="passwordStrengthText">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏Å‡∏£‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</small>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="confirmPassword" class="form-label">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà <span class="text-danger">*</span></label>
                                    <input type="password" class="form-control" id="confirmPassword" name="confirmPassword" required>
                                </div>
                                <div class="d-flex justify-content-end gap-2">
                                    <button type="button" class="btn btn-outline-secondary" onclick="togglePasswordFormVisibility()">
                                        <i class="bi bi-x me-1"></i>‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                                    </button>
                                    <button type="submit" class="btn btn-primary" id="changePasswordBtn">
                                        <i class="bi bi-check-circle me-1"></i>‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="col-lg-4">
                <!-- App Navigation -->
                <div class="card settings-card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-grid-3x3-gap me-2"></i>
                            ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏≠‡∏õ‡∏û‡∏•‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-2">
                            <div class="col-6">
                                <button type="button" class="btn btn-outline-info w-100 btn-sm" onclick="navigateToPage('chat.html')">
                                    <i class="bi bi-chat-dots d-block"></i>
                                    <small>‡πÅ‡∏ä‡∏ó</small>
                                </button>
                            </div>
                            <div class="col-6">
                                <button type="button" class="btn btn-outline-info w-100 btn-sm" onclick="navigateToPage('neko-chat.html')">
                                    <i class="bi bi-robot d-block"></i>
                                    <small>Neko AI</small>
                                </button>
                            </div>
                            <div class="col-6">
                                <button type="button" class="btn btn-outline-info w-100 btn-sm" onclick="navigateToPage('diary.html')">
                                    <i class="bi bi-journal-text d-block"></i>
                                    <small>‡πÑ‡∏î‡∏≠‡∏≤‡∏£‡∏µ‡πà</small>
                                </button>
                            </div>
                            <div class="col-6">
                                <button type="button" class="btn btn-outline-info w-100 btn-sm" onclick="navigateToPage('todo.html')">
                                    <i class="bi bi-list-check d-block"></i>
                                    <small>Todo</small>
                                </button>
                            </div>
                            <div class="col-6">
                                <button type="button" class="btn btn-outline-info w-100 btn-sm" onclick="navigateToPage('pomodoro.html')">
                                    <i class="bi bi-stopwatch d-block"></i>
                                    <small>Pomodoro</small>
                                </button>
                            </div>
                            <div class="col-6">
                                <button type="button" class="btn btn-outline-info w-100 btn-sm" onclick="navigateToPage('math.html')">
                                    <i class="bi bi-calculator d-block"></i>
                                    <small>Math</small>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Partner Information -->
                <div class="card settings-card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-heart me-2"></i>
                            ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏π‡πà‡∏£‡∏±‡∏Å
                        </h5>
                    </div>
                    <div class="card-body text-center">
                        <div id="partnerInfo">
                            <i class="bi bi-heart-break display-6 text-muted mb-3"></i>
                            <p class="text-muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏π‡πà‡∏£‡∏±‡∏Å</p>
                            <button class="btn btn-primary btn-sm">
                                <i class="bi bi-plus me-1"></i>‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏£‡∏±‡∏Å
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Quick Info -->
                <div class="card settings-card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-info-circle me-2"></i>
                            ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="info-row">
                            <span><i class="bi bi-gender-ambiguous me-2"></i>‡πÄ‡∏û‡∏®:</span>
                            <span id="userGender">‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏</span>
                        </div>
                        <div class="info-row">
                            <span><i class="bi bi-telephone me-2"></i>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£:</span>
                            <span id="userPhone">‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏</span>
                        </div>
                        <div class="info-row">
                            <span><i class="bi bi-cake me-2"></i>‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î:</span>
                            <span id="userBirthDate">‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏</span>
                        </div>
                        <div class="info-row">
                            <span><i class="bi bi-globe me-2"></i>‡πÄ‡∏Ç‡∏ï‡πÄ‡∏ß‡∏•‡∏≤:</span>
                            <span id="userTimezone">‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏ó‡∏¢</span>
                        </div>
                        <div class="info-row">
                            <span><i class="bi bi-translate me-2"></i>‡∏†‡∏≤‡∏©‡∏≤:</span>
                            <span id="userLanguage">‡πÑ‡∏ó‡∏¢</span>
                        </div>
                    </div>
                </div>

                <!-- Danger Zone -->
                <div class="card settings-card">
                    <div class="card-header bg-danger">
                        <h5 class="mb-0 text-white">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            ‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="danger-zone">
                            <h6 class="text-danger">‡∏•‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</h6>
                            <p class="text-muted small mb-3">‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ñ‡∏≤‡∏ß‡∏£</p>
                            <button class="btn btn-outline-danger w-100" id="deleteAccountBtn">
                                <i class="bi bi-trash me-2"></i>‡∏•‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Neko API Helper -->
    <script src="../assets/js/neko-api.js"></script>
    <script src="../assets/js/auth-guard.js"></script>
    
    <script>
        // Initialize auth guard to protect this page
        authGuard.protectPage();

        // Get current user for settings page
        let currentUser = nekoAPI.getCurrentUser();
        
        // Toast notification functions
        function showError(message) {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #dc3545;
                color: white;
                padding: 15px 20px;
                border-radius: 10px;
                z-index: 9999;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            `;
            toast.innerHTML = `<i class="bi bi-exclamation-circle me-2"></i>${message}`;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 5000);
        }

        function showSuccess(message) {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #28a745;
                color: white;
                padding: 15px 20px;
                border-radius: 10px;
                z-index: 9999;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            `;
            toast.innerHTML = `<i class="bi bi-check-circle me-2"></i>${message}`;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // Enhanced Neko Helper Class for Settings Page
        class NekoUHelper {
            constructor() {
                this.currentUser = null;
                this.isInitialized = false;
            }

            // Initialize helper with user data
            async initialize() {
                try {
                    console.log('üîß Initializing NekoUHelper...');
                    const token = nekoAPI.getToken();
                    const user = nekoAPI.getCurrentUser();
                    
                    console.log('üîë Token found:', !!token);
                    console.log('üë§ User found:', !!user);
                    
                    if (token && user) {
                        this.currentUser = user;
                        this.isInitialized = true;
                        console.log('‚úÖ Helper initialized successfully with user:', user.username || user.email);
                        return true;
                    }
                    
                    console.log('‚ùå Helper initialization failed - missing token or user');
                    return false;
                } catch (error) {
                    console.error('‚ùå Helper initialization error:', error);
                    return false;
                }
            }

            // Get current user ID
            getCurrentUserId() {
                return this.currentUser?.id || null;
            }

            // Check if user is authenticated
            isAuthenticated() {
                return this.isInitialized && this.currentUser && nekoAPI.getToken();
            }

            // Chat helpers
            async sendMessage(receiverId, content) {
                if (!this.isAuthenticated()) {
                    return { success: false, message: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô' };
                }

                try {
                    const result = await nekoAPI.request('/api/messages', {
                        method: 'POST',
                        body: JSON.stringify({
                            receiverId,
                            content,
                            type: 'text'
                        })
                    });
                    return result;
                } catch (error) {
                    return { success: false, message: error.message };
                }
            }

            async getMessages(partnerId, limit = 50) {
                if (!this.isAuthenticated()) {
                    return { success: false, message: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô' };
                }

                try {
                    const result = await nekoAPI.request(`/api/messages?partnerId=${partnerId}&limit=${limit}`, {
                        method: 'GET'
                    });
                    return result;
                } catch (error) {
                    return { success: false, message: error.message };
                }
            }

            // Diary helpers
            async createDiary(title, content, isPrivate = true) {
                if (!this.isAuthenticated()) {
                    return { success: false, message: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô' };
                }

                try {
                    const result = await nekoAPI.request('/api/diaries', {
                        method: 'POST',
                        body: JSON.stringify({
                            title,
                            content,
                            isPrivate,
                            date: new Date().toISOString()
                        })
                    });
                    return result;
                } catch (error) {
                    return { success: false, message: error.message };
                }
            }

            async getDiaries(page = 1, limit = 10) {
                if (!this.isAuthenticated()) {
                    return { success: false, message: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô' };
                }

                try {
                    const result = await nekoAPI.request(`/api/diaries?page=${page}&limit=${limit}`, {
                        method: 'GET'
                    });
                    return result;
                } catch (error) {
                    return { success: false, message: error.message };
                }
            }

            // Todo helpers
            async createTodo(title, description = '', dueDate = null) {
                if (!this.isAuthenticated()) {
                    return { success: false, message: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô' };
                }

                try {
                    const result = await nekoAPI.request('/api/todos', {
                        method: 'POST',
                        body: JSON.stringify({
                            title,
                            description,
                            dueDate,
                            completed: false
                        })
                    });
                    return result;
                } catch (error) {
                    return { success: false, message: error.message };
                }
            }

            async getTodos() {
                if (!this.isAuthenticated()) {
                    return { success: false, message: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô' };
                }

                try {
                    const result = await nekoAPI.request('/api/todos', {
                        method: 'GET'
                    });
                    return result;
                } catch (error) {
                    return { success: false, message: error.message };
                }
            }

            async updateTodo(todoId, updates) {
                if (!this.isAuthenticated()) {
                    return { success: false, message: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô' };
                }

                try {
                    const result = await nekoAPI.request(`/api/todos/${todoId}`, {
                        method: 'PUT',
                        body: JSON.stringify(updates)
                    });
                    return result;
                } catch (error) {
                    return { success: false, message: error.message };
                }
            }

            // Pomodoro helpers
            async createPomodoroSession(duration = 25, type = 'work') {
                if (!this.isAuthenticated()) {
                    return { success: false, message: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô' };
                }

                try {
                    const result = await nekoAPI.request('/api/pomodoro/sessions', {
                        method: 'POST',
                        body: JSON.stringify({
                            duration: duration * 60, // Convert to seconds
                            type,
                            startTime: new Date().toISOString()
                        })
                    });
                    return result;
                } catch (error) {
                    return { success: false, message: error.message };
                }
            }

            async getPomodoroStats() {
                if (!this.isAuthenticated()) {
                    return { success: false, message: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô' };
                }

                try {
                    const result = await nekoAPI.request('/api/pomodoro/stats', {
                        method: 'GET'
                    });
                    return result;
                } catch (error) {
                    return { success: false, message: error.message };
                }
            }

            // Math helpers
            async saveMathProgress(topic, score, timeSpent) {
                if (!this.isAuthenticated()) {
                    return { success: false, message: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô' };
                }

                try {
                    const result = await nekoAPI.request('/api/math/progress', {
                        method: 'POST',
                        body: JSON.stringify({
                            topic,
                            score,
                            timeSpent,
                            date: new Date().toISOString()
                        })
                    });
                    return result;
                } catch (error) {
                    return { success: false, message: error.message };
                }
            }

            async getMathProgress() {
                if (!this.isAuthenticated()) {
                    return { success: false, message: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô' };
                }

                try {
                    const result = await nekoAPI.request('/api/math/progress', {
                        method: 'GET'
                    });
                    return result;
                } catch (error) {
                    return { success: false, message: error.message };
                }
            }

            // Utility functions
            formatDate(dateString) {
                const date = new Date(dateString);
                return date.toLocaleDateString('th-TH', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }

            formatRelativeTime(dateString) {
                const date = new Date(dateString);
                const now = new Date();
                const diffInSeconds = Math.floor((now - date) / 1000);

                if (diffInSeconds < 60) return '‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà';
                if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)} ‡∏ô‡∏≤‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß`;
                if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)} ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß`;
                if (diffInSeconds < 604800) return `${Math.floor(diffInSeconds / 86400)} ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß`;
                
                return this.formatDate(dateString);
            }

            // Notification helpers
            showNotification(title, message, type = 'info') {
                if (type === 'success') {
                    showSuccess(message);
                } else if (type === 'error') {
                    showError(message);
                } else {
                    // Create info notification
                    const toast = document.createElement('div');
                    toast.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: #17a2b8;
                        color: white;
                        padding: 15px 20px;
                        border-radius: 10px;
                        z-index: 9999;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                        animation: slideIn 0.3s ease;
                    `;
                    toast.innerHTML = `<i class="bi bi-info-circle me-2"></i>${message}`;
                    document.body.appendChild(toast);
                    setTimeout(() => toast.remove(), 3000);
                }
            }

            // Dashboard stats
            async getDashboardStats() {
                if (!this.isAuthenticated()) {
                    return { success: false, message: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô' };
                }

                try {
                    const [diaries, todos, messages, pomodoro] = await Promise.all([
                        this.getDiaries(1, 1).catch(() => ({ data: { total: 0 } })),
                        this.getTodos().catch(() => ({ data: [] })),
                        this.getMessages(this.currentUser?.partner?.id || null, 1).catch(() => ({ data: { total: 0 } })),
                        this.getPomodoroStats().catch(() => ({ data: { totalSessions: 0 } }))
                    ]);

                    return {
                        success: true,
                        data: {
                            diaryCount: diaries.data?.total || 0,
                            todoCount: Array.isArray(todos.data) ? todos.data.length : 0,
                            messageCount: messages.data?.total || 0,
                            pomodoroSessions: pomodoro.data?.totalSessions || 0
                        }
                    };
                } catch (error) {
                    return { success: false, message: error.message };
                }
            }
        }

        // Chat Management Functions
        class ChatManager {
            constructor() {
                this.messages = [];
                this.isConnected = false;
                this.typingTimeout = null;
            }

            async initializeChat() {
                try {
                    if (!currentUser || !currentUser.partner) {
                        console.log('‚ö†Ô∏è No partner found for chat');
                        return false;
                    }

                    // Load recent messages
                    const response = await nekoHelper.getMessages(currentUser.partner.id, 50);
                    if (response.success) {
                        this.messages = response.data.messages || [];
                        this.isConnected = true;
                        return true;
                    }

                    return false;
                } catch (error) {
                    console.error('‚ùå Chat initialization failed:', error);
                    return false;
                }
            }

            async sendMessage(content) {
                if (!currentUser.partner) {
                    throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏π‡πà‡∏£‡∏±‡∏Å');
                }

                const response = await nekoHelper.sendMessage(currentUser.partner.id, content);
                if (response.success) {
                    this.messages.push(response.data);
                    return response.data;
                }

                throw new Error(response.message);
            }

            formatMessage(message) {
                return {
                    id: message.id,
                    content: message.content,
                    sender: message.senderId === currentUser.id ? 'me' : 'partner',
                    timestamp: nekoHelper.formatRelativeTime(message.createdAt),
                    createdAt: message.createdAt
                };
            }
        }

        // Neko AI Chat Functions
        class NekoAIChat {
            constructor() {
                this.conversations = [];
                this.currentMood = 'happy';
                this.responses = {
                    greetings: [
                        "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ! ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£‡∏ö‡πâ‡∏≤‡∏á? üê±",
                        "‡∏´‡∏ß‡∏±‡∏î‡∏î‡∏µ~ ‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡πÉ‡∏´‡πâ‡πÄ‡∏ô‡πÇ‡∏Å‡∏∞‡∏ä‡πà‡∏ß‡∏¢‡πÑ‡∏´‡∏°? üíï",
                        "‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏à‡∏≠‡∏Å‡∏±‡∏ô! ‡∏≠‡∏¢‡∏≤‡∏Å‡∏Ñ‡∏∏‡∏¢‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡∏∞‡πÑ‡∏£? ‚ú®"
                    ],
                    encouragement: [
                        "‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏≥‡πÑ‡∏î‡πâ! ‡πÄ‡∏ô‡πÇ‡∏Å‡∏∞‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡∏Ñ‡∏∏‡∏ì üí™",
                        "‡∏≠‡∏¢‡πà‡∏≤‡∏ó‡πâ‡∏≠‡∏ô‡∏∞ ‡∏ó‡∏∏‡∏Å‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏ó‡∏≤‡∏á‡∏≠‡∏≠‡∏Å üåü",
                        "‡πÄ‡∏ô‡πÇ‡∏Å‡∏∞‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á‡∏Ç‡πâ‡∏≤‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏™‡∏°‡∏≠ üíñ"
                    ],
                    compliments: [
                        "‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏Å‡πà‡∏á‡∏°‡∏≤‡∏Å! ‡πÄ‡∏ô‡πÇ‡∏Å‡∏∞‡∏ä‡∏∑‡πà‡∏ô‡∏ä‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì üåà",
                        "‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∏‡∏ì‡∏î‡∏π‡∏î‡∏µ‡∏°‡∏≤‡∏Å‡πÄ‡∏•‡∏¢! ‚ú®",
                        "‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡∏ó‡∏µ‡πà‡∏¢‡∏≠‡∏î‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏à‡∏£‡∏¥‡∏á‡πÜ üéØ"
                    ],
                    general: [
                        "‡πÄ‡∏ô‡πÇ‡∏Å‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì üí≠",
                        "‡∏ô‡∏±‡πà‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ô‡πà‡∏≤‡∏™‡∏ô‡πÉ‡∏à‡∏°‡∏≤‡∏Å! ü§î",
                        "‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡πÅ‡∏ö‡πà‡∏á‡∏õ‡∏±‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏Å‡∏±‡∏ö‡πÄ‡∏ô‡πÇ‡∏Å‡∏∞ üíï"
                    ]
                };
            }

            async generateResponse(userMessage) {
                const message = userMessage.toLowerCase();
                
                // Simple AI response logic
                if (message.includes('‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ') || message.includes('‡∏´‡∏ß‡∏±‡∏î‡∏î‡∏µ') || message.includes('hello')) {
                    return this.getRandomResponse('greetings');
                }
                
                if (message.includes('‡πÄ‡∏®‡∏£‡πâ‡∏≤') || message.includes('‡∏ó‡πâ‡∏≠') || message.includes('‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢')) {
                    return this.getRandomResponse('encouragement');
                }
                
                if (message.includes('‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì') || message.includes('‡πÄ‡∏Å‡πà‡∏á') || message.includes('‡∏î‡∏µ')) {
                    return this.getRandomResponse('compliments');
                }
                
                return this.getRandomResponse('general');
            }

            getRandomResponse(category) {
                const responses = this.responses[category];
                return responses[Math.floor(Math.random() * responses.length)];
            }

            async saveConversation(userMessage, aiResponse) {
                try {
                    const conversation = {
                        userMessage,
                        aiResponse,
                        mood: this.currentMood,
                        timestamp: new Date().toISOString()
                    };

                    const result = await nekoAPI.request('/api/neko-chat/conversations', {
                        method: 'POST',
                        body: JSON.stringify(conversation)
                    });

                    if (result.success) {
                        this.conversations.push(conversation);
                    }

                    return result;
                } catch (error) {
                    console.error('‚ùå Failed to save conversation:', error);
                    return { success: false, message: error.message };
                }
            }
        }

        // Pomodoro Timer Class
        class PomodoroTimer {
            constructor() {
                this.timerInterval = null;
                this.timeLeft = 25 * 60; // 25 minutes in seconds
                this.isRunning = false;
                this.isBreak = false;
                this.sessionCount = 0;
                this.currentSession = null;
                
                this.WORK_TIME = 25 * 60; // 25 minutes
                this.SHORT_BREAK = 5 * 60; // 5 minutes  
                this.LONG_BREAK = 15 * 60; // 15 minutes
            }

            start() {
                if (this.isRunning) return;
                
                this.isRunning = true;
                this.createSession();
                
                this.timerInterval = setInterval(() => {
                    this.timeLeft--;
                    this.updateDisplay();
                    
                    if (this.timeLeft <= 0) {
                        this.complete();
                    }
                }, 1000);
            }

            pause() {
                this.isRunning = false;
                if (this.timerInterval) {
                    clearInterval(this.timerInterval);
                    this.timerInterval = null;
                }
            }

            reset() {
                this.pause();
                this.timeLeft = this.isBreak ? this.getBreakDuration() : this.WORK_TIME;
                this.updateDisplay();
            }

            complete() {
                this.pause();
                
                if (!this.isBreak) {
                    // Work session completed
                    this.sessionCount++;
                    this.saveSession();
                    
                    // Switch to break
                    this.isBreak = true;
                    this.timeLeft = this.getBreakDuration();
                    
                    nekoHelper.showNotification('Pomodoro Complete!', '‡πÄ‡∏ß‡∏•‡∏≤‡∏û‡∏±‡∏Å! ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢ üéâ', 'success');
                } else {
                    // Break completed
                    this.isBreak = false;
                    this.timeLeft = this.WORK_TIME;
                    
                    nekoHelper.showNotification('Break Over!', '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ô‡πÄ‡∏ñ‡∏≠‡∏∞! üí™', 'info');
                }
                
                this.updateDisplay();
            }

            getBreakDuration() {
                return this.sessionCount % 4 === 0 ? this.LONG_BREAK : this.SHORT_BREAK;
            }

            async createSession() {
                try {
                    const response = await nekoHelper.createPomodoroSession(
                        this.isBreak ? this.getBreakDuration() / 60 : 25,
                        this.isBreak ? 'break' : 'work'
                    );
                    
                    if (response.success) {
                        this.currentSession = response.data;
                    }
                } catch (error) {
                    console.error('‚ùå Failed to create pomodoro session:', error);
                }
            }

            async saveSession() {
                try {
                    if (this.currentSession) {
                        await nekoAPI.request(`/api/pomodoro/sessions/${this.currentSession.id}`, {
                            method: 'PUT',
                            body: JSON.stringify({
                                completed: true,
                                endTime: new Date().toISOString()
                            })
                        });
                    }
                } catch (error) {
                    console.error('‚ùå Failed to save pomodoro session:', error);
                }
            }

            updateDisplay() {
                const minutes = Math.floor(this.timeLeft / 60);
                const seconds = this.timeLeft % 60;
                const timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                // Update document title for browser tab
                document.title = `${timeString} - ${this.isBreak ? '‡∏û‡∏±‡∏Å' : '‡∏ó‡∏≥‡∏á‡∏≤‡∏ô'} | Neko U`;
                
                console.log(`‚è∞ Timer: ${timeString} (${this.isBreak ? 'Break' : 'Work'})`);
            }

            formatTime(seconds) {
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            }
        }

        // Todo Manager Class
        class TodoManager {
            constructor() {
                this.todos = [];
            }

            async loadTodos() {
                try {
                    const response = await nekoHelper.getTodos();
                    if (response.success) {
                        this.todos = response.data;
                        return this.todos;
                    }
                    return [];
                } catch (error) {
                    console.error('‚ùå Failed to load todos:', error);
                    return [];
                }
            }

            async addTodo(title, description = '', dueDate = null) {
                try {
                    const response = await nekoHelper.createTodo(title, description, dueDate);
                    if (response.success) {
                        this.todos.push(response.data);
                        return response.data;
                    }
                    throw new Error(response.message);
                } catch (error) {
                    console.error('‚ùå Failed to add todo:', error);
                    throw error;
                }
            }

            async updateTodo(todoId, updates) {
                try {
                    const response = await nekoHelper.updateTodo(todoId, updates);
                    if (response.success) {
                        const index = this.todos.findIndex(todo => todo.id === todoId);
                        if (index !== -1) {
                            this.todos[index] = { ...this.todos[index], ...updates };
                        }
                        return response.data;
                    }
                    throw new Error(response.message);
                } catch (error) {
                    console.error('‚ùå Failed to update todo:', error);
                    throw error;
                }
            }

            async deleteTodo(todoId) {
                try {
                    const response = await nekoAPI.request(`/api/todos/${todoId}`, {
                        method: 'DELETE'
                    });
                    
                    if (response.success) {
                        this.todos = this.todos.filter(todo => todo.id !== todoId);
                        return true;
                    }
                    throw new Error(response.message);
                } catch (error) {
                    console.error('‚ùå Failed to delete todo:', error);
                    throw error;
                }
            }

            getCompletedCount() {
                return this.todos.filter(todo => todo.completed).length;
            }

            getPendingCount() {
                return this.todos.filter(todo => !todo.completed).length;
            }
        }

        // Math Progress Tracker
        class MathTracker {
            constructor() {
                this.currentScore = 0;
                this.currentTopic = null;
                this.startTime = null;
            }

            startSession(topic) {
                this.currentTopic = topic;
                this.currentScore = 0;
                this.startTime = new Date();
            }

            addScore(points) {
                this.currentScore += points;
            }

            async endSession() {
                if (!this.currentTopic || !this.startTime) return false;

                const timeSpent = Math.floor((new Date() - this.startTime) / 1000);
                
                try {
                    const response = await nekoHelper.saveMathProgress(
                        this.currentTopic,
                        this.currentScore,
                        timeSpent
                    );
                    
                    if (response.success) {
                        nekoHelper.showNotification(
                            'Math Session Complete!',
                            `‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: ${this.currentScore} | ‡πÄ‡∏ß‡∏•‡∏≤: ${Math.floor(timeSpent / 60)} ‡∏ô‡∏≤‡∏ó‡∏µ`,
                            'success'
                        );
                        return true;
                    }
                    return false;
                } catch (error) {
                    console.error('‚ùå Failed to save math progress:', error);
                    return false;
                }
            }

            async getProgress() {
                try {
                    const response = await nekoHelper.getMathProgress();
                    return response.success ? response.data : [];
                } catch (error) {
                    console.error('‚ùå Failed to get math progress:', error);
                    return [];
                }
            }
        }

        // Diary Manager Class
        class DiaryManager {
            constructor() {
                this.diaries = [];
            }

            async loadDiaries(page = 1, limit = 10) {
                try {
                    const response = await nekoHelper.getDiaries(page, limit);
                    if (response.success) {
                        this.diaries = response.data.diaries || [];
                        return {
                            diaries: this.diaries,
                            total: response.data.total || 0,
                            page: response.data.page || 1
                        };
                    }
                    return { diaries: [], total: 0, page: 1 };
                } catch (error) {
                    console.error('‚ùå Failed to load diaries:', error);
                    return { diaries: [], total: 0, page: 1 };
                }
            }

            async createDiary(title, content, isPrivate = true) {
                try {
                    const response = await nekoHelper.createDiary(title, content, isPrivate);
                    if (response.success) {
                        this.diaries.unshift(response.data);
                        return response.data;
                    }
                    throw new Error(response.message);
                } catch (error) {
                    console.error('‚ùå Failed to create diary:', error);
                    throw error;
                }
            }

            async updateDiary(diaryId, updates) {
                try {
                    const response = await nekoAPI.request(`/api/diaries/${diaryId}`, {
                        method: 'PUT',
                        body: JSON.stringify(updates)
                    });
                    
                    if (response.success) {
                        const index = this.diaries.findIndex(diary => diary.id === diaryId);
                        if (index !== -1) {
                            this.diaries[index] = { ...this.diaries[index], ...updates };
                        }
                        return response.data;
                    }
                    throw new Error(response.message);
                } catch (error) {
                    console.error('‚ùå Failed to update diary:', error);
                    throw error;
                }
            }

            async deleteDiary(diaryId) {
                try {
                    const response = await nekoAPI.request(`/api/diaries/${diaryId}`, {
                        method: 'DELETE'
                    });
                    
                    if (response.success) {
                        this.diaries = this.diaries.filter(diary => diary.id !== diaryId);
                        return true;
                    }
                    throw new Error(response.message);
                } catch (error) {
                    console.error('‚ùå Failed to delete diary:', error);
                    throw error;
                }
            }
        }

        // Function to fetch fresh user data from API and update localStorage
        async function fetchAndUpdateUserData() {
            try {
                console.log('üîÑ Fetching fresh user data from API...');
                const token = nekoAPI.getToken();
                if (!token) {
                    console.log('‚ùå No token found');
                    return null;
                }

                // Get current user from localStorage first
                let user = nekoAPI.getCurrentUser();
                if (!user || !user.id) {
                    console.log('‚ùå No user ID found in localStorage');
                    return null;
                }

                console.log('üìã Attempting to fetch user data for ID:', user.id);
                
                // Test API connectivity first
                try {
                    const testResponse = await fetch(`${nekoAPI.baseURL}/api/health`, {
                        method: 'GET',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    console.log('üè• API Health check:', testResponse.status);
                } catch (healthError) {
                    console.log('‚ö†Ô∏è API health check failed:', healthError.message);
                }

                // Fetch fresh data from API
                const response = await nekoAPI.getUser(user.id);
                console.log('üìä API Response for user data:', response);
                
                if (response && response.success && response.user) {
                    console.log('‚úÖ Fresh user data received:', response.user);
                    
                    // Update localStorage with fresh data
                    nekoAPI.updateCurrentUser(response.user);
                    console.log('‚úÖ localStorage updated with fresh data');
                    
                    return response.user;
                } else if (response && response.user) {
                    // Some APIs might not use 'success' flag
                    console.log('‚úÖ User data received (alternative format):', response.user);
                    nekoAPI.updateCurrentUser(response.user);
                    return response.user;
                } else {
                    console.log('‚ùå Failed to fetch user data:', response);
                    console.log('üìã Using cached user data as fallback');
                    return user; // Return cached data as fallback
                }
            } catch (error) {
                console.error('‚ùå Error fetching user data:', error);
                console.log('üìã Using cached user data as fallback');
                return nekoAPI.getCurrentUser(); // Return cached data as fallback
            }
        }

        // Development helper function to simulate login (for testing)
        function simulateLogin() {
            console.log('üß™ Simulating login for development testing...');
            
            // Mock user data
            const mockUser = {
                id: 'test-user-123',
                username: 'testuser',
                email: 'test@example.com',
                displayName: 'Test User',
                createdAt: new Date().toISOString(),
                partner: null
            };
            
            // Mock JWT token (this is just for testing - in real app this comes from login API)
            const mockToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0LXVzZXItMTIzIiwibmFtZSI6IlRlc3QgVXNlciIsImlhdCI6MTYxNjIzOTAyMn0.test-signature';
            
            // Save to localStorage
            nekoAPI.setToken(mockToken);
            nekoAPI.setCurrentUser(mockUser);
            
            console.log('‚úÖ Mock login data saved to localStorage');
            console.log('üîÑ Reloading page to test authentication...');
            
            // Reload page to test the auth flow
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        }

        // Function to inspect current auth state (for debugging)
        function inspectAuthState() {
            console.log('üîç === CURRENT AUTH STATE INSPECTION ===');
            
            // Check localStorage
            console.log('üíæ localStorage:');
            console.log('  - nekouToken:', localStorage.getItem('nekouToken') || 'not found');
            console.log('  - nekouUser:', localStorage.getItem('nekouUser') || 'not found');
            
            // Check cookies (for comparison)
            console.log('üç™ Cookies:');
            const cookies = document.cookie.split(';');
            cookies.forEach(cookie => {
                const [name, value] = cookie.trim().split('=');
                if (name === 'nekouToken' || name === 'nekouUser') {
                    console.log(`  - ${name}:`, value || 'empty');
                }
            });
            
            // Test nekoAPI methods
            console.log('üîß nekoAPI methods:');
            console.log('  - getToken():', nekoAPI.getToken());
            console.log('  - getCurrentUser():', nekoAPI.getCurrentUser());
            
            // Auth status
            if (typeof checkAuthenticationStatus === 'function') {
                console.log('üîç Auth check result:', checkAuthenticationStatus());
            }
        }

        // Make dev functions globally available (remove in production)
        window.simulateLogin = simulateLogin;
        window.inspectAuthState = inspectAuthState;

        // Show login required alert with clear instructions
        function showLoginRequiredAlert() {
            console.log('üö® Showing login required alert...');
            
            // Create a more prominent alert
            const alertDiv = document.createElement('div');
            alertDiv.id = 'loginRequiredAlert';
            alertDiv.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                padding: 30px;
                border-radius: 15px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                z-index: 10000;
                text-align: center;
                max-width: 450px;
                border: 3px solid #ffc107;
            `;
            
            alertDiv.innerHTML = `
                <div style="color: #ffc107; font-size: 48px; margin-bottom: 15px;">‚ö†Ô∏è</div>
                <h4 style="color: #856404; margin-bottom: 15px;">‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h4>
                <p style="margin-bottom: 20px; color: #666;">
                    ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡∏ß‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏<br>
                    ‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠?<br>
                    <small style="color: #999; margin-top: 10px; display: block;">
                        üí° ‡πÄ‡∏Ñ‡∏•‡πá‡∏î‡∏•‡∏±‡∏ö: ‡∏•‡∏≠‡∏á‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
                    </small>
                </p>
                <div style="display: flex; gap: 8px; margin-top: 20px;">
                    <button onclick="tryAgain()" style="
                        background: #17a2b8;
                        color: white;
                        border: none;
                        padding: 10px 16px;
                        border-radius: 8px;
                        font-size: 14px;
                        cursor: pointer;
                        flex: 1;
                    ">
                        ‡∏•‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠
                    </button>
                    <button onclick="clearAndTryAgain()" style="
                        background: #6c757d;
                        color: white;
                        border: none;
                        padding: 10px 16px;
                        border-radius: 8px;
                        font-size: 14px;
                        cursor: pointer;
                        flex: 1;
                    ">
                        ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤
                    </button>
                    <button onclick="simulateLogin()" style="
                        background: #28a745;
                        color: white;
                        border: none;
                        padding: 10px 16px;
                        border-radius: 8px;
                        font-size: 14px;
                        cursor: pointer;
                        flex: 1;
                    ">
                        ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö
                    </button>
                    <button onclick="goToLogin()" style="
                        background: #ffc107;
                        color: #212529;
                        border: none;
                        padding: 10px 16px;
                        border-radius: 8px;
                        font-size: 14px;
                        cursor: pointer;
                        flex: 1;
                    ">
                        ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà
                    </button>
                </div>
                <p style="margin-top: 15px; font-size: 12px; color: #999;">
                    ‡∏à‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÉ‡∏ô‡∏≠‡∏µ‡∏Å <span id="countdown">30</span> ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
                </p>
            `;
            
            document.body.appendChild(alertDiv);
            
            // Countdown timer
            let countdown = 30;
            const countdownEl = document.getElementById('countdown');
            const countdownInterval = setInterval(() => {
                countdown--;
                if (countdownEl) {
                    countdownEl.textContent = countdown;
                }
                if (countdown <= 0) {
                    clearInterval(countdownInterval);
                    goToLogin();
                }
            }, 1000);
            
            // Store interval for cleanup
            alertDiv.countdownInterval = countdownInterval;
        }

        // Try to continue using the app
        function tryAgain() {
            console.log('üîÑ User chose to try again...');
            const alertDiv = document.getElementById('loginRequiredAlert');
            if (alertDiv) {
                if (alertDiv.countdownInterval) {
                    clearInterval(alertDiv.countdownInterval);
                }
                alertDiv.remove();
            }
            
            // Try to reload the page
            window.location.reload();
        }

        // Clear corrupted data and try again
        function clearAndTryAgain() {
            console.log('üßπ User chose to clear corrupted data and try again...');
            const alertDiv = document.getElementById('loginRequiredAlert');
            if (alertDiv) {
                if (alertDiv.countdownInterval) {
                    clearInterval(alertDiv.countdownInterval);
                }
                alertDiv.remove();
            }
            
            // Clear all authentication data
            console.log('üßπ Clearing all authentication data...');
            nekoAPI.clearCorruptedData();
            
            // Also clear any remaining cookies for good measure
            document.cookie = 'nekouToken=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/;';
            document.cookie = 'nekouUser=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/;';
            
            // Show success message
            showSuccess('‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà...');
            
            // Reload after short delay
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        }

        // Show placeholder content when user data is not available
        function showPlaceholderContent() {
            console.log('üìã Showing placeholder content...');
            
            // Update user display elements with placeholder text
            const userDisplayName = document.getElementById('userDisplayName');
            if (userDisplayName) {
                userDisplayName.textContent = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ';
            }
            
            const userEmail = document.getElementById('userEmail');
            if (userEmail) {
                userEmail.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà';
            }
            
            const userUsername = document.getElementById('userUsername');
            if (userUsername) {
                userUsername.textContent = '-';
            }
            
            const userJoinDate = document.getElementById('userJoinDate');
            if (userJoinDate) {
                userJoinDate.textContent = '-';
            }
            
            // Show info notification
            showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ ‡∏ö‡∏≤‡∏á‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏≠‡∏≤‡∏à‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ');
            
            // Show login alert after a delay
            setTimeout(() => {
                showLoginRequiredAlert();
            }, 2000);
        }

        // Function to go to login page
        function goToLogin() {
            console.log('üö™ Redirecting to login page...');
            nekoAPI.clearCorruptedData();
            window.location.href = 'index.html';
        }

        // Navigation functions
        function navigateToPage(pageName) {
            const token = nekoAPI.getToken();
            const user = nekoAPI.getCurrentUser();
            
            if (!token || !user) {
                showLoginRequiredAlert();
                return;
            }
            
            window.location.href = pageName;
        }

        // Logout function
        function handleLogout() {
            if (confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                nekoAPI.logout();
            }
        }

        // Make functions globally available
        window.goToLogin = goToLogin;
        window.navigateToPage = navigateToPage;
        window.handleLogout = handleLogout;
        window.showLoginRequiredAlert = showLoginRequiredAlert;
        window.tryAgain = tryAgain;
        window.clearAndTryAgain = clearAndTryAgain;
        window.showPlaceholderContent = showPlaceholderContent;
    </script>
    
    <script>
        // Initialize settings page
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                console.log('üöÄ === SETTINGS PAGE INITIALIZATION START ===');
                
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö nekoAPI
                if (typeof nekoAPI === 'undefined') {
                    alert('‚ùå nekoAPI ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡πÇ‡∏´‡∏•‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£ include script ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà');
                    console.error('nekoAPI is undefined.');
                    return;
                }
                console.log('‚úÖ nekoAPI loaded successfully');
                
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö token ‡πÅ‡∏•‡∏∞ localStorage ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                const token = nekoAPI.getToken();
                const cachedUser = nekoAPI.getCurrentUser();
                console.log('üîë Token status:', token ? 'EXISTS' : 'NOT_FOUND');
                console.log('ÔøΩ Token preview:', token ? token.substring(0, 20) + '...' : 'null');
                console.log('ÔøΩüë§ Cached user:', cachedUser);
                
                if (!token || !cachedUser || !cachedUser.id) {
                    console.log('‚ö†Ô∏è Authentication data missing or invalid');
                    console.log('‚ö†Ô∏è Token:', !!token);
                    console.log('‚ö†Ô∏è CachedUser:', !!cachedUser);
                    console.log('‚ö†Ô∏è User ID:', cachedUser?.id);
                    
                    // Show user-friendly alert instead of immediate redirect
                    showLoginRequiredAlert();
                    return;
                }
                
                console.log('‚úÖ Authentication check passed');
                console.log('üöÄ Starting settings page initialization...');
                
                // Show loading indicator
                showLoadingStatus(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ...');
                
                // Fetch fresh user data from API
                console.log('üì° Fetching fresh user data...');
                currentUser = await fetchAndUpdateUserData();
                console.log('üìã Current user after fetch:', currentUser);
                
                if (!currentUser || !currentUser.id) {
                    console.error('‚ùå Failed to get user data');
                    console.log('‚ö†Ô∏è Will show placeholder content instead of failing');
                    
                    // Show placeholder content instead of error
                    showPlaceholderContent();
                    return;
                }
                
                console.log('‚úÖ User data loaded successfully');
                console.log('üîÑ Updating UI with fresh user data...');
                
                // Setup UI first
                console.log('‚öôÔ∏è Setting up UI...');
                setupSettingsUI();
                
                // Test API endpoints
                console.log('üß™ Testing API endpoints...');
                await testApiEndpoints();
                
                // Debug: Show current user data
                console.log('üîç Running user debug...');
                debugCurrentUser();
                
                // Update user info in overview card and sidebar
                console.log('üìä Updating user overview...');
                updateNavigationBar();
                updateUserOverview();
                updateQuickInfo();
                
                // Load current settings (forms, partner, etc.)
                console.log('üìù Loading user settings...');
                await loadUserSettings();
                
                // Initialize all application managers
                console.log('üèóÔ∏è Initializing application managers...');
                await initializeAllManagers();
                
                // Hide loading indicator
                showLoadingStatus(false);
                
                console.log('‚úÖ === SETTINGS PAGE INITIALIZATION COMPLETED ===');
            } catch (error) {
                console.error('‚ùå === SETTINGS INITIALIZATION ERROR ===');
                console.error('Error details:', error);
                console.error('Stack trace:', error.stack);
                showLoadingStatus(false);
                
                if (typeof nekoAPI !== 'undefined' && nekoAPI.showError) {
                    showError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤: ' + error.message);
                } else {
                    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤: ' + error.message);
                }
            }
        });

        // App initialization and managers consolidation
        let nekoHelper, chatManager, nekoAIChat, pomodoroTimer, todoManager, mathTracker, diaryManager;

        async function initializeAllManagers() {
            try {
                console.log('üöÄ Initializing all application managers...');
                
                // Initialize NekoU Helper
                if (typeof NekoUHelper !== 'undefined') {
                    nekoHelper = new NekoUHelper();
                    console.log('‚úÖ NekoU Helper initialized');
                }
                
                // Initialize Chat Manager  
                if (typeof ChatManager !== 'undefined') {
                    chatManager = new ChatManager();
                    console.log('‚úÖ Chat Manager initialized');
                }
                
                // Initialize Neko AI Chat
                if (typeof NekoAIChat !== 'undefined') {
                    nekoAIChat = new NekoAIChat();
                    console.log('‚úÖ Neko AI Chat initialized');
                }
                
                // Initialize Pomodoro Timer
                if (typeof PomodoroTimer !== 'undefined') {
                    pomodoroTimer = new PomodoroTimer();
                    console.log('‚úÖ Pomodoro Timer initialized');
                }
                
                // Initialize Todo Manager
                if (typeof TodoManager !== 'undefined') {
                    todoManager = new TodoManager();
                    console.log('‚úÖ Todo Manager initialized');
                }
                
                // Initialize Math Tracker
                if (typeof MathTracker !== 'undefined') {
                    mathTracker = new MathTracker();
                    console.log('‚úÖ Math Tracker initialized');
                }
                
                // Initialize Diary Manager
                if (typeof DiaryManager !== 'undefined') {
                    diaryManager = new DiaryManager();
                    console.log('‚úÖ Diary Manager initialized');
                }
                
                // Load initial data
                await loadAllInitialData();
                
                console.log('üéâ All managers initialized successfully!');
            } catch (error) {
                console.error('‚ùå Failed to initialize managers:', error);
                showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö', 'error');
            }
        }

        async function loadAllInitialData() {
            try {
                console.log('üìä Loading initial data from all managers...');
                
                // Load data in parallel for better performance
                const loadPromises = [];
                
                if (diaryManager && typeof diaryManager.loadDiaries === 'function') {
                    loadPromises.push(diaryManager.loadDiaries(1, 5).catch(error => {
                        console.warn('‚ö†Ô∏è Could not load diary data:', error);
                        return null;
                    }));
                }
                
                if (todoManager && typeof todoManager.loadTodos === 'function') {
                    loadPromises.push(todoManager.loadTodos().catch(error => {
                        console.warn('‚ö†Ô∏è Could not load todo data:', error);
                        return null;
                    }));
                }
                
                if (chatManager && typeof chatManager.initializeChat === 'function' && currentUser.partner) {
                    loadPromises.push(chatManager.initializeChat().catch(error => {
                        console.warn('‚ö†Ô∏è Could not load chat data:', error);
                        return null;
                    }));
                }
                
                // Wait for all data to load
                await Promise.all(loadPromises);
                
                // Update quick stats with real data
                setTimeout(() => {
                    updateQuickStats();
                }, 1000);
                
                console.log('‚úÖ Initial data loaded successfully');
            } catch (error) {
                console.error('‚ùå Failed to load initial data:', error);
            }
        }
        
        function showLoadingStatus(show, message = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...') {
            const loadingStatus = document.getElementById('loadingStatus');
            if (loadingStatus) {
                if (show) {
                    const span = loadingStatus.querySelector('span');
                    if (span) span.textContent = message;
                    loadingStatus.style.display = 'block';
                } else {
                    loadingStatus.style.display = 'none';
                }
            }
        }
        
        // Test API endpoints individually
        async function testApiEndpoints() {
            console.log('üß™ Testing API endpoints...');
            
            if (!currentUser || !currentUser.id) {
                console.log('‚ùå No current user for testing');
                return;
            }
            
            const token = nekoAPI.getToken();
            console.log('üîë Token exists:', !!token);
            console.log('üîë Token preview:', token ? token.substring(0, 20) + '...' : 'null');
            
            // Test user data endpoint
            try {
                console.log('üß™ Testing GET /api/users/' + currentUser.id);
                const userResponse = await nekoAPI.getUser(currentUser.id);
                console.log('üë§ User data test result:', userResponse);
            } catch (error) {
                console.log('‚ùå User data test failed:', error.message);
            }
            
            // Test preferences endpoint
            try {
                console.log('üß™ Testing GET /api/users/' + currentUser.id + '/preferences');
                const prefsResponse = await nekoAPI.getUserPreferences(currentUser.id);
                console.log('‚öôÔ∏è Preferences test result:', prefsResponse);
            } catch (error) {
                console.log('‚ùå Preferences test failed:', error.message);
            }
        }
        
        function debugCurrentUser() {
            console.log('üîç === USER DEBUG INFO ===');
            console.log('üìä currentUser object:', currentUser);
            
            if (currentUser) {
                console.log('üìù User properties:');
                Object.keys(currentUser).forEach(key => {
                    console.log(`   ${key}:`, currentUser[key]);
                });
            } else {
                console.log('‚ùå No currentUser data');
            }
            
            // Check cookies
            console.log('üç™ Cookies:');
            console.log('   nekouUser:', nekoAPI.getCookie('nekouUser'));
            console.log('   nekouToken:', nekoAPI.getCookie('nekouToken') ? 'EXISTS' : 'NOT_FOUND');
            
            console.log('üîç === END DEBUG INFO ===');
        }
        
        function setupSettingsUI() {
            // Setup profile update form
            const profileForm = document.getElementById('updateProfileForm');
            if (profileForm) {
                profileForm.addEventListener('submit', handleUpdateProfile);
            }
            
            // Setup preferences form
            const preferencesForm = document.getElementById('preferencesForm');
            if (preferencesForm) {
                preferencesForm.addEventListener('submit', handleUpdatePreferences);
            }
            
            // Setup edit profile buttons
            const editBasicProfileBtn = document.getElementById('editBasicProfileBtn');
            const saveBasicProfileBtn = document.getElementById('saveBasicProfileBtn');
            const cancelBasicProfileBtn = document.getElementById('cancelBasicProfileBtn');
            
            if (editBasicProfileBtn) {
                editBasicProfileBtn.addEventListener('click', () => toggleEditMode('basic', true));
            }
            if (saveBasicProfileBtn) {
                saveBasicProfileBtn.addEventListener('click', handleUpdateProfile);
            }
            if (cancelBasicProfileBtn) {
                cancelBasicProfileBtn.addEventListener('click', () => {
                    toggleEditMode('basic', false);
                    // Reset form to original values
                    loadUserSettings();
                });
            }
            
            // Setup preferences buttons
            const editPreferencesBtn = document.getElementById('editPreferencesBtn');
            const savePreferencesBtn = document.getElementById('savePreferencesBtn');
            const cancelPreferencesBtn = document.getElementById('cancelPreferencesBtn');
            
            if (editPreferencesBtn) {
                editPreferencesBtn.addEventListener('click', () => toggleEditMode('preferences', true));
            }
            if (savePreferencesBtn) {
                savePreferencesBtn.addEventListener('click', handleUpdatePreferences);
            }
            if (cancelPreferencesBtn) {
                cancelPreferencesBtn.addEventListener('click', () => {
                    toggleEditMode('preferences', false);
                    // Reset form to original values
                    loadUserPreferences();
                });
            }
            
            // Setup password and email change forms
            const changePasswordForm = document.getElementById('changePasswordForm')?.querySelector('form');
            const changeEmailForm = document.getElementById('changeEmailForm')?.querySelector('form');
            
            if (changePasswordForm) {
                changePasswordForm.addEventListener('submit', handleChangePassword);
            }
            if (changeEmailForm) {
                changeEmailForm.addEventListener('submit', handleChangeEmail);
            }
            
            // Setup password and email change buttons
            const editPasswordBtn = document.getElementById('editPasswordBtn');
            const editEmailBtn = document.getElementById('editEmailBtn');
            
            if (editPasswordBtn) {
                editPasswordBtn.addEventListener('click', () => {
                    const form = document.getElementById('changePasswordForm');
                    if (form) form.style.display = form.style.display === 'none' ? 'block' : 'none';
                });
            }
            
            if (editEmailBtn) {
                editEmailBtn.addEventListener('click', () => {
                    const form = document.getElementById('changeEmailForm');
                    if (form) form.style.display = form.style.display === 'none' ? 'block' : 'none';
                });
            }
            
            // Setup password strength indicator
            const newPasswordInput = document.getElementById('newPassword');
            if (newPasswordInput) {
                newPasswordInput.addEventListener('input', updatePasswordStrength);
            }
            
            // Setup delete account button
            const deleteAccountBtn = document.getElementById('deleteAccountBtn');
            if (deleteAccountBtn) {
                deleteAccountBtn.addEventListener('click', handleDeleteAccount);
            }
            
            // Setup partner connection
            setupPartnerConnection();
            
            // Setup overview edit button
            const editOverviewBtn = document.getElementById('editOverviewBtn');
            if (editOverviewBtn) {
                editOverviewBtn.addEventListener('click', () => {
                    // Scroll to profile section and enable edit mode
                    const profileCard = document.querySelector('.card.settings-card');
                    if (profileCard) {
                        profileCard.scrollIntoView({ behavior: 'smooth' });
                        setTimeout(() => {
                            toggleEditMode('basic', true);
                        }, 500);
                    }
                });
            }
        }
        
        function toggleEditMode(section, isEditing) {
            const formInputs = document.querySelectorAll(`#${section === 'basic' ? 'updateProfileForm' : 'preferencesForm'} input, #${section === 'basic' ? 'updateProfileForm' : 'preferencesForm'} select, #${section === 'basic' ? 'updateProfileForm' : 'preferencesForm'} textarea`);
            const editBtn = document.getElementById(section === 'basic' ? 'editBasicProfileBtn' : 'editPreferencesBtn');
            const saveBtn = document.getElementById(section === 'basic' ? 'saveBasicProfileBtn' : 'savePreferencesBtn');
            const cancelBtn = document.getElementById(section === 'basic' ? 'cancelBasicProfileBtn' : 'cancelPreferencesBtn');
            
            formInputs.forEach(input => {
                input.disabled = !isEditing;
            });
            
            if (editBtn) editBtn.style.display = isEditing ? 'none' : 'inline-block';
            if (saveBtn) saveBtn.style.display = isEditing ? 'inline-block' : 'none';
            if (cancelBtn) cancelBtn.style.display = isEditing ? 'inline-block' : 'none';
        }
        
        async function loadUserSettings() {
            try {
                console.log('üîÑ Loading user settings for user:', currentUser);
                
                if (!currentUser) {
                    console.log('‚ùå No current user data available for loading settings');
                    return;
                }
                
                // Fill profile form with current user data
                const firstNameInput = document.getElementById('firstName');
                const lastNameInput = document.getElementById('lastName');
                const displayNameInput = document.getElementById('displayName');
                const nicknameInput = document.getElementById('nickname');
                const phoneInput = document.getElementById('phone');
                const bioInput = document.getElementById('bio');
                const birthDateInput = document.getElementById('birthDate');
                
                console.log('üìù Setting form values:');
                if (firstNameInput) {
                    firstNameInput.value = currentUser.firstName || '';
                    console.log('   - firstName:', currentUser.firstName);
                }
                if (lastNameInput) {
                    lastNameInput.value = currentUser.lastName || '';
                    console.log('   - lastName:', currentUser.lastName);
                }
                if (displayNameInput) {
                    displayNameInput.value = currentUser.displayName || '';
                    console.log('   - displayName:', currentUser.displayName);
                }
                if (nicknameInput) {
                    nicknameInput.value = currentUser.nickname || '';
                    console.log('   - nickname:', currentUser.nickname);
                }
                if (phoneInput) {
                    phoneInput.value = currentUser.phone || '';
                    console.log('   - phone:', currentUser.phone);
                }
                if (bioInput) {
                    bioInput.value = currentUser.bio || '';
                    console.log('   - bio:', currentUser.bio);
                }
                if (birthDateInput) {
                    birthDateInput.value = currentUser.birthDate || '';
                    console.log('   - birthDate:', currentUser.birthDate);
                }
                
                // Set gender radio buttons
                if (currentUser.gender) {
                    const genderRadio = document.getElementById(`gender${currentUser.gender.charAt(0).toUpperCase() + currentUser.gender.slice(1)}`);
                    if (genderRadio) {
                        genderRadio.checked = true;
                        console.log('   - gender:', currentUser.gender);
                    }
                }
                
                // Load user preferences
                await loadUserPreferences();
                
                // Update partner status
                updatePartnerStatus();
                
                console.log('‚úÖ User settings loaded successfully');
            } catch (error) {
                console.error('‚ùå Load settings error:', error);
                showError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤: ' + error.message);
            }
        }

        async function loadUserPreferences() {
            try {
                console.log('üîÑ Loading user preferences...');
                showLoadingStatus(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤...');
                
                const response = await nekoAPI.getUserPreferences(currentUser.id);
                
                if (response && response.success) {
                    const preferences = response.preferences || {};
                    console.log('‚úÖ Preferences loaded:', preferences);
                    
                    // Set notification preferences
                    setCheckboxValue('notificationChat', preferences.notificationChat);
                    setCheckboxValue('notificationDiary', preferences.notificationDiary);
                    setCheckboxValue('notificationPush', preferences.notificationPush);
                    setCheckboxValue('notificationEmail', preferences.notificationEmail);
                    
                    // Set privacy preferences
                    setSelectValue('diaryDefault', preferences.diaryDefault || 'private');
                    setSelectValue('profileVisibility', preferences.profileVisibility || 'private');
                    setCheckboxValue('lastSeenVisible', preferences.lastSeenVisible);
                    
                    // Set display preferences
                    setSelectValue('language', preferences.language || 'th');
                    setSelectValue('timezone', preferences.timezone || 'Asia/Bangkok');
                    
                    // Update current user preferences
                    currentUser.preferences = preferences;
                } else {
                    console.log('‚ö†Ô∏è No preferences found, using defaults');
                    setDefaultPreferences();
                }
                
                showLoadingStatus(false);
            } catch (error) {
                console.error('‚ùå Error loading preferences:', error);
                showLoadingStatus(false);
                setDefaultPreferences();
                showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏î‡πâ: ' + error.message);
            }
        }

        function setCheckboxValue(id, value) {
            const element = document.getElementById(id);
            if (element) {
                element.checked = Boolean(value);
            }
        }

        function setSelectValue(id, value) {
            const element = document.getElementById(id);
            if (element && value) {
                element.value = value;
            }
        }

        function setDefaultPreferences() {
            // Set default notification preferences
            setCheckboxValue('notificationChat', true);
            setCheckboxValue('notificationDiary', true);
            setCheckboxValue('notificationPush', false);
            setCheckboxValue('notificationEmail', false);
            
            // Set default privacy preferences
            setSelectValue('diaryDefault', 'private');
            setSelectValue('profileVisibility', 'private');
            setCheckboxValue('lastSeenVisible', true);
            
            // Set default display preferences
            setSelectValue('language', 'th');
            setSelectValue('timezone', 'Asia/Bangkok');
        }
        // Update user info in overview card
        function updateUserOverview() {
            console.log('üîÑ Updating user overview with:', currentUser);
            
            if (!currentUser) {
                console.log('‚ùå No currentUser data available');
                document.getElementById('userDisplayName').textContent = '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ';
                document.getElementById('userEmail').textContent = '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏≠‡∏µ‡πÄ‡∏°‡∏•';
                document.getElementById('userUsername').textContent = '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                return;
            }
            
            // Debug: Show all available user properties
            console.log('üîç Available user properties:', Object.keys(currentUser));
            console.log('üìä User data details:');
            console.log('   - id:', currentUser.id);
            console.log('   - username:', currentUser.username);
            console.log('   - email:', currentUser.email);
            console.log('   - firstName:', currentUser.firstName);
            console.log('   - lastName:', currentUser.lastName);
            console.log('   - displayName:', currentUser.displayName);
            
            // Main card overview
            const displayNameEl = document.getElementById('userDisplayName');
            const emailEl = document.getElementById('userEmail');
            const usernameEl = document.getElementById('userUsername');
            const joinDateEl = document.getElementById('userJoinDate');
            
            console.log('üìã Found overview elements:', { displayNameEl, emailEl, usernameEl, joinDateEl });
            
            if (displayNameEl) {
                const displayName = currentUser.displayName || 
                                  (currentUser.firstName && currentUser.lastName ? 
                                   `${currentUser.firstName} ${currentUser.lastName}` : 
                                   currentUser.firstName) || 
                                  currentUser.username || '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';
                displayNameEl.textContent = displayName;
                console.log(`‚úÖ Set displayName to: ${displayName}`);
            }
            
            if (emailEl) {
                const email = currentUser.email || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏≠‡∏µ‡πÄ‡∏°‡∏•';
                emailEl.textContent = email;
                console.log(`‚úÖ Set email to: ${email}`);
            }
            
            if (usernameEl) {
                const username = currentUser.username || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                usernameEl.textContent = username;
                console.log(`‚úÖ Set username to: ${username}`);
            }
            
            if (joinDateEl) {
                let joinDate;
                if (currentUser.created_at) {
                    joinDate = new Date(currentUser.created_at);
                } else if (currentUser.createdAt) {
                    joinDate = new Date(currentUser.createdAt);
                } else if (currentUser.dateJoined) {
                    joinDate = new Date(currentUser.dateJoined);
                } else {
                    joinDate = new Date();
                }
                
                const formattedDate = joinDate.toLocaleDateString('th-TH', {
                    year: 'numeric',
                    month: 'long', 
                    day: 'numeric'
                });
                joinDateEl.textContent = formattedDate;
                console.log(`‚úÖ Set join date to: ${formattedDate}`);
            }
            
            // Security section (current email)
            const currentEmailDisplay = document.getElementById('currentEmailDisplay');
            if (currentEmailDisplay) {
                const currentEmail = currentUser.email || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏≠‡∏µ‡πÄ‡∏°‡∏•';
                currentEmailDisplay.textContent = currentEmail;
                console.log(`‚úÖ Set current email display to: ${currentEmail}`);
            }
            
            console.log('‚úÖ User overview update completed');
        }

        // Update quick info sidebar
        function updateQuickInfo() {
            console.log('üîÑ Updating quick info sidebar with:', currentUser);
            
            if (!currentUser) {
                console.log('‚ùå No currentUser data for quick info');
                return;
            }
            
            const genderEl = document.getElementById('userGender');
            const phoneEl = document.getElementById('userPhone');
            const birthDateEl = document.getElementById('userBirthDate');
            const timezoneEl = document.getElementById('userTimezone');
            const languageEl = document.getElementById('userLanguage');
            
            console.log('üìã Found quick info elements:', { genderEl, phoneEl, birthDateEl, timezoneEl, languageEl });
            
            if (genderEl) {
                const gender = currentUser.gender ? mapGender(currentUser.gender) : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                genderEl.textContent = gender;
                console.log(`‚úÖ Set gender to: ${gender}`);
            }
            
            if (phoneEl) {
                const phone = currentUser.phone || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                phoneEl.textContent = phone;
                console.log(`‚úÖ Set phone to: ${phone}`);
            }
            
            if (birthDateEl) {
                const birthDate = currentUser.birthDate ? formatDate(currentUser.birthDate) : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                birthDateEl.textContent = birthDate;
                console.log(`‚úÖ Set birth date to: ${birthDate}`);
            }
            
            if (timezoneEl) {
                const timezone = currentUser.timezone ? mapTimezone(currentUser.timezone) : '‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏ó‡∏¢';
                timezoneEl.textContent = timezone;
                console.log(`‚úÖ Set timezone to: ${timezone}`);
            }
            
            if (languageEl) {
                const language = currentUser.language ? mapLanguage(currentUser.language) : '‡πÑ‡∏ó‡∏¢';
                languageEl.textContent = language;
                console.log(`‚úÖ Set language to: ${language}`);
            }
            
            console.log('‚úÖ Quick info update completed');
        }

        function mapGender(gender) {
            if (gender === 'male') return '‡∏ä‡∏≤‡∏¢';
            if (gender === 'female') return '‡∏´‡∏ç‡∏¥‡∏á';
            if (gender === 'other') return '‡∏≠‡∏∑‡πà‡∏ô‡πÜ';
            return '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
        }
        function mapTimezone(tz) {
            if (tz === 'Asia/Bangkok') return '‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏ó‡∏¢';
            if (tz === 'UTC') return 'UTC (GMT+0)';
            return tz;
        }
        function mapLanguage(lang) {
            if (lang === 'th') return '‡πÑ‡∏ó‡∏¢';
            if (lang === 'en') return 'English';
            return lang;
        }
        function formatDate(dateStr) {
            const d = new Date(dateStr);
            return d.toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' });
        }
        
        function updatePartnerStatus() {
            console.log('üîÑ Updating partner status...');
            
            // Update overview card partnership status
            const partnershipStatus = document.getElementById('partnershipStatus');
            if (partnershipStatus) {
                if (currentUser.partner) {
                    partnershipStatus.innerHTML = `
                        <span class="partnership-badge connected">
                            <i class="bi bi-heart-fill"></i>
                            ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö ${currentUser.partner.displayName || currentUser.partner.firstName || '‡∏Ñ‡∏π‡πà‡∏£‡∏±‡∏Å'}
                        </span>
                    `;
                } else {
                    partnershipStatus.innerHTML = `
                        <span class="partnership-badge none">
                            <i class="bi bi-heart"></i>
                            ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏π‡πà‡∏£‡∏±‡∏Å
                        </span>
                    `;
                }
            }
            
            // Update quick stats if available
            updateQuickStats();
            
            console.log('‚úÖ Partner status updated');
        }

        function updateQuickStats() {
            // Load real data from all managers
            loadRealQuickStats();
        }

        async function loadRealQuickStats() {
            try {
                console.log('üìä Loading real quick stats from API...');
                
                if (!currentUser || !currentUser.id) {
                    console.log('‚ùå No current user for stats loading');
                    return;
                }

                // Get stats from API endpoints directly
                const [diaryStats, todoStats, pomodoroStats, dashboardData] = await Promise.all([
                    nekoAPI.getDiaryStats(currentUser.id).catch(e => {
                        console.log('üìù Diary stats error:', e.message);
                        return { data: { total: 0 } };
                    }),
                    nekoAPI.getTodoStats(currentUser.id).catch(e => {
                        console.log('‚úÖ Todo stats error:', e.message);
                        return { data: { total: 0, completed: 0 } };
                    }),
                    nekoAPI.getPomodoroStats(currentUser.id).catch(e => {
                        console.log('üçÖ Pomodoro stats error:', e.message);
                        return { data: { totalSessions: 0 } };
                    }),
                    nekoAPI.getDashboardData(currentUser.id).catch(e => {
                        console.log('üìä Dashboard data error:', e.message);
                        return null;
                    })
                ]);

                console.log('üìä Stats loaded:', { diaryStats, todoStats, pomodoroStats, dashboardData });

                // Update diary count
                const statCards = document.querySelectorAll('.stat-card');
                if (statCards.length >= 3) {
                    // Update diary count
                    const diaryCard = statCards[0]?.querySelector('p');
                    if (diaryCard) {
                        const diaryCount = diaryStats?.data?.total || diaryStats?.total || 0;
                        diaryCard.textContent = `${diaryCount} ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å`;
                        console.log(`üìù Diary count: ${diaryCount}`);
                    }
                    
                    // Update message count (from chat with partner)
                    const messageCard = statCards[1]?.querySelector('p');
                    if (messageCard) {
                        let messageCount = 0;
                        if (currentUser.partner) {
                            try {
                                const messageData = await nekoAPI.getMessagesWithPartner(currentUser.id, currentUser.partner.id);
                                messageCount = messageData?.data?.length || messageData?.messages?.length || 0;
                            } catch (error) {
                                console.log('üí¨ Message count error:', error.message);
                            }
                        }
                        messageCard.textContent = `${messageCount} ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°`;
                        console.log(`üí¨ Message count: ${messageCount}`);
                    }
                    
                    // Update days together
                    const daysCard = statCards[2]?.querySelector('p');
                    if (daysCard && currentUser.partner) {
                        const connectedDate = new Date(currentUser.partner.connectedAt || currentUser.partner.createdAt || new Date());
                        const daysTogether = Math.floor((new Date() - connectedDate) / (1000 * 60 * 60 * 24));
                        daysCard.textContent = `${daysTogether} ‡∏ß‡∏±‡∏ô`;
                        console.log(`üíï Days together: ${daysTogether}`);
                    } else if (daysCard) {
                        daysCard.textContent = '- ‡∏ß‡∏±‡∏ô';
                    }
                }

                console.log('‚úÖ Quick stats updated with real data');
            } catch (error) {
                console.error('‚ùå Failed to load real quick stats:', error);
                // Fallback to placeholder data
                const statCards = document.querySelectorAll('.stat-card');
                if (statCards.length >= 3) {
                    statCards[0]?.querySelector('p') && (statCards[0].querySelector('p').textContent = '0 ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å');
                    statCards[1]?.querySelector('p') && (statCards[1].querySelector('p').textContent = '0 ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°');
                    statCards[2]?.querySelector('p') && (statCards[2].querySelector('p').textContent = '- ‡∏ß‡∏±‡∏ô');
                }
            }
        }

        // Navigation functions
        function navigateToPage(pageName) {
            console.log(`üß≠ Navigating to: ${pageName}`);
            try {
                // Check if page exists (basic validation)
                const validPages = ['chat.html', 'neko-chat.html', 'diary.html', 'todo.html', 'pomodoro.html', 'math.html', 'dashboard.html'];
                
                if (!validPages.includes(pageName)) {
                    console.warn(`‚ö†Ô∏è Invalid page: ${pageName}`);
                    showNotification('‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'warning');
                    return;
                }

                // Navigate to page
                window.location.href = pageName;
            } catch (error) {
                console.error('‚ùå Navigation error:', error);
                showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡∏ó‡∏≤‡∏á', 'error');
            }
        }

        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show position-fixed`;
            notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            notification.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

            document.body.appendChild(notification);

            // Auto remove after 3 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 3000);
        }

        async function handleUpdatePreferences(event) {
            event.preventDefault();
            
            try {
                console.log('üîÑ Updating preferences...');
                
                // Get form data
                const preferencesData = {
                    // Notification preferences
                    notificationChat: document.getElementById('notificationChat')?.checked || false,
                    notificationDiary: document.getElementById('notificationDiary')?.checked || false,
                    notificationPush: document.getElementById('notificationPush')?.checked || false,
                    notificationEmail: document.getElementById('notificationEmail')?.checked || false,
                    
                    // Privacy preferences
                    diaryDefault: document.getElementById('diaryDefault')?.value || 'private',
                    profileVisibility: document.getElementById('profileVisibility')?.value || 'private',
                    lastSeenVisible: document.getElementById('lastSeenVisible')?.checked || false,
                    
                    // Display preferences
                    language: document.getElementById('language')?.value || 'th',
                    timezone: document.getElementById('timezone')?.value || 'Asia/Bangkok'
                };
                
                console.log('üìã Preferences data:', preferencesData);
                
                const response = await nekoAPI.updatePreferences(currentUser.id, preferencesData);
                
                if (response && response.success) {
                    // Update current user preferences
                    currentUser.preferences = preferencesData;
                    nekoAPI.updateCurrentUser(currentUser);
                    
                    // Update UI
                    updateQuickInfo();
                    
                    // Exit edit mode
                    toggleEditMode('preferences', false);
                    
                    showSuccess('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
                } else {
                    throw new Error(response?.message || 'Failed to update preferences');
                }
                
            } catch (error) {
                console.error('‚ùå Update preferences error:', error);
                showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏î‡πâ: ' + error.message);
            }
        }

        async function handleUpdateProfile(event) {
            event.preventDefault();
            
            try {
                // Get form data
                const firstName = document.getElementById('firstName').value;
                const lastName = document.getElementById('lastName').value;
                const displayName = document.getElementById('displayName').value;
                const nickname = document.getElementById('nickname').value;
                const phone = document.getElementById('phone').value;
                const bio = document.getElementById('bio').value;
                const birthDate = document.getElementById('birthDate').value;
                
                // Get gender
                let gender = '';
                const genderInputs = document.querySelectorAll('input[name="gender"]');
                for (const input of genderInputs) {
                    if (input.checked) {
                        gender = input.value;
                        break;
                    }
                }
                
                const updateData = {
                    firstName,
                    lastName,
                    displayName,
                    nickname,
                    phone,
                    bio,
                    birthDate,
                    gender
                };
                
                const response = await nekoAPI.updateProfile(currentUser.id, updateData);
                
                if (response && response.success) {
                    // Update current user data
                    currentUser = {...currentUser, ...updateData};
                    nekoAPI.updateCurrentUser(currentUser);
                    
                    // Update UI
                    updateNavigationBar();
                    updateUserOverview();
                    updateQuickInfo();
                    
                    // Exit edit mode
                    toggleEditMode('basic', false);
                    
                    showSuccess('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
                } else {
                    throw new Error(response?.message || 'Failed to update profile');
                }
                
            } catch (error) {
                console.error('Update profile error:', error);
                showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡πâ: ' + error.message);
            }
        }
        
        async function handleChangePassword(event) {
            event.preventDefault();
            
            const form = event.target;
            const formData = new FormData(form);
            
            const currentPassword = formData.get('currentPassword');
            const newPassword = formData.get('newPassword');
            const confirmPassword = formData.get('confirmPassword');
            
            // Validate passwords
            if (newPassword !== confirmPassword) {
                showError('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô');
                return;
            }
            
            if (newPassword.length < 6) {
                showError('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 6 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£');
                return;
            }
            
            try {
                const passwordData = {
                    currentPassword: currentPassword,
                    newPassword: newPassword
                };
                
                const response = await nekoAPI.changePassword(currentUser.id, passwordData);
                
                if (response && response.success) {
                    // Reset form and hide it
                    form.reset();
                    document.getElementById('changePasswordForm').style.display = 'none';
                    
                    showSuccess('‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
                } else {
                    throw new Error(response?.message || 'Failed to change password');
                }
                
            } catch (error) {
                console.error('Change password error:', error);
                showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ: ' + error.message);
            }
        }

        async function handleChangeEmail(event) {
            event.preventDefault();
            
            const form = event.target;
            const formData = new FormData(form);
            
            const newEmail = formData.get('newEmail');
            const currentPassword = formData.get('currentPasswordEmail');
            
            // Validate email
            if (!newEmail || !isValidEmail(newEmail)) {
                showError('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
                return;
            }
            
            if (!currentPassword) {
                showError('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô');
                return;
            }
            
            try {
                const emailData = {
                    newEmail: newEmail,
                    currentPassword: currentPassword
                };
                
                const response = await nekoAPI.changeEmail(currentUser.id, emailData);
                
                if (response && response.success) {
                    // Update current user email
                    currentUser.email = newEmail;
                    nekoAPI.updateCurrentUser(currentUser);
                    
                    // Update UI
                    updateUserOverview();
                    
                    // Reset form and hide it
                    form.reset();
                    document.getElementById('changeEmailForm').style.display = 'none';
                    
                    showSuccess('‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
                } else {
                    throw new Error(response?.message || 'Failed to change email');
                }
                
            } catch (error) {
                console.error('Change email error:', error);
                showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÑ‡∏î‡πâ: ' + error.message);
            }
        }

        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        function updatePasswordStrength() {
            const password = document.getElementById('newPassword').value;
            const strengthBar = document.getElementById('passwordStrengthBar');
            const strengthText = document.getElementById('passwordStrengthText');
            
            if (!password) {
                strengthBar.style.width = '0%';
                strengthBar.className = 'progress-bar';
                strengthText.textContent = '‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏Å‡∏£‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô';
                return;
            }
            
            let strength = 0;
            let strengthLabel = '';
            let strengthClass = '';
            
            // Check password criteria
            if (password.length >= 8) strength++;
            if (/[a-z]/.test(password)) strength++;
            if (/[A-Z]/.test(password)) strength++;
            if (/[0-9]/.test(password)) strength++;
            if (/[^A-Za-z0-9]/.test(password)) strength++;
            
            // Set strength level
            switch (strength) {
                case 0:
                case 1:
                    strengthLabel = '‡∏≠‡πà‡∏≠‡∏ô‡∏°‡∏≤‡∏Å';
                    strengthClass = 'bg-danger';
                    break;
                case 2:
                    strengthLabel = '‡∏≠‡πà‡∏≠‡∏ô';
                    strengthClass = 'bg-warning';
                    break;
                case 3:
                    strengthLabel = '‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á';
                    strengthClass = 'bg-info';
                    break;
                case 4:
                    strengthLabel = '‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏Å‡∏£‡πà‡∏á';
                    strengthClass = 'bg-success';
                    break;
                case 5:
                    strengthLabel = '‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏Å‡∏£‡πà‡∏á‡∏°‡∏≤‡∏Å';
                    strengthClass = 'bg-success';
                    break;
            }
            
            const percentage = (strength / 5) * 100;
            strengthBar.style.width = `${percentage}%`;
            strengthBar.className = `progress-bar ${strengthClass}`;
            strengthText.textContent = `‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏Å‡∏£‡πà‡∏á: ${strengthLabel}`;
        }
        
        function setupPartnerConnection() {
            // Setup connect partner button in sidebar
            const partnerInfo = document.getElementById('partnerInfo');
            if (partnerInfo && !currentUser.partner) {
                partnerInfo.innerHTML = `
                    <i class="bi bi-heart-break display-6 text-muted mb-3"></i>
                    <p class="text-muted mb-3">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏π‡πà‡∏£‡∏±‡∏Å</p>
                    <div id="partnerConnectForm">
                        <div class="mb-3">
                            <input type="text" class="form-control" id="partnerCodeInput" placeholder="‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏π‡πà‡∏£‡∏±‡∏Å" maxlength="8">
                        </div>
                        <button class="btn btn-primary btn-sm" onclick="handleConnectPartner()">
                            <i class="bi bi-plus me-1"></i>‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏£‡∏±‡∏Å
                        </button>
                    </div>
                `;
            }
            
            // If user has partner, show disconnect option
            if (currentUser.partner) {
                updatePartnerInfo();
            }
        }

        function updatePartnerInfo() {
            const partnerInfo = document.getElementById('partnerInfo');
            if (partnerInfo && currentUser.partner) {
                partnerInfo.innerHTML = `
                    <div class="text-center">
                        <i class="bi bi-heart-fill display-6 text-danger mb-3"></i>
                        <h6 class="mb-2">${currentUser.partner.displayName || currentUser.partner.firstName || '‡∏Ñ‡∏π‡πà‡∏£‡∏±‡∏Å'}</h6>
                        <p class="text-muted small mb-3">@${currentUser.partner.username}</p>
                        <p class="text-muted small mb-3">‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${formatDate(currentUser.partner.connectedAt || new Date())}</p>
                        <button class="btn btn-outline-danger btn-sm" onclick="handleDisconnectPartner()">
                            <i class="bi bi-heart-break me-1"></i>‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠
                        </button>
                    </div>
                `;
            }
        }

        async function handleConnectPartner() {
            const partnerCodeInput = document.getElementById('partnerCodeInput');
            const partnerCode = partnerCodeInput?.value?.trim();
            
            if (!partnerCode) {
                showError('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏π‡πà‡∏£‡∏±‡∏Å');
                return;
            }
            
            if (partnerCode.length !== 8) {
                showError('‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏π‡πà‡∏£‡∏±‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ 8 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£');
                return;
            }
            
            try {
                console.log('üîÑ Connecting to partner with code:', partnerCode);
                
                const response = await nekoAPI.connectPartner(currentUser.id, partnerCode);
                
                if (response && response.success) {
                    // Update current user data
                    currentUser.partner = response.partner;
                    nekoAPI.updateCurrentUser(currentUser);
                    
                    // Update UI
                    updatePartnerInfo();
                    updatePartnerStatus();
                    
                    showSuccess('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏£‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
                } else {
                    throw new Error(response?.message || 'Failed to connect partner');
                }
                
            } catch (error) {
                console.error('Connect partner error:', error);
                showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏£‡∏±‡∏Å‡πÑ‡∏î‡πâ: ' + error.message);
            }
        }

        async function handleDisconnectPartner() {
            if (!confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏£‡∏±‡∏Å‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏™‡πà‡∏á‡∏ú‡∏•‡∏Å‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏£‡∏±‡∏Å‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏î‡πâ‡∏ß‡∏¢')) {
                return;
            }
            
            try {
                console.log('üîÑ Disconnecting from partner...');
                
                const response = await nekoAPI.disconnectPartner(currentUser.id);
                
                if (response && response.success) {
                    // Update current user data
                    currentUser.partner = null;
                    nekoAPI.updateCurrentUser(currentUser);
                    
                    // Update UI
                    setupPartnerConnection();
                    updatePartnerStatus();
                    
                    showSuccess('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏£‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
                } else {
                    throw new Error(response?.message || 'Failed to disconnect partner');
                }
                
            } catch (error) {
                console.error('Disconnect partner error:', error);
                showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ: ' + error.message);
            }
        }
        
        async function handleDeleteAccount() {
            const confirmation = prompt('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå "‡∏•‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ');
            
            if (confirmation !== '‡∏•‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ') {
                showError('‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
                return;
            }
            
            if (!confirm('‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ? ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ')) return;
            
            try {
                await nekoAPI.deleteAccount(currentUser.id);
                
                // Logout and redirect
                nekoAPI.logout();
                
            } catch (error) {
                console.error('Delete account error:', error);
                showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÑ‡∏î‡πâ');
            }
        }
        
        // Navigation functions
        function goBack() {
            window.location.href = 'dashboard.html';
        }
        
        function handleLogout() {
            nekoAPI.logout();
        }
        
        // Add missing navigation bar update
        function updateNavigationBar() {
            const userNameNav = document.getElementById('userName');
            if (userNameNav && currentUser) {
                userNameNav.textContent = currentUser.displayName || currentUser.username || '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ';
            }
        }
        
        // Toggle form visibility functions (for backwards compatibility with HTML onclick)
        function toggleEmailFormVisibility() {
            const form = document.getElementById('changeEmailForm');
            if (form) form.style.display = form.style.display === 'none' ? 'block' : 'none';
        }
        
        function togglePasswordFormVisibility() {
            const form = document.getElementById('changePasswordForm');
            if (form) form.style.display = form.style.display === 'none' ? 'block' : 'none';
        }
    </script>
</body>
</html>
